<?php

namespace App\Http\Controllers\Finance;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Redirect;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Input;
Use Cookie;
use DataTables;
use SAPNWRFC\Connection as SapConnection;
use SAPNWRFC\Exception as SapException;
use SAPNWRFC\FunctionCallException as SAPFunctionException;
use Illuminate\Http\Response;
use App\Http\Controllers\Traits\IntranetTrait;
use App\Imports\HeadcountImport;
use Maatwebsite\Excel\Facades\Excel;
use App\Exports\DailyFlashCost;
use App\Exports\PNLExport;
use Mail;
use Log;

class PNL extends Controller{
    use IntranetTrait;
    private $pnl_period_exclude_month = array(
        "13"=>'Period 13', 
        "14"=>'Period 14', 
        "15"=>'Period 15', 
        "16"=>'Period 16'
    );

    public function headcount_process($collection_data, $report_type='', $month=null, $year=null){
        $collection_data['HEADCOUNT'] = [];
        if($month && $year){
            $collection_data['HEADCOUNT'] = DB::connection('dbayana-stg')
            ->select("EXEC dbo.sap_pnl_headcount ?,?,?", array($report_type, $month, $year));
            if(count($collection_data))
                $collection_data['HEADCOUNT'] = $collection_data['HEADCOUNT'][0];
        }
        return $collection_data;
    }

    public function grouping_GL_FNB_process($collection_data, $report_type){
        $report_type = $report_type ? $report_type : '';
        $collection_data['GROUPING_GL'] = [];
        $collection_data['SHOW_GROUP_AFTER_CAT'] = [];

        try {
            $cek_grouping_GL = DB::connection('dbayana-stg')
            ->table('dbo.PnlGroupTotalGL')
            ->where('REPORT_CODE', $report_type)
            ->select('SAP_COA')
            ->get();
            $GL_group = $cek_grouping_GL->pluck('SAP_COA', 'SAP_COA')->toArray();

            $collection_data[$report_type] = collect($collection_data[$report_type])->mapWithKeys(function($item, $keyCategory) use (&$collection_data, $GL_group, $report_type){

                $new_item_category = collect($item['DATA_CATEGORY'])->reject(function($item, $key) use (&$collection_data, $GL_group, $keyCategory, $report_type){
                    if($item->GROUPING_YN){
                        if(in_array($item->GROUPING_YN, array_values($collection_data['SHOW_GROUP_AFTER_CAT']) )){
                            $key = array_search ($item->GROUPING_YN, $collection_data['SHOW_GROUP_AFTER_CAT']);
                            unset($collection_data['SHOW_GROUP_AFTER_CAT'][$key]);
                            $collection_data['SHOW_GROUP_AFTER_CAT'][$keyCategory] = $item->GROUPING_YN;
                        } else {
                            $collection_data['SHOW_GROUP_AFTER_CAT'][$keyCategory] = $item->GROUPING_YN;
                        }
                    }

                    // Jika COA termasuk dalam grouping GL
                    if(in_array($item->SAP_COA, $GL_group)){
                        if(isset($collection_data['GROUPING'][$report_type][$item->GROUPING_YN])){
                            if(in_array($item->GROUPING_YN, array_values($collection_data['SHOW_GROUP_AFTER_CAT']) )){
                                $key = array_search ($item->GROUPING_YN, $collection_data['SHOW_GROUP_AFTER_CAT']);
                                unset($collection_data['SHOW_GROUP_AFTER_CAT'][$key]);
                                $collection_data['SHOW_GROUP_AFTER_CAT'][$keyCategory] = $item->GROUPING_YN;
                            } else {
                                $collection_data['SHOW_GROUP_AFTER_CAT'][$keyCategory] = $item->GROUPING_YN;
                            }
                        }
                        $collection_data['GROUPING_GL'][$keyCategory][] = $item;
                    }
                    return in_array($item->SAP_COA, $GL_group);
                })->values()->all();

                if(isset($collection_data['GROUPING_GL'][$keyCategory])){
                    $collection_data['GROUPING_GL'][$keyCategory] = collect($collection_data['GROUPING_GL'][$keyCategory])->sortBy('SAP_COA')->groupBy(['GROUPING_ROW_PARENT', 'GROUPING_ROW'])->mapWithKeys(function($item, $key) use ($keyCategory, $collection_data, $report_type){
                        $desc = isset($item->values()->all()[0][0]->GROUPING_ROW_PARENT_DESC) ? $item->values()->all()[0][0]->GROUPING_ROW_PARENT_DESC : '-';
                        // SUM MTD
                        $SUMMARY_ALL['ACTUAL_CURRENT'] = 0;
                        $SUMMARY_ALL['LAST_MONTH_CURRENT'] = 0;
                        $SUMMARY_ALL['VARIANCE_CURRENT'] = 0;
                        $SUMMARY_ALL['LAST_YEAR_CURRENT'] = 0;
                        // SUM YTD
                        $SUMMARY_ALL['ACTUAL_YTD'] = 0;
                        $SUMMARY_ALL['LAST_MONTH_YTD'] = 0;
                        $SUMMARY_ALL['VARIANCE_YTD'] = 0;
                        $SUMMARY_ALL['LAST_YEAR_YTD'] = 0;

                        $new_item = collect($item)->mapWithKeys(function($item, $key) use (&$SUMMARY_ALL, $keyCategory, $collection_data, $report_type){
                            $desc = isset($item[0]->GROUPING_ROW_DESC) ? $item[0]->GROUPING_ROW_DESC : '-';
                            // MTD
                            $actual_current_sum = $item->sum('ACTUAL_CURRENT_PERIOD');
                            $last_month_current_sum = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                            $variance_current_sum = $item->sum('VARIANCE_CURRENT_PERIOD');
                            $last_year_current_sum = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                            // YTD
                            $actual_ytd_sum = $item->sum('ACTUAL_YTD');
                            $last_month_ytd_sum = $item->sum('LAST_MONTH_YTD');
                            $variance_ytd_sum = $item->sum('VARIANCE_YTD');
                            $last_year_ytd_sum = $item->sum('LAST_YEAR_YTD');

                            // SUM MTD
                            $SUMMARY_ALL['ACTUAL_CURRENT'] += $actual_current_sum;
                            $SUMMARY_ALL['LAST_MONTH_CURRENT'] += $last_month_current_sum;
                            $SUMMARY_ALL['VARIANCE_CURRENT'] += $variance_current_sum;
                            $SUMMARY_ALL['LAST_YEAR_CURRENT'] += $last_year_current_sum;
                            // SUM YTD
                            $SUMMARY_ALL['ACTUAL_YTD'] += $actual_ytd_sum;
                            $SUMMARY_ALL['LAST_MONTH_YTD'] += $last_month_current_sum;
                            $SUMMARY_ALL['VARIANCE_YTD'] += $variance_current_sum;
                            $SUMMARY_ALL['LAST_YEAR_YTD'] += $last_year_current_sum;

                            $SUM = [
                                // MTD
                                'ACTUAL_CURRENT'=>$actual_current_sum,
                                'LAST_MONTH_CURRENT'=>$last_month_current_sum,
                                'VARIANCE_CURRENT'=>$variance_current_sum,
                                'LAST_YEAR_CURRENT'=>$last_year_current_sum,
                                // YTD
                                'ACTUAL_YTD'=>$actual_ytd_sum,
                                'LAST_MONTH_YTD'=>$last_month_ytd_sum,
                                'VARIANCE_YTD'=>$variance_ytd_sum,
                                'LAST_YEAR_YTD'=>$last_year_ytd_sum
                            ];

                            if($keyCategory == 'BVR'){
                                if(isset($collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT'])) {
                                    // SUM MTD
                                    $SUM['ACTUAL_CURRENT_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($SUM['ACTUAL_CURRENT'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
                                    $SUM['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($SUM['LAST_MONTH_CURRENT'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $SUM['VARIANCE_CURRENT_PCTG'] = isset($SUM['LAST_MONTH_CURRENT']) && $SUM['LAST_MONTH_CURRENT'] != 0 ? ($SUM['VARIANCE_CURRENT'] / $SUM['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $SUM['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($SUM['LAST_YEAR_CURRENT'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

                                    // SUM YTD
                                    $SUM['ACTUAL_YTD_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_YTD']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_YTD'] != 0 ? ($SUM['ACTUAL_YTD'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
                                    $SUM['LAST_MONTH_YTD_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_YTD']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($SUM['LAST_MONTH_YTD'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
                                    $SUM['VARIANCE_YTD_PCTG'] = isset($SUM['LAST_MONTH_YTD']) && $SUM['LAST_MONTH_YTD'] != 0 ? ($SUM['VARIANCE_YTD'] / $SUM['LAST_MONTH_YTD']) * 100 : 0;
                                    $SUM['LAST_YEAR_YTD_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_YTD']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($SUM['LAST_YEAR_YTD'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;
                                } else {
                                    // SUM MTD
                                    $SUM['ACTUAL_CURRENT_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($SUM['ACTUAL_CURRENT'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
                                    $SUM['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($SUM['LAST_MONTH_CURRENT'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $SUM['VARIANCE_CURRENT_PCTG'] = isset($SUM['LAST_MONTH_CURRENT']) && $SUM['LAST_MONTH_CURRENT'] != 0 ? ($SUM['VARIANCE_CURRENT'] / $SUM['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $SUM['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($SUM['LAST_YEAR_CURRENT'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

                                    // SUM YTD
                                    $SUM['ACTUAL_YTD_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($SUM['ACTUAL_YTD'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
                                    $SUM['LAST_MONTH_YTD_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($SUM['LAST_MONTH_YTD'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
                                    $SUM['VARIANCE_YTD_PCTG'] = isset($SUM['LAST_MONTH_YTD']) && $SUM['LAST_MONTH_YTD'] != 0 ? ($SUM['VARIANCE_YTD'] / $SUM['LAST_MONTH_YTD']) * 100 : 0;
                                    $SUM['LAST_YEAR_YTD_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($SUM['LAST_YEAR_YTD'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
                                }
                            } else if($keyCategory == 'COS') {
                                $SUM['ACTUAL_CURRENT_PCTG'] = isset($collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['ACTUAL_CURRENT']) && $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['ACTUAL_CURRENT'] != 0 ? ($SUM['ACTUAL_CURRENT'] / $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['ACTUAL_CURRENT']) * 100 : 0;
                                $SUM['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_MONTH_CURRENT'] != 0 ? ($SUM['LAST_MONTH_CURRENT'] / $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_MONTH_CURRENT']) * 100 : 0;
                                $SUM['VARIANCE_CURRENT_PCTG'] = isset($SUM['LAST_MONTH_CURRENT']) && $SUM['LAST_MONTH_CURRENT'] != 0 ? ($SUM['VARIANCE_CURRENT'] / $SUM['LAST_MONTH_CURRENT']) * 100 : 0;
                                $SUM['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_YEAR_CURRENT'] != 0 ? ($SUM['LAST_YEAR_CURRENT'] / $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_YEAR_CURRENT']) * 100 : 0;

                                // SUM YTD
                                $SUM['ACTUAL_YTD_PCTG'] = isset($collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['ACTUAL_YTD']) && $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['ACTUAL_YTD'] != 0 ? ($SUM['ACTUAL_YTD'] / $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['ACTUAL_YTD']) * 100 : 0;
                                $SUM['LAST_MONTH_YTD_PCTG'] = isset($collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_MONTH_YTD']) && $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_MONTH_YTD'] != 0 ? ($SUM['LAST_MONTH_YTD'] / $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_MONTH_YTD']) * 100 : 0;
                                $SUM['VARIANCE_YTD_PCTG'] = isset($SUM['LAST_MONTH_YTD']) && $SUM['LAST_MONTH_YTD'] != 0 ? ($SUM['VARIANCE_YTD'] / $SUM['LAST_MONTH_YTD']) * 100 : 0;
                                $SUM['LAST_YEAR_YTD_PCTG'] = isset($collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_YEAR_YTD']) && $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_YEAR_YTD'] != 0 ? ($SUM['LAST_YEAR_YTD'] / $collection_data['GROUPING_GL']['BVR'][$item[0]->DIVIDE_GROUP_CODE]['DATA_GROUP'][$item[0]->DIVIDE_ROW_GROUP]['SUMMARY']['LAST_YEAR_YTD']) * 100 : 0;
                            }

                            return [$key=>array('DESC'=>$desc,'SUMMARY'=>$SUM, 'DATA'=>$item->toArray())];
                        })->toArray();

                        if($keyCategory == 'BVR'){
                            if(isset($collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT'])) {
                                // SUM MTD
                                $SUMMARY_ALL['ACTUAL_CURRENT_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($SUMMARY_ALL['ACTUAL_CURRENT'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
                                $SUMMARY_ALL['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($SUMMARY_ALL['LAST_MONTH_CURRENT'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
                                $SUMMARY_ALL['VARIANCE_CURRENT_PCTG'] = isset($SUMMARY_ALL['LAST_MONTH_CURRENT']) && $SUMMARY_ALL['LAST_MONTH_CURRENT'] != 0 ? ($SUMMARY_ALL['VARIANCE_CURRENT'] / $SUMMARY_ALL['LAST_MONTH_CURRENT']) * 100 : 0;
                                $SUMMARY_ALL['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($SUMMARY_ALL['LAST_YEAR_CURRENT'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

                                // SUM YTD
                                $SUMMARY_ALL['ACTUAL_YTD_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_YTD']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_YTD'] != 0 ? ($SUMMARY_ALL['ACTUAL_YTD'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
                                $SUMMARY_ALL['LAST_MONTH_YTD_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_YTD']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($SUMMARY_ALL['LAST_MONTH_YTD'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
                                $SUMMARY_ALL['VARIANCE_YTD_PCTG'] = isset($SUMMARY_ALL['LAST_MONTH_YTD']) && $SUMMARY_ALL['LAST_MONTH_YTD'] != 0 ? ($SUMMARY_ALL['VARIANCE_YTD'] / $SUMMARY_ALL['LAST_MONTH_YTD']) * 100 : 0;
                                $SUMMARY_ALL['LAST_YEAR_YTD_PCTG'] = isset($collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_YTD']) && $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($SUMMARY_ALL['LAST_YEAR_YTD'] / $collection_data['GROUPING'][$report_type]['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;
                            } else {
                                // SUM MTD
                                $SUMMARY_ALL['ACTUAL_CURRENT_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($SUMMARY_ALL['ACTUAL_CURRENT'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
                                $SUMMARY_ALL['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($SUMMARY_ALL['LAST_MONTH_CURRENT'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
                                $SUMMARY_ALL['VARIANCE_CURRENT_PCTG'] = isset($SUMMARY_ALL['LAST_MONTH_CURRENT']) && $SUMMARY_ALL['LAST_MONTH_CURRENT'] != 0 ? ($SUMMARY_ALL['VARIANCE_CURRENT'] / $SUMMARY_ALL['LAST_MONTH_CURRENT']) * 100 : 0;
                                $SUMMARY_ALL['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($SUMMARY_ALL['LAST_YEAR_CURRENT'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

                                // SUM YTD
                                $SUMMARY_ALL['ACTUAL_YTD_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($SUMMARY_ALL['ACTUAL_YTD'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
                                $SUMMARY_ALL['LAST_MONTH_YTD_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($SUMMARY_ALL['LAST_MONTH_YTD'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
                                $SUMMARY_ALL['VARIANCE_YTD_PCTG'] = isset($SUMMARY_ALL['LAST_MONTH_YTD']) && $SUMMARY_ALL['LAST_MONTH_YTD'] != 0 ? ($SUMMARY_ALL['VARIANCE_YTD'] / $SUMMARY_ALL['LAST_MONTH_YTD']) * 100 : 0;
                                $SUMMARY_ALL['LAST_YEAR_YTD_PCTG'] = isset($collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($SUMMARY_ALL['LAST_YEAR_YTD'] / $collection_data[$report_type]['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
                            }
                        } else if($keyCategory == 'COS') {
                            $SUMMARY_ALL['ACTUAL_CURRENT_PCTG'] = isset($collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['ACTUAL_CURRENT']) && $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['ACTUAL_CURRENT'] != 0 ? ($SUMMARY_ALL['ACTUAL_CURRENT'] / $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['ACTUAL_CURRENT']) * 100 : 0;
                            $SUMMARY_ALL['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_MONTH_CURRENT'] != 0 ? ($SUMMARY_ALL['LAST_MONTH_CURRENT'] / $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_MONTH_CURRENT']) * 100 : 0;
                            $SUMMARY_ALL['VARIANCE_CURRENT_PCTG'] = isset($SUMMARY_ALL['LAST_MONTH_CURRENT']) && $SUMMARY_ALL['LAST_MONTH_CURRENT'] != 0 ? ($SUMMARY_ALL['VARIANCE_CURRENT'] / $SUMMARY_ALL['LAST_MONTH_CURRENT']) * 100 : 0;
                            $SUMMARY_ALL['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_YEAR_CURRENT'] != 0 ? ($SUMMARY_ALL['LAST_YEAR_CURRENT'] / $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_YEAR_CURRENT']) * 100 : 0;

                            // SUM YTD
                            $SUMMARY_ALL['ACTUAL_YTD_PCTG'] = isset($collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['ACTUAL_YTD']) && $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['ACTUAL_YTD'] != 0 ? ($SUMMARY_ALL['ACTUAL_YTD'] / $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['ACTUAL_YTD']) * 100 : 0;
                            $SUMMARY_ALL['LAST_MONTH_YTD_PCTG'] = isset($collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_MONTH_YTD']) && $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_MONTH_YTD'] != 0 ? ($SUMMARY_ALL['LAST_MONTH_YTD'] / $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_MONTH_YTD']) * 100 : 0;
                            $SUMMARY_ALL['VARIANCE_YTD_PCTG'] = isset($SUMMARY_ALL['LAST_MONTH_YTD']) && $SUMMARY_ALL['LAST_MONTH_YTD'] != 0 ? ($SUMMARY_ALL['VARIANCE_YTD'] / $SUMMARY_ALL['LAST_MONTH_YTD']) * 100 : 0;
                            $SUMMARY_ALL['LAST_YEAR_YTD_PCTG'] = isset($collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_YEAR_YTD']) && $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_YEAR_YTD'] != 0 ? ($SUMMARY_ALL['LAST_YEAR_YTD'] / $collection_data['GROUPING_GL']['BVR']['BVR_REV']['SUMMARY_ALL']['LAST_YEAR_YTD']) * 100 : 0;
                        }

                        return [$key=>array('DESC'=>$desc ,'SUMMARY_ALL'=>$SUMMARY_ALL,'DATA_GROUP'=>$new_item)];
                    })->toArray();
                    // dd($collection_data['GROUPING_GL']);
                }

                return [$keyCategory=>['DATA_CATEGORY'=>$new_item_category, 'SUM_CATEGORY'=>$item['SUM_CATEGORY']]];
            })->toArray();
        } catch(\Exception $e){
            // dd($e);
        }

        return $collection_data;
    }

    public function lm_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use (&$grouping_arj){
                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);
                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();

            // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
            $grouping_data = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
                $item_to_count = $item->reject(function($groupingitem){
                    return $groupingitem->GROUPING_ROW_PARENT;
                })->values()->all();
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
                return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item_to_count)))];
            })->toArray();

            $collection_data = collect($collection_data)->mapWithKeys(function($item, $key) use ($collection_data, $grouping_data){
                // dd($collection_data);
                // INI loop untuk total PCTG masing" ITEM
                $each_item = isset($item['DATA_CATEGORY']) ? $item['DATA_CATEGORY'] : [];
                $each_item_summary = isset($item['SUM_CATEGORY']) ? $item['SUM_CATEGORY'] : [];
                $type_revenue = null;

                $each_data = collect($each_item)->map(function($item, $key) use ($grouping_data, &$type_revenue){
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue != 'COS'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        // GROUPING B UNTUK TOTAL REVENUE FNB
                        if(isset($grouping_data['B']['DATA']['ACTUAL_CURRENT']) && $grouping_data['B']['DATA']['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $grouping_data['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) && $grouping_data['B']['DATA']['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
                        if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) && $grouping_data['B']['DATA']['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if(isset($grouping_data['B']['DATA']['ACTUAL_YTD']) && $grouping_data['B']['DATA']['ACTUAL_YTD'] !=  0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $grouping_data['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_MONTH_YTD']) && $grouping_data['B']['DATA']['LAST_MONTH_YTD'] !=  0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $grouping_data['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
                        if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_YEAR_YTD']) && $grouping_data['B']['DATA']['LAST_YEAR_YTD'] !=  0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $grouping_data['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    return $item;
                });

                if($type_revenue != 'COS'){
                    if(isset($grouping_data['B']['DATA']['ACTUAL_CURRENT']) && $grouping_data['B']['DATA']['ACTUAL_CURRENT'] != 0)
                        $each_item_summary['ACTUAL_CURRENT_PCTG'] = ($each_item_summary['ACTUAL_CURRENT'] / $grouping_data['B']['DATA']['ACTUAL_CURRENT']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) && $grouping_data['B']['DATA']['LAST_MONTH_CURRENT'] != 0)
                        $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = ($each_item_summary['LAST_MONTH_CURRENT'] / $grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) * 100;
                    if(isset($each_item_summary['LAST_MONTH_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                        $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) && $grouping_data['B']['DATA']['LAST_YEAR_CURRENT'] != 0)
                        $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = ($each_item_summary['LAST_YEAR_CURRENT'] / $grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) * 100;

                    if(isset($grouping_data['B']['DATA']['ACTUAL_YTD']) && $grouping_data['B']['DATA']['ACTUAL_YTD'] != 0)
                        $each_item_summary['ACTUAL_YTD_PCTG'] = ($each_item_summary['ACTUAL_YTD'] / $grouping_data['B']['DATA']['ACTUAL_YTD']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_MONTH_YTD']) && $grouping_data['B']['DATA']['LAST_MONTH_YTD'] != 0)
                        $each_item_summary['LAST_MONTH_YTD_PCTG'] = ($each_item_summary['LAST_MONTH_YTD'] / $grouping_data['B']['DATA']['LAST_MONTH_YTD']) * 100;
                    if(isset($each_item_summary['LAST_MONTH_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                        $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_YEAR_YTD']) && $grouping_data['B']['DATA']['LAST_YEAR_YTD'] != 0)
                        $each_item_summary['LAST_YEAR_YTD_PCTG'] = ($each_item_summary['LAST_YEAR_YTD'] / $grouping_data['B']['DATA']['LAST_YEAR_YTD']) * 100;
                }

                $type_revenue = null;
                return [$key=>array("DATA_CATEGORY"=>$each_item, "SUM_CATEGORY"=>$each_item_summary)];
            })->toArray();
        }


        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data, $grouping_data){
                // dd($collection_data['FDR']['SUM_CATEGORY'], $item);
                // Menentukan Cost of sales pctg dari other revenue dengan kategori yg sama
                $food_revenue_total = array(
                    // MTD
                    "NAME"=>"FOOD_REVENUE_TOTAL",
                    "ACTUAL_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0,
                    "LAST_MONTH_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0,
                    "LAST_YEAR_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0,

                    // YTD
                    "ACTUAL_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD'] : 0,
                    "LAST_MONTH_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0,
                    "LAST_YEAR_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0
                );

                $beverage_revenue_total = array(
                    // MTD
                    "NAME"=>"BEVERAGE_REVENUE_TOTAL",
                    "ACTUAL_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0,
                    "LAST_MONTH_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0,
                    "LAST_YEAR_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0,

                    // YTD
                    "ACTUAL_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD'] : 0,
                    "LAST_MONTH_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0,
                    "LAST_YEAR_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0
                );

                // Liquor
                $liquor_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122020100';
                })->first();
                // MTD
                $liquor['NAME'] = 'LIQUOR REVENUE';
                $liquor['ACTUAL_CURRENT'] = isset($liquor_data->ACTUAL_CURRENT_PERIOD) ? $liquor_data->ACTUAL_CURRENT_PERIOD : 0;
                $liquor['LAST_MONTH_CURRENT'] = isset($liquor_data->LAST_MONTH_CURRENT_PERIOD) ? $liquor_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $liquor['LAST_YEAR_CURRENT'] = isset($liquor_data->LAST_YEAR_CURRENT_PERIOD) ? $liquor_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $liquor['ACTUAL_YTD'] = isset($liquor_data->ACTUAL_YTD) ? $liquor_data->ACTUAL_YTD : 0;
                $liquor['LAST_MONTH_YTD'] = isset($liquor_data->LAST_MONTH_YTD) ? $liquor_data->LAST_MONTH_YTD : 0;
                $liquor['LAST_YEAR_YTD'] = isset($liquor_data->LAST_YEAR_YTD) ? $liquor_data->LAST_YEAR_YTD : 0;

                // WINE
                $wine_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122030100';
                })->first();
                // MTD
                $wine['NAME'] = 'WINE REVENUE';
                $wine['ACTUAL_CURRENT'] = isset($wine_data->ACTUAL_CURRENT_PERIOD) ? $wine_data->ACTUAL_CURRENT_PERIOD : 0;
                $wine['LAST_MONTH_CURRENT'] = isset($wine_data->LAST_MONTH_CURRENT_PERIOD) ? $wine_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $wine['LAST_YEAR_CURRENT'] = isset($wine_data->LAST_YEAR_CURRENT_PERIOD) ? $wine_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $wine['ACTUAL_YTD'] = isset($wine_data->ACTUAL_YTD) ? $wine_data->ACTUAL_YTD : 0;
                $wine['LAST_MONTH_YTD'] = isset($wine_data->LAST_MONTH_YTD) ? $wine_data->LAST_MONTH_YTD : 0;
                $wine['LAST_YEAR_YTD'] = isset($wine_data->LAST_YEAR_YTD) ? $wine_data->LAST_YEAR_YTD : 0;

                // BEER
                $beer_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122010100';
                })->first();
                // MTD
                $wine['BEER'] = 'BEER REVENUE';
                $beer['ACTUAL_CURRENT'] = isset($beer_data->ACTUAL_CURRENT_PERIOD) ? $beer_data->ACTUAL_CURRENT_PERIOD : 0;
                $beer['LAST_MONTH_CURRENT'] = isset($beer_data->LAST_MONTH_CURRENT_PERIOD) ? $beer_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $beer['LAST_YEAR_CURRENT'] = isset($beer_data->LAST_YEAR_CURRENT_PERIOD) ? $beer_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $beer['ACTUAL_YTD'] = isset($beer_data->ACTUAL_YTD) ? $beer_data->ACTUAL_YTD : 0;
                $beer['LAST_MONTH_YTD'] = isset($beer_data->LAST_MONTH_YTD) ? $beer_data->LAST_MONTH_YTD : 0;
                $beer['LAST_YEAR_YTD'] = isset($beer_data->LAST_YEAR_YTD) ? $beer_data->LAST_YEAR_YTD : 0;

                // AUDIO VISUAL
                $audio_visual_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129020000';
                })->first();
                // MTD
                $audio_visual['NAME'] = 'AUDIO VISUAL REVENUE';
                $audio_visual['ACTUAL_CURRENT'] = isset($audio_visual_data->ACTUAL_CURRENT_PERIOD) ? $audio_visual_data->ACTUAL_CURRENT_PERIOD : 0;
                $audio_visual['LAST_MONTH_CURRENT'] = isset($audio_visual_data->LAST_MONTH_CURRENT_PERIOD) ? $audio_visual_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $audio_visual['LAST_YEAR_CURRENT'] = isset($audio_visual_data->LAST_YEAR_CURRENT_PERIOD) ? $audio_visual_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $audio_visual['ACTUAL_YTD'] = isset($audio_visual_data->ACTUAL_YTD) ? $audio_visual_data->ACTUAL_YTD : 0;
                $audio_visual['LAST_MONTH_YTD'] = isset($audio_visual_data->LAST_MONTH_YTD) ? $audio_visual_data->LAST_MONTH_YTD : 0;
                $audio_visual['LAST_YEAR_YTD'] = isset($audio_visual_data->LAST_YEAR_YTD) ? $audio_visual_data->LAST_YEAR_YTD : 0;

                // DECOR CEREMONY
                $decor_ceremony_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129030000';
                })->first();
                // MTD
                $decor_ceremony['NAME'] = 'DECOR CEREMONY REVENUE';
                $decor_ceremony['ACTUAL_CURRENT'] = isset($decor_ceremony_data->ACTUAL_CURRENT_PERIOD) ? $decor_ceremony_data->ACTUAL_CURRENT_PERIOD : 0;
                $decor_ceremony['LAST_MONTH_CURRENT'] = isset($decor_ceremony_data->LAST_MONTH_CURRENT_PERIOD) ? $decor_ceremony_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $decor_ceremony['LAST_YEAR_CURRENT'] = isset($decor_ceremony_data->LAST_YEAR_CURRENT_PERIOD) ? $decor_ceremony_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $decor_ceremony['ACTUAL_YTD'] = isset($decor_ceremony_data->ACTUAL_YTD) ? $decor_ceremony_data->ACTUAL_YTD : 0;
                $decor_ceremony['LAST_MONTH_YTD'] = isset($decor_ceremony_data->LAST_MONTH_YTD) ? $decor_ceremony_data->LAST_MONTH_YTD : 0;
                $decor_ceremony['LAST_YEAR_YTD'] = isset($decor_ceremony_data->LAST_YEAR_YTD) ? $decor_ceremony_data->LAST_YEAR_YTD : 0;

                // ENTERTAINMENT
                $entertainment_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $entertainment['NAME'] = 'ENTERTAINMENT REVENUE';
                $entertainment['ACTUAL_CURRENT'] = isset($entertainment_data->ACTUAL_CURRENT_PERIOD) ? $entertainment_data->ACTUAL_CURRENT_PERIOD : 0;
                $entertainment['LAST_MONTH_CURRENT'] = isset($entertainment_data->LAST_MONTH_CURRENT_PERIOD) ? $entertainment_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $entertainment['LAST_YEAR_CURRENT'] = isset($entertainment_data->LAST_YEAR_CURRENT_PERIOD) ? $entertainment_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $entertainment['ACTUAL_YTD'] = isset($entertainment_data->ACTUAL_YTD) ? $entertainment_data->ACTUAL_YTD : 0;
                $entertainment['LAST_MONTH_YTD'] = isset($entertainment_data->LAST_MONTH_YTD) ? $entertainment_data->LAST_MONTH_YTD : 0;
                $entertainment['LAST_YEAR_YTD'] = isset($entertainment_data->LAST_YEAR_YTD) ? $entertainment_data->LAST_YEAR_YTD : 0;

                // FLOWER
                $flower_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129050000';
                })->first();
                // MTD
                $flower['NAME'] = 'FLOWER REVENUE';
                $flower['ACTUAL_CURRENT'] = isset($flower_data->ACTUAL_CURRENT_PERIOD) ? $flower_data->ACTUAL_CURRENT_PERIOD : 0;
                $flower['LAST_MONTH_CURRENT'] = isset($flower_data->LAST_MONTH_CURRENT_PERIOD) ? $flower_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $flower['LAST_YEAR_CURRENT'] = isset($flower_data->LAST_YEAR_CURRENT_PERIOD) ? $flower_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $flower['ACTUAL_YTD'] = isset($flower_data->ACTUAL_YTD) ? $flower_data->ACTUAL_YTD : 0;
                $flower['LAST_MONTH_YTD'] = isset($flower_data->LAST_MONTH_YTD) ? $flower_data->LAST_MONTH_YTD : 0;
                $flower['LAST_YEAR_YTD'] = isset($flower_data->LAST_YEAR_YTD) ? $flower_data->LAST_YEAR_YTD : 0;

                // MEETING ROOM RENTAL
                $meeting_room_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129060000';
                })->first();
                // MTD
                $meeting_room['NAME'] = 'MEETING ROOM REVENUE';
                $meeting_room['ACTUAL_CURRENT'] = isset($meeting_room_data->ACTUAL_CURRENT_PERIOD) ? $meeting_room_data->ACTUAL_CURRENT_PERIOD : 0;
                $meeting_room['LAST_MONTH_CURRENT'] = isset($meeting_room_data->LAST_MONTH_CURRENT_PERIOD) ? $meeting_room_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $meeting_room['LAST_YEAR_CURRENT'] = isset($meeting_room_data->LAST_YEAR_CURRENT_PERIOD) ? $meeting_room_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $meeting_room['ACTUAL_YTD'] = isset($meeting_room_data->ACTUAL_YTD) ? $meeting_room_data->ACTUAL_YTD : 0;
                $meeting_room['LAST_MONTH_YTD'] = isset($meeting_room_data->LAST_MONTH_YTD) ? $meeting_room_data->LAST_MONTH_YTD : 0;
                $meeting_room['LAST_YEAR_YTD'] = isset($meeting_room_data->LAST_YEAR_YTD) ? $meeting_room_data->LAST_YEAR_YTD : 0;

                // TOBACO
                $tobaco_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129070000';
                })->first();
                // MTD
                $tobaco['NAME'] = 'TOBACCO FNB REVENUE';
                $tobaco['ACTUAL_CURRENT'] = isset($tobaco_data->ACTUAL_CURRENT_PERIOD) ? $tobaco_data->ACTUAL_CURRENT_PERIOD : 0;
                $tobaco['LAST_MONTH_CURRENT'] = isset($tobaco_data->LAST_MONTH_CURRENT_PERIOD) ? $tobaco_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $tobaco['LAST_YEAR_CURRENT'] = isset($tobaco_data->LAST_YEAR_CURRENT_PERIOD) ? $tobaco_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $tobaco['ACTUAL_YTD'] = isset($tobaco_data->ACTUAL_YTD) ? $tobaco_data->ACTUAL_YTD : 0;
                $tobaco['LAST_MONTH_YTD'] = isset($tobaco_data->LAST_MONTH_YTD) ? $tobaco_data->LAST_MONTH_YTD : 0;
                $tobaco['LAST_YEAR_YTD'] = isset($tobaco_data->LAST_YEAR_YTD) ? $tobaco_data->LAST_YEAR_YTD : 0;

                // MISCELLANEOUS
                $miscellaneous_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $miscellaneous['NAME'] = 'MISCELLANEOUS REVENUE';
                $miscellaneous['ACTUAL_CURRENT'] = isset($miscellaneous_data->ACTUAL_CURRENT_PERIOD) ? $miscellaneous_data->ACTUAL_CURRENT_PERIOD : 0;
                $miscellaneous['LAST_MONTH_CURRENT'] = isset($miscellaneous_data->LAST_MONTH_CURRENT_PERIOD) ? $miscellaneous_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $miscellaneous['LAST_YEAR_CURRENT'] = isset($miscellaneous_data->LAST_YEAR_CURRENT_PERIOD) ? $miscellaneous_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $miscellaneous['ACTUAL_YTD'] = isset($miscellaneous_data->ACTUAL_YTD) ? $miscellaneous_data->ACTUAL_YTD : 0;
                $miscellaneous['LAST_MONTH_YTD'] = isset($miscellaneous_data->LAST_MONTH_YTD) ? $miscellaneous_data->LAST_MONTH_YTD : 0;
                $miscellaneous['LAST_YEAR_YTD'] = isset($miscellaneous_data->LAST_YEAR_YTD) ? $miscellaneous_data->LAST_YEAR_YTD : 0;

                // LOCAL
                $local_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $local['NAME'] = 'LOCAL REVENUE';
                $local['ACTUAL_CURRENT'] = isset($local_data->ACTUAL_CURRENT_PERIOD) ? $local_data->ACTUAL_CURRENT_PERIOD : 0;
                $local['LAST_MONTH_CURRENT'] = isset($local_data->LAST_MONTH_CURRENT_PERIOD) ? $local_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $local['LAST_YEAR_CURRENT'] = isset($local_data->LAST_YEAR_CURRENT_PERIOD) ? $local_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $local['ACTUAL_YTD'] = isset($local_data->ACTUAL_YTD) ? $local_data->ACTUAL_YTD : 0;
                $local['LAST_MONTH_YTD'] = isset($local_data->LAST_MONTH_YTD) ? $local_data->LAST_MONTH_YTD : 0;
                $local['LAST_YEAR_YTD'] = isset($local_data->LAST_YEAR_YTD) ? $local_data->LAST_YEAR_YTD : 0;

                // LONG DISTANCE
                $long_distance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4192020000';
                })->first();
                // MTD
                $long_distance['NAME'] = 'LONG DISTANCE REVENUE';
                $long_distance['ACTUAL_CURRENT'] = isset($long_distance_data->ACTUAL_CURRENT_PERIOD) ? $long_distance_data->ACTUAL_CURRENT_PERIOD : 0;
                $long_distance['LAST_MONTH_CURRENT'] = isset($long_distance_data->LAST_MONTH_CURRENT_PERIOD) ? $long_distance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $long_distance['LAST_YEAR_CURRENT'] = isset($long_distance_data->LAST_YEAR_CURRENT_PERIOD) ? $long_distance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $long_distance['ACTUAL_YTD'] = isset($long_distance_data->ACTUAL_YTD) ? $long_distance_data->ACTUAL_YTD : 0;
                $long_distance['LAST_MONTH_YTD'] = isset($long_distance_data->LAST_MONTH_YTD) ? $long_distance_data->LAST_MONTH_YTD : 0;
                $long_distance['LAST_YEAR_YTD'] = isset($long_distance_data->LAST_YEAR_YTD) ? $long_distance_data->LAST_YEAR_YTD : 0;

                // internet
                $internet_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $internet['NAME'] = 'INTERNET REVENUE';
                $internet['ACTUAL_CURRENT'] = isset($internet_data->ACTUAL_CURRENT_PERIOD) ? $internet_data->ACTUAL_CURRENT_PERIOD : 0;
                $internet['LAST_MONTH_CURRENT'] = isset($internet_data->LAST_MONTH_CURRENT_PERIOD) ? $internet_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $internet['LAST_YEAR_CURRENT'] = isset($internet_data->LAST_YEAR_CURRENT_PERIOD) ? $internet_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $internet['ACTUAL_YTD'] = isset($internet_data->ACTUAL_YTD) ? $internet_data->ACTUAL_YTD : 0;
                $internet['LAST_MONTH_YTD'] = isset($internet_data->LAST_MONTH_YTD) ? $internet_data->LAST_MONTH_YTD : 0;
                $internet['LAST_YEAR_YTD'] = isset($internet_data->LAST_YEAR_YTD) ? $internet_data->LAST_YEAR_YTD : 0;

                // internet
                $allowance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199990000';
                })->first();
                // MTD
                $allowance['NAME'] = 'ALLOWANCE - COMM - REVENUE';
                $allowance['ACTUAL_CURRENT'] = isset($allowance_data->ACTUAL_CURRENT_PERIOD) ? $allowance_data->ACTUAL_CURRENT_PERIOD : 0;
                $allowance['LAST_MONTH_CURRENT'] = isset($allowance_data->LAST_MONTH_CURRENT_PERIOD) ? $allowance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $allowance['LAST_YEAR_CURRENT'] = isset($allowance_data->LAST_YEAR_CURRENT_PERIOD) ? $allowance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $allowance['ACTUAL_YTD'] = isset($allowance_data->ACTUAL_YTD) ? $allowance_data->ACTUAL_YTD : 0;
                $allowance['LAST_MONTH_YTD'] = isset($allowance_data->LAST_MONTH_YTD) ? $allowance_data->LAST_MONTH_YTD : 0;
                $allowance['LAST_YEAR_YTD'] = isset($allowance_data->LAST_YEAR_YTD) ? $allowance_data->LAST_YEAR_YTD : 0;

                $GL_pair_cost_sales_other_revenue = array(
                    '5111010100'=>$food_revenue_total,
                    '5111010300'=>$liquor,
                    '5111010400'=>$wine,
                    '5111010200'=>$beer,
                    '5111030100'=>$audio_visual,
                    '5111030200'=>$decor_ceremony,
                    '5111030300'=>$entertainment,
                    '5121110200'=>[],
                    '5111039900'=>$miscellaneous,
                    '5111030400'=>$meeting_room,
                    '5111030600'=>$tobaco,
                );

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($grouping_data['B']['DATA']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $grouping_data['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $grouping_data['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $grouping_data['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $grouping_data['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($grouping_data['B']['DATA']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $grouping_data['B']['DATA']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $grouping_data['B']['DATA']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($grouping_data['B']['DATA']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $grouping_data['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $grouping_data['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($grouping_data['B']['DATA']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $grouping_data['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $grouping_data['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;

        }
        
        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        $collection_data['GROUPING'][$array_name] = isset($grouping_data) ? $grouping_data : [];

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;
        // Kode A untuk total Payroll
        // Kode B untuk total Revenue
        // MTD
        $departmental_actual_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0) ;
        $departmental_actual_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0) ;
        $departmental_last_month_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0) ;
        $departmental_last_year_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

        // YTD
       $departmental_actual_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0) ;
        $departmental_actual_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0) ;
        $departmental_last_month_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0) ;
        $departmental_last_year_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0
;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;
        // }

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        // dd($collection);
        return $collection;
    }

    public function cntn_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            // dd($collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE'));
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG masing" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'FBR'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // MENCARI FOOD REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['FDR']['DATA_CATEGORY'])){
            $collection_data['FDR']['DATA_CATEGORY'] = collect($collection_data['FDR']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['FDR']['SUM_CATEGORY'])){
            // MTD
            $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI FOOD REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        
        // MENCARI BEVERAGE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['BVR']['DATA_CATEGORY'])){
            $collection_data['BVR']['DATA_CATEGORY'] = collect($collection_data['BVR']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BVR']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI BEVERAGE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI COST OF SALES PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $divide_by_food_beverage_revenue_only = ['5111010100','5111010200','5111010300','5111010400'];
                $sap_coa_per_item = isset($item->SAP_COA) ? (String)$item->SAP_COA : '-';
                if(in_array($sap_coa_per_item, $divide_by_food_beverage_revenue_only)){
                    if($sap_coa_per_item == '5111010100'){
                        // MTD
                        if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                            $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                        }
                        if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                            $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                        }
                        if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                            $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                        }

                        // YTD
                        if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                            $item->ACTUAL_YTD_PCTG = isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                        }
                        if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                            $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                        }
                        if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                            $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                        }
                    } else if ($sap_coa_per_item == '5111010200' || $sap_coa_per_item == '5111010300' || $sap_coa_per_item == '5111010400'){
                        // MTD
                        if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                            $item->ACTUAL_CURRENT_PCTG = isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                        }
                        if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                            $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                        }
                        if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                            $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                        }

                        // YTD
                        if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                            $item->ACTUAL_YTD_PCTG = isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                        }
                        if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                            $item->LAST_MONTH_YTD_PCTG = isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                        }
                        if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                            $item->LAST_YEAR_YTD_PCTG = isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                        }
                    }

                } else {
                    // MTD
                    if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                        $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    }
                    if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                        $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    }
                    if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                        $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                    }

                    // YTD
                    if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                        $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    }
                    if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                        $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    }
                    if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                        $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                    }
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI COST OF SALES REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI SALARY REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI SALARY REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI BENEFIT REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI BENEFIT REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI OTHER EXPENSE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI OTHER EXPENSE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;

        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     // Department actual current
        //     $departmental_actual_current = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? 
        //     $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;

        //     // Department actual current pctg
        //     $departmental_actual_current_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? 
        //     $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;

        //     $departmental_last_month_current_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? 
        //     $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;

        //     $departmental_last_year_current_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? 
        //     $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;

        //     $departmental_actual_ytd_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_current / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? 
        //     $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;

        //     $departmental_last_month_ytd_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_current / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? 
        //     $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;

        //     $departmental_last_year_ytd_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }
        // MTD
        // MTD
        $departmental_actual_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0) ;
        $departmental_actual_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0) ;
        $departmental_last_month_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0) ;
        $departmental_last_year_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

        // YTD
        $departmental_actual_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0) ;
        $departmental_actual_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0) ;
        $departmental_last_month_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0) ;
        $departmental_last_year_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;


        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        // dd($collection);
        return $collection;
    }

    public function utlrb_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function utlay_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function utlayrb_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function engrb_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function engay_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function engayrb_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function sm_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function hr_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
            // $departmental_actual_current = isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] + $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] + $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;

        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function it_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function agsum_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function roi_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){

                $laundry_guest_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4161010000';
                })->first();
                // MTD
                $laundry_guest['NAME'] = 'ALLOWANCE REVENUE';
                $laundry_guest['ACTUAL_CURRENT'] = isset($laundry_guest_data->ACTUAL_CURRENT_PERIOD) ? $laundry_guest_data->ACTUAL_CURRENT_PERIOD : 0;
                $laundry_guest['LAST_MONTH_CURRENT'] = isset($laundry_guest_data->LAST_MONTH_CURRENT_PERIOD) ? $laundry_guest_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $laundry_guest['LAST_YEAR_CURRENT'] = isset($laundry_guest_data->LAST_YEAR_CURRENT_PERIOD) ? $laundry_guest_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $laundry_guest['ACTUAL_YTD'] = isset($laundry_guest_data->ACTUAL_YTD) ? $laundry_guest_data->ACTUAL_YTD : 0;
                $laundry_guest['LAST_MONTH_YTD'] = isset($laundry_guest_data->LAST_MONTH_YTD) ? $laundry_guest_data->LAST_MONTH_YTD : 0;
                $laundry_guest['LAST_YEAR_YTD'] = isset($laundry_guest_data->LAST_YEAR_YTD) ? $laundry_guest_data->LAST_YEAR_YTD : 0;

                $revenue_total = array(
                    // MTD
                    "NAME"=>"REVENUE_TOTAL",
                    "ACTUAL_CURRENT"=>isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0,
                    "LAST_MONTH_CURRENT"=>isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0,
                    "LAST_YEAR_CURRENT"=>isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0,

                    // YTD
                    "ACTUAL_YTD"=>isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0,
                    "LAST_MONTH_YTD"=>isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0,
                    "LAST_YEAR_YTD"=>isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0
                );

                $GL_pair_cost_sales_other_revenue = array(
                    '5111031100'=>$laundry_guest,
                    '5111039900'=>$revenue_total
                );

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }

        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;        

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function bc_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){

                $secretary_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4191010000';
                })->first();
                // MTD
                $secretary['NAME'] = 'ALLOWANCE REVENUE';
                $secretary['ACTUAL_CURRENT'] = isset($secretary_data->ACTUAL_CURRENT_PERIOD) ? $secretary_data->ACTUAL_CURRENT_PERIOD : 0;
                $secretary['LAST_MONTH_CURRENT'] = isset($secretary_data->LAST_MONTH_CURRENT_PERIOD) ? $secretary_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $secretary['LAST_YEAR_CURRENT'] = isset($secretary_data->LAST_YEAR_CURRENT_PERIOD) ? $secretary_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $secretary['ACTUAL_YTD'] = isset($secretary_data->ACTUAL_YTD) ? $secretary_data->ACTUAL_YTD : 0;
                $secretary['LAST_MONTH_YTD'] = isset($secretary_data->LAST_MONTH_YTD) ? $secretary_data->LAST_MONTH_YTD : 0;
                $secretary['LAST_YEAR_YTD'] = isset($secretary_data->LAST_YEAR_YTD) ? $secretary_data->LAST_YEAR_YTD : 0;

                $other_svc_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4191980000';
                })->first();
                // MTD
                $other_svc['NAME'] = 'ALLOWANCE REVENUE';
                $other_svc['ACTUAL_CURRENT'] = isset($other_svc_data->ACTUAL_CURRENT_PERIOD) ? $other_svc_data->ACTUAL_CURRENT_PERIOD : 0;
                $other_svc['LAST_MONTH_CURRENT'] = isset($other_svc_data->LAST_MONTH_CURRENT_PERIOD) ? $other_svc_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $other_svc['LAST_YEAR_CURRENT'] = isset($other_svc_data->LAST_YEAR_CURRENT_PERIOD) ? $other_svc_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $other_svc['ACTUAL_YTD'] = isset($other_svc_data->ACTUAL_YTD) ? $other_svc_data->ACTUAL_YTD : 0;
                $other_svc['LAST_MONTH_YTD'] = isset($other_svc_data->LAST_MONTH_YTD) ? $other_svc_data->LAST_MONTH_YTD : 0;
                $other_svc['LAST_YEAR_YTD'] = isset($other_svc_data->LAST_YEAR_YTD) ? $other_svc_data->LAST_YEAR_YTD : 0; 

                $professional_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4191020000';
                })->first();
                // MTD
                $professional['NAME'] = 'ALLOWANCE REVENUE';
                $professional['ACTUAL_CURRENT'] = isset($professional_data->ACTUAL_CURRENT_PERIOD) ? $professional_data->ACTUAL_CURRENT_PERIOD : 0;
                $professional['LAST_MONTH_CURRENT'] = isset($professional_data->LAST_MONTH_CURRENT_PERIOD) ? $professional_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $professional['LAST_YEAR_CURRENT'] = isset($professional_data->LAST_YEAR_CURRENT_PERIOD) ? $professional_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $professional['ACTUAL_YTD'] = isset($professional_data->ACTUAL_YTD) ? $professional_data->ACTUAL_YTD : 0;
                $professional['LAST_MONTH_YTD'] = isset($professional_data->LAST_MONTH_YTD) ? $professional_data->LAST_MONTH_YTD : 0;
                $professional['LAST_YEAR_YTD'] = isset($professional_data->LAST_YEAR_YTD) ? $professional_data->LAST_YEAR_YTD : 0;

                $misc_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199010100';
                })->first();
                // MTD
                $misc['NAME'] = 'ALLOWANCE REVENUE';
                $misc['ACTUAL_CURRENT'] = isset($misc_data->ACTUAL_CURRENT_PERIOD) ? $misc_data->ACTUAL_CURRENT_PERIOD : 0;
                $misc['LAST_MONTH_CURRENT'] = isset($misc_data->LAST_MONTH_CURRENT_PERIOD) ? $misc_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $misc['LAST_YEAR_CURRENT'] = isset($misc_data->LAST_YEAR_CURRENT_PERIOD) ? $misc_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $misc['ACTUAL_YTD'] = isset($misc_data->ACTUAL_YTD) ? $misc_data->ACTUAL_YTD : 0;
                $misc['LAST_MONTH_YTD'] = isset($misc_data->LAST_MONTH_YTD) ? $misc_data->LAST_MONTH_YTD : 0;
                $misc['LAST_YEAR_YTD'] = isset($misc_data->LAST_YEAR_YTD) ? $misc_data->LAST_YEAR_YTD : 0;

                $allowance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199990000';
                })->first();
                // MTD
                $allowance['NAME'] = 'ALLOWANCE REVENUE';
                $allowance['ACTUAL_CURRENT'] = isset($allowance_data->ACTUAL_CURRENT_PERIOD) ? $allowance_data->ACTUAL_CURRENT_PERIOD : 0;
                $allowance['LAST_MONTH_CURRENT'] = isset($allowance_data->LAST_MONTH_CURRENT_PERIOD) ? $allowance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $allowance['LAST_YEAR_CURRENT'] = isset($allowance_data->LAST_YEAR_CURRENT_PERIOD) ? $allowance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $allowance['ACTUAL_YTD'] = isset($allowance_data->ACTUAL_YTD) ? $allowance_data->ACTUAL_YTD : 0;
                $allowance['LAST_MONTH_YTD'] = isset($allowance_data->LAST_MONTH_YTD) ? $allowance_data->LAST_MONTH_YTD : 0;
                $allowance['LAST_YEAR_YTD'] = isset($allowance_data->LAST_YEAR_YTD) ? $allowance_data->LAST_YEAR_YTD : 0;

                $GL_pair_cost_sales_other_revenue = array(
                    '5121110200'=>[],
                    '5111030800'=>$secretary,
                    '5111039900'=>$misc
                );

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }

        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function recreation_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){

                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }
        
        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function authentique_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $fuchigami_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199010200';
                })->first();
                // MTD
                $fuchigami['NAME'] = 'ACCESSORIES REVENUE';
                $fuchigami['ACTUAL_CURRENT'] = isset($fuchigami_data->ACTUAL_CURRENT_PERIOD) ? $fuchigami_data->ACTUAL_CURRENT_PERIOD : 0;
                $fuchigami['LAST_MONTH_CURRENT'] = isset($fuchigami_data->LAST_MONTH_CURRENT_PERIOD) ? $fuchigami_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $fuchigami['LAST_YEAR_CURRENT'] = isset($fuchigami_data->LAST_YEAR_CURRENT_PERIOD) ? $fuchigami_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $fuchigami['ACTUAL_YTD'] = isset($fuchigami_data->ACTUAL_YTD) ? $fuchigami_data->ACTUAL_YTD : 0;
                $fuchigami['LAST_MONTH_YTD'] = isset($fuchigami_data->LAST_MONTH_YTD) ? $fuchigami_data->LAST_MONTH_YTD : 0;
                $fuchigami['LAST_YEAR_YTD'] = isset($fuchigami_data->LAST_YEAR_YTD) ? $fuchigami_data->LAST_YEAR_YTD : 0;              

                $GL_pair_cost_sales_other_revenue = array(
                    '5111020100'=>$fuchigami,
                );

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }
        
        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
        

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function retail_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $accessories_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4151010000';
                })->first();
                // MTD
                $accessories['NAME'] = 'ACCESSORIES REVENUE';
                $accessories['ACTUAL_CURRENT'] = isset($accessories_data->ACTUAL_CURRENT_PERIOD) ? $accessories_data->ACTUAL_CURRENT_PERIOD : 0;
                $accessories['LAST_MONTH_CURRENT'] = isset($accessories_data->LAST_MONTH_CURRENT_PERIOD) ? $accessories_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $accessories['LAST_YEAR_CURRENT'] = isset($accessories_data->LAST_YEAR_CURRENT_PERIOD) ? $accessories_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $accessories['ACTUAL_YTD'] = isset($accessories_data->ACTUAL_YTD) ? $accessories_data->ACTUAL_YTD : 0;
                $accessories['LAST_MONTH_YTD'] = isset($accessories_data->LAST_MONTH_YTD) ? $accessories_data->LAST_MONTH_YTD : 0;
                $accessories['LAST_YEAR_YTD'] = isset($accessories_data->LAST_YEAR_YTD) ? $accessories_data->LAST_YEAR_YTD : 0;

                $apparel_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4151020000';
                })->first();
                // MTD
                $apparel['NAME'] = 'APPAREL REVENUE';
                $apparel['ACTUAL_CURRENT'] = isset($apparel_data->ACTUAL_CURRENT_PERIOD) ? $apparel_data->ACTUAL_CURRENT_PERIOD : 0;
                $apparel['LAST_MONTH_CURRENT'] = isset($apparel_data->LAST_MONTH_CURRENT_PERIOD) ? $apparel_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $apparel['LAST_YEAR_CURRENT'] = isset($apparel_data->LAST_YEAR_CURRENT_PERIOD) ? $apparel_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $apparel['ACTUAL_YTD'] = isset($apparel_data->ACTUAL_YTD) ? $apparel_data->ACTUAL_YTD : 0;
                $apparel['LAST_MONTH_YTD'] = isset($apparel_data->LAST_MONTH_YTD) ? $apparel_data->LAST_MONTH_YTD : 0;
                $apparel['LAST_YEAR_YTD'] = isset($apparel_data->LAST_YEAR_YTD) ? $apparel_data->LAST_YEAR_YTD : 0;

                $gifts_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4151030000';
                })->first();
                // MTD
                $gifts['NAME'] = 'GIFTS REVENUE';
                $gifts['ACTUAL_CURRENT'] = isset($gifts_data->ACTUAL_CURRENT_PERIOD) ? $gifts_data->ACTUAL_CURRENT_PERIOD : 0;
                $gifts['LAST_MONTH_CURRENT'] = isset($gifts_data->LAST_MONTH_CURRENT_PERIOD) ? $gifts_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $gifts['LAST_YEAR_CURRENT'] = isset($gifts_data->LAST_YEAR_CURRENT_PERIOD) ? $gifts_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $gifts['ACTUAL_YTD'] = isset($gifts_data->ACTUAL_YTD) ? $gifts_data->ACTUAL_YTD : 0;
                $gifts['LAST_MONTH_YTD'] = isset($gifts_data->LAST_MONTH_YTD) ? $gifts_data->LAST_MONTH_YTD : 0;
                $gifts['LAST_YEAR_YTD'] = isset($gifts_data->LAST_YEAR_YTD) ? $gifts_data->LAST_YEAR_YTD : 0;

                $spa_product_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4151040000';
                })->first();
                // MTD
                $spa_product['NAME'] = 'SPA PRODUCT REVENUE';
                $spa_product['ACTUAL_CURRENT'] = isset($spa_product_data->ACTUAL_CURRENT_PERIOD) ? $spa_product_data->ACTUAL_CURRENT_PERIOD : 0;
                $spa_product['LAST_MONTH_CURRENT'] = isset($spa_product_data->LAST_MONTH_CURRENT_PERIOD) ? $spa_product_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $spa_product['LAST_YEAR_CURRENT'] = isset($spa_product_data->LAST_YEAR_CURRENT_PERIOD) ? $spa_product_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $spa_product['ACTUAL_YTD'] = isset($spa_product_data->ACTUAL_YTD) ? $spa_product_data->ACTUAL_YTD : 0;
                $spa_product['LAST_MONTH_YTD'] = isset($spa_product_data->LAST_MONTH_YTD) ? $spa_product_data->LAST_MONTH_YTD : 0;
                $spa_product['LAST_YEAR_YTD'] = isset($spa_product_data->LAST_YEAR_YTD) ? $spa_product_data->LAST_YEAR_YTD : 0;
                
                $sundries_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4151050000';
                })->first();
                // MTD
                $sundries['NAME'] = 'SUNDRIES REVENUE';
                $sundries['ACTUAL_CURRENT'] = isset($sundries_data->ACTUAL_CURRENT_PERIOD) ? $sundries_data->ACTUAL_CURRENT_PERIOD : 0;
                $sundries['LAST_MONTH_CURRENT'] = isset($sundries_data->LAST_MONTH_CURRENT_PERIOD) ? $sundries_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $sundries['LAST_YEAR_CURRENT'] = isset($sundries_data->LAST_YEAR_CURRENT_PERIOD) ? $sundries_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $sundries['ACTUAL_YTD'] = isset($sundries_data->ACTUAL_YTD) ? $sundries_data->ACTUAL_YTD : 0;
                $sundries['LAST_MONTH_YTD'] = isset($sundries_data->LAST_MONTH_YTD) ? $sundries_data->LAST_MONTH_YTD : 0;
                $sundries['LAST_YEAR_YTD'] = isset($sundries_data->LAST_YEAR_YTD) ? $sundries_data->LAST_YEAR_YTD : 0;

                $tobaco_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4151060000';
                })->first();
                // MTD
                $tobaco['NAME'] = 'TOBACCO REVENUE';
                $tobaco['ACTUAL_CURRENT'] = isset($tobaco_data->ACTUAL_CURRENT_PERIOD) ? $tobaco_data->ACTUAL_CURRENT_PERIOD : 0;
                $tobaco['LAST_MONTH_CURRENT'] = isset($tobaco_data->LAST_MONTH_CURRENT_PERIOD) ? $tobaco_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $tobaco['LAST_YEAR_CURRENT'] = isset($tobaco_data->LAST_YEAR_CURRENT_PERIOD) ? $tobaco_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $tobaco['ACTUAL_YTD'] = isset($tobaco_data->ACTUAL_YTD) ? $tobaco_data->ACTUAL_YTD : 0;
                $tobaco['LAST_MONTH_YTD'] = isset($tobaco_data->LAST_MONTH_YTD) ? $tobaco_data->LAST_MONTH_YTD : 0;
                $tobaco['LAST_YEAR_YTD'] = isset($tobaco_data->LAST_YEAR_YTD) ? $tobaco_data->LAST_YEAR_YTD : 0;

                $allowance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199990000';
                })->first();
                // MTD
                $allowance['NAME'] = 'ALLOWANCE REVENUE';
                $allowance['ACTUAL_CURRENT'] = isset($allowance_data->ACTUAL_CURRENT_PERIOD) ? $allowance_data->ACTUAL_CURRENT_PERIOD : 0;
                $allowance['LAST_MONTH_CURRENT'] = isset($allowance_data->LAST_MONTH_CURRENT_PERIOD) ? $allowance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $allowance['LAST_YEAR_CURRENT'] = isset($allowance_data->LAST_YEAR_CURRENT_PERIOD) ? $allowance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $allowance['ACTUAL_YTD'] = isset($allowance_data->ACTUAL_YTD) ? $allowance_data->ACTUAL_YTD : 0;
                $allowance['LAST_MONTH_YTD'] = isset($allowance_data->LAST_MONTH_YTD) ? $allowance_data->LAST_MONTH_YTD : 0;
                $allowance['LAST_YEAR_YTD'] = isset($allowance_data->LAST_YEAR_YTD) ? $allowance_data->LAST_YEAR_YTD : 0;                

                $GL_pair_cost_sales_other_revenue = array(
                    '5111020100'=>$accessories,
                    '5111020200'=>$apparel,
                    '5111020300'=>$gifts,
                    '5111020400'=>$spa_product,
                    '5111020500'=>$sundries,
                    '5111020600'=>$tobaco
                );

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }
        
        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
        

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function comm_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // LOCAL
                $local_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $local['NAME'] = 'LOCAL REVENUE';
                $local['ACTUAL_CURRENT'] = isset($local_data->ACTUAL_CURRENT_PERIOD) ? $local_data->ACTUAL_CURRENT_PERIOD : 0;
                $local['LAST_MONTH_CURRENT'] = isset($local_data->LAST_MONTH_CURRENT_PERIOD) ? $local_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $local['LAST_YEAR_CURRENT'] = isset($local_data->LAST_YEAR_CURRENT_PERIOD) ? $local_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $local['ACTUAL_YTD'] = isset($local_data->ACTUAL_YTD) ? $local_data->ACTUAL_YTD : 0;
                $local['LAST_MONTH_YTD'] = isset($local_data->LAST_MONTH_YTD) ? $local_data->LAST_MONTH_YTD : 0;
                $local['LAST_YEAR_YTD'] = isset($local_data->LAST_YEAR_YTD) ? $local_data->LAST_YEAR_YTD : 0;

                // LONG DISTANCE
                $long_distance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4192020000';
                })->first();
                // MTD
                $long_distance['NAME'] = 'LONG DISTANCE REVENUE';
                $long_distance['ACTUAL_CURRENT'] = isset($long_distance_data->ACTUAL_CURRENT_PERIOD) ? $long_distance_data->ACTUAL_CURRENT_PERIOD : 0;
                $long_distance['LAST_MONTH_CURRENT'] = isset($long_distance_data->LAST_MONTH_CURRENT_PERIOD) ? $long_distance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $long_distance['LAST_YEAR_CURRENT'] = isset($long_distance_data->LAST_YEAR_CURRENT_PERIOD) ? $long_distance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $long_distance['ACTUAL_YTD'] = isset($long_distance_data->ACTUAL_YTD) ? $long_distance_data->ACTUAL_YTD : 0;
                $long_distance['LAST_MONTH_YTD'] = isset($long_distance_data->LAST_MONTH_YTD) ? $long_distance_data->LAST_MONTH_YTD : 0;
                $long_distance['LAST_YEAR_YTD'] = isset($long_distance_data->LAST_YEAR_YTD) ? $long_distance_data->LAST_YEAR_YTD : 0;

                // internet
                $internet_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $internet['NAME'] = 'INTERNET REVENUE';
                $internet['ACTUAL_CURRENT'] = isset($internet_data->ACTUAL_CURRENT_PERIOD) ? $internet_data->ACTUAL_CURRENT_PERIOD : 0;
                $internet['LAST_MONTH_CURRENT'] = isset($internet_data->LAST_MONTH_CURRENT_PERIOD) ? $internet_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $internet['LAST_YEAR_CURRENT'] = isset($internet_data->LAST_YEAR_CURRENT_PERIOD) ? $internet_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $internet['ACTUAL_YTD'] = isset($internet_data->ACTUAL_YTD) ? $internet_data->ACTUAL_YTD : 0;
                $internet['LAST_MONTH_YTD'] = isset($internet_data->LAST_MONTH_YTD) ? $internet_data->LAST_MONTH_YTD : 0;
                $internet['LAST_YEAR_YTD'] = isset($internet_data->LAST_YEAR_YTD) ? $internet_data->LAST_YEAR_YTD : 0;

                // internet
                $allowance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199990000';
                })->first();
                // MTD
                $allowance['NAME'] = 'ALLOWANCE - COMM - REVENUE';
                $allowance['ACTUAL_CURRENT'] = isset($allowance_data->ACTUAL_CURRENT_PERIOD) ? $allowance_data->ACTUAL_CURRENT_PERIOD : 0;
                $allowance['LAST_MONTH_CURRENT'] = isset($allowance_data->LAST_MONTH_CURRENT_PERIOD) ? $allowance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $allowance['LAST_YEAR_CURRENT'] = isset($allowance_data->LAST_YEAR_CURRENT_PERIOD) ? $allowance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $allowance['ACTUAL_YTD'] = isset($allowance_data->ACTUAL_YTD) ? $allowance_data->ACTUAL_YTD : 0;
                $allowance['LAST_MONTH_YTD'] = isset($allowance_data->LAST_MONTH_YTD) ? $allowance_data->LAST_MONTH_YTD : 0;
                $allowance['LAST_YEAR_YTD'] = isset($allowance_data->LAST_YEAR_YTD) ? $allowance_data->LAST_YEAR_YTD : 0;

                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? ($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }
        
        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }


    public function spa_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }

        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function departmental_expense_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        /* Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT) */
        // $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
        //     // SUM MTD
        //     $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
        //     $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
        //     $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
        //     $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
        //     // SUM YTD
        //     $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
        //     $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
        //     $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
        //     $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

        //     $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
        //     return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        // })->toArray();
        $obj = $this;
        $collect_data = $collection_data;
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key) use ($obj, $collect_data, $array_name){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $collection_data = $obj->grouping_pctg_process($collection_data, $collect_data, $array_name, $key);
            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) + (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function other_rev_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG maREVg" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'REV'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        /* Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT) */
        // $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
        //     // SUM MTD
        //     $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
        //     $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
        //     $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
        //     $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
        //     // SUM YTD
        //     $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
        //     $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
        //     $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
        //     $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

        //     $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
        //     return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        // })->toArray();
        $obj = $this;
        $collect_data = $collection_data;
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key) use ($obj, $collect_data, $array_name){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $collection_data = $obj->grouping_pctg_process($collection_data, $collect_data, $array_name, $key);
            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        $departmental_actual_current = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        return $collection;
    }

    public function fnb_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use (&$grouping_arj){
                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);
                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();

            // Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT)
            // $grouping_data = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
            //     $item_to_count = $item->reject(function($groupingitem){
            //         return $groupingitem->GROUPING_ROW_PARENT;
            //     })->values()->all();
            //     // SUM MTD
            //     $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            //     $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            //     $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            //     $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            //     // SUM YTD
            //     $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            //     $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            //     $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            //     $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            //     $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            //     return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item_to_count)))];
            // })->toArray();

            $obj = $this;
            $collect_data = $collection_data;
            $grouping_data = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key) use ($obj, $collect_data, $array_name){
                $item_to_count = $item->reject(function($groupingitem){
                    return $groupingitem->GROUPING_ROW_PARENT;
                })->values()->all();

                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                $collection_data = $obj->grouping_pctg_process($collection_data, $collect_data, $array_name, $key);
                $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
                return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item_to_count)))];
            })->toArray();

            $collection_data = collect($collection_data)->mapWithKeys(function($item, $key) use ($collection_data, $grouping_data){
                // dd($collection_data);
                // INI loop untuk total PCTG masing" ITEM
                $each_item = isset($item['DATA_CATEGORY']) ? $item['DATA_CATEGORY'] : [];
                $each_item_summary = isset($item['SUM_CATEGORY']) ? $item['SUM_CATEGORY'] : [];
                $type_revenue = null;

                $each_data = collect($each_item)->map(function($item, $key) use ($grouping_data, &$type_revenue){
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue != 'COS'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        // GROUPING B UNTUK TOTAL REVENUE FNB
                        if(isset($grouping_data['B']['DATA']['ACTUAL_CURRENT']) && $grouping_data['B']['DATA']['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $grouping_data['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) && $grouping_data['B']['DATA']['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
                        if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) && $grouping_data['B']['DATA']['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if(isset($grouping_data['B']['DATA']['ACTUAL_YTD']) && $grouping_data['B']['DATA']['ACTUAL_YTD'] !=  0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $grouping_data['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_MONTH_YTD']) && $grouping_data['B']['DATA']['LAST_MONTH_YTD'] !=  0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $grouping_data['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
                        if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                        if(isset($grouping_data['B']['DATA']['LAST_YEAR_YTD']) && $grouping_data['B']['DATA']['LAST_YEAR_YTD'] !=  0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $grouping_data['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    return $item;
                });

                if($type_revenue != 'COS'){
                    if(isset($grouping_data['B']['DATA']['ACTUAL_CURRENT']) && $grouping_data['B']['DATA']['ACTUAL_CURRENT'] != 0)
                        $each_item_summary['ACTUAL_CURRENT_PCTG'] = ($each_item_summary['ACTUAL_CURRENT'] / $grouping_data['B']['DATA']['ACTUAL_CURRENT']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) && $grouping_data['B']['DATA']['LAST_MONTH_CURRENT'] != 0)
                        $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = ($each_item_summary['LAST_MONTH_CURRENT'] / $grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) * 100;
                    if(isset($each_item_summary['LAST_MONTH_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                        $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) && $grouping_data['B']['DATA']['LAST_YEAR_CURRENT'] != 0)
                        $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = ($each_item_summary['LAST_YEAR_CURRENT'] / $grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) * 100;

                    if(isset($grouping_data['B']['DATA']['ACTUAL_YTD']) && $grouping_data['B']['DATA']['ACTUAL_YTD'] != 0)
                        $each_item_summary['ACTUAL_YTD_PCTG'] = ($each_item_summary['ACTUAL_YTD'] / $grouping_data['B']['DATA']['ACTUAL_YTD']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_MONTH_YTD']) && $grouping_data['B']['DATA']['LAST_MONTH_YTD'] != 0)
                        $each_item_summary['LAST_MONTH_YTD_PCTG'] = ($each_item_summary['LAST_MONTH_YTD'] / $grouping_data['B']['DATA']['LAST_MONTH_YTD']) * 100;
                    if(isset($each_item_summary['LAST_MONTH_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                        $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                    if(isset($grouping_data['B']['DATA']['LAST_YEAR_YTD']) && $grouping_data['B']['DATA']['LAST_YEAR_YTD'] != 0)
                        $each_item_summary['LAST_YEAR_YTD_PCTG'] = ($each_item_summary['LAST_YEAR_YTD'] / $grouping_data['B']['DATA']['LAST_YEAR_YTD']) * 100;
                }

                $type_revenue = null;
                return [$key=>array("DATA_CATEGORY"=>$each_item, "SUM_CATEGORY"=>$each_item_summary)];
            })->toArray();
        }


        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data, $grouping_data){
                // dd($collection_data['FDR']['SUM_CATEGORY'], $item);
                // Menentukan Cost of sales pctg dari other revenue dengan kategori yg sama
                $food_revenue_total = array(
                    // MTD
                    "NAME"=>"FOOD_REVENUE_TOTAL",
                    "ACTUAL_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0,
                    "LAST_MONTH_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0,
                    "LAST_YEAR_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0,

                    // YTD
                    "ACTUAL_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD'] : 0,
                    "LAST_MONTH_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0,
                    "LAST_YEAR_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0
                );

                $beverage_revenue_total = array(
                    // MTD
                    "NAME"=>"BEVERAGE_REVENUE_TOTAL",
                    "ACTUAL_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0,
                    "LAST_MONTH_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0,
                    "LAST_YEAR_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0,

                    // YTD
                    "ACTUAL_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD'] : 0,
                    "LAST_MONTH_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0,
                    "LAST_YEAR_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0
                );

                // Liquor
                $liquor_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['BVR']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122020100';
                })->first();
                // MTD
                $liquor['NAME'] = 'LIQUOR REVENUE';
                $liquor['ACTUAL_CURRENT'] = isset($liquor_data->ACTUAL_CURRENT_PERIOD) ? $liquor_data->ACTUAL_CURRENT_PERIOD : 0;
                $liquor['LAST_MONTH_CURRENT'] = isset($liquor_data->LAST_MONTH_CURRENT_PERIOD) ? $liquor_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $liquor['LAST_YEAR_CURRENT'] = isset($liquor_data->LAST_YEAR_CURRENT_PERIOD) ? $liquor_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $liquor['ACTUAL_YTD'] = isset($liquor_data->ACTUAL_YTD) ? $liquor_data->ACTUAL_YTD : 0;
                $liquor['LAST_MONTH_YTD'] = isset($liquor_data->LAST_MONTH_YTD) ? $liquor_data->LAST_MONTH_YTD : 0;
                $liquor['LAST_YEAR_YTD'] = isset($liquor_data->LAST_YEAR_YTD) ? $liquor_data->LAST_YEAR_YTD : 0;

                // WINE
                $wine_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['BVR']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122030100';
                })->first();
                // MTD
                $wine['NAME'] = 'WINE REVENUE';
                $wine['ACTUAL_CURRENT'] = isset($wine_data->ACTUAL_CURRENT_PERIOD) ? $wine_data->ACTUAL_CURRENT_PERIOD : 0;
                $wine['LAST_MONTH_CURRENT'] = isset($wine_data->LAST_MONTH_CURRENT_PERIOD) ? $wine_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $wine['LAST_YEAR_CURRENT'] = isset($wine_data->LAST_YEAR_CURRENT_PERIOD) ? $wine_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $wine['ACTUAL_YTD'] = isset($wine_data->ACTUAL_YTD) ? $wine_data->ACTUAL_YTD : 0;
                $wine['LAST_MONTH_YTD'] = isset($wine_data->LAST_MONTH_YTD) ? $wine_data->LAST_MONTH_YTD : 0;
                $wine['LAST_YEAR_YTD'] = isset($wine_data->LAST_YEAR_YTD) ? $wine_data->LAST_YEAR_YTD : 0;

                // BEER
                $beer_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['BVR']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122010100';
                })->first();
                // MTD
                $beer['NAME'] = 'BEER REVENUE';
                $beer['ACTUAL_CURRENT'] = isset($beer_data->ACTUAL_CURRENT_PERIOD) ? $beer_data->ACTUAL_CURRENT_PERIOD : 0;
                $beer['LAST_MONTH_CURRENT'] = isset($beer_data->LAST_MONTH_CURRENT_PERIOD) ? $beer_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $beer['LAST_YEAR_CURRENT'] = isset($beer_data->LAST_YEAR_CURRENT_PERIOD) ? $beer_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $beer['ACTUAL_YTD'] = isset($beer_data->ACTUAL_YTD) ? $beer_data->ACTUAL_YTD : 0;
                $beer['LAST_MONTH_YTD'] = isset($beer_data->LAST_MONTH_YTD) ? $beer_data->LAST_MONTH_YTD : 0;
                $beer['LAST_YEAR_YTD'] = isset($beer_data->LAST_YEAR_YTD) ? $beer_data->LAST_YEAR_YTD : 0;

                // AUDIO VISUAL
                $audio_visual_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129020000';
                })->first();
                // MTD
                $audio_visual['NAME'] = 'AUDIO VISUAL REVENUE';
                $audio_visual['ACTUAL_CURRENT'] = isset($audio_visual_data->ACTUAL_CURRENT_PERIOD) ? $audio_visual_data->ACTUAL_CURRENT_PERIOD : 0;
                $audio_visual['LAST_MONTH_CURRENT'] = isset($audio_visual_data->LAST_MONTH_CURRENT_PERIOD) ? $audio_visual_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $audio_visual['LAST_YEAR_CURRENT'] = isset($audio_visual_data->LAST_YEAR_CURRENT_PERIOD) ? $audio_visual_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $audio_visual['ACTUAL_YTD'] = isset($audio_visual_data->ACTUAL_YTD) ? $audio_visual_data->ACTUAL_YTD : 0;
                $audio_visual['LAST_MONTH_YTD'] = isset($audio_visual_data->LAST_MONTH_YTD) ? $audio_visual_data->LAST_MONTH_YTD : 0;
                $audio_visual['LAST_YEAR_YTD'] = isset($audio_visual_data->LAST_YEAR_YTD) ? $audio_visual_data->LAST_YEAR_YTD : 0;

                // DECOR CEREMONY
                $decor_ceremony_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129030000';
                })->first();
                // MTD
                $decor_ceremony['NAME'] = 'DECOR CEREMONY REVENUE';
                $decor_ceremony['ACTUAL_CURRENT'] = isset($decor_ceremony_data->ACTUAL_CURRENT_PERIOD) ? $decor_ceremony_data->ACTUAL_CURRENT_PERIOD : 0;
                $decor_ceremony['LAST_MONTH_CURRENT'] = isset($decor_ceremony_data->LAST_MONTH_CURRENT_PERIOD) ? $decor_ceremony_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $decor_ceremony['LAST_YEAR_CURRENT'] = isset($decor_ceremony_data->LAST_YEAR_CURRENT_PERIOD) ? $decor_ceremony_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $decor_ceremony['ACTUAL_YTD'] = isset($decor_ceremony_data->ACTUAL_YTD) ? $decor_ceremony_data->ACTUAL_YTD : 0;
                $decor_ceremony['LAST_MONTH_YTD'] = isset($decor_ceremony_data->LAST_MONTH_YTD) ? $decor_ceremony_data->LAST_MONTH_YTD : 0;
                $decor_ceremony['LAST_YEAR_YTD'] = isset($decor_ceremony_data->LAST_YEAR_YTD) ? $decor_ceremony_data->LAST_YEAR_YTD : 0;

                // ENTERTAINMENT
                $entertainment_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $entertainment['NAME'] = 'ENTERTAINMENT REVENUE';
                $entertainment['ACTUAL_CURRENT'] = isset($entertainment_data->ACTUAL_CURRENT_PERIOD) ? $entertainment_data->ACTUAL_CURRENT_PERIOD : 0;
                $entertainment['LAST_MONTH_CURRENT'] = isset($entertainment_data->LAST_MONTH_CURRENT_PERIOD) ? $entertainment_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $entertainment['LAST_YEAR_CURRENT'] = isset($entertainment_data->LAST_YEAR_CURRENT_PERIOD) ? $entertainment_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $entertainment['ACTUAL_YTD'] = isset($entertainment_data->ACTUAL_YTD) ? $entertainment_data->ACTUAL_YTD : 0;
                $entertainment['LAST_MONTH_YTD'] = isset($entertainment_data->LAST_MONTH_YTD) ? $entertainment_data->LAST_MONTH_YTD : 0;
                $entertainment['LAST_YEAR_YTD'] = isset($entertainment_data->LAST_YEAR_YTD) ? $entertainment_data->LAST_YEAR_YTD : 0;

                // FLOWER
                $flower_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129050000';
                })->first();
                // MTD
                $flower['NAME'] = 'FLOWER REVENUE';
                $flower['ACTUAL_CURRENT'] = isset($flower_data->ACTUAL_CURRENT_PERIOD) ? $flower_data->ACTUAL_CURRENT_PERIOD : 0;
                $flower['LAST_MONTH_CURRENT'] = isset($flower_data->LAST_MONTH_CURRENT_PERIOD) ? $flower_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $flower['LAST_YEAR_CURRENT'] = isset($flower_data->LAST_YEAR_CURRENT_PERIOD) ? $flower_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $flower['ACTUAL_YTD'] = isset($flower_data->ACTUAL_YTD) ? $flower_data->ACTUAL_YTD : 0;
                $flower['LAST_MONTH_YTD'] = isset($flower_data->LAST_MONTH_YTD) ? $flower_data->LAST_MONTH_YTD : 0;
                $flower['LAST_YEAR_YTD'] = isset($flower_data->LAST_YEAR_YTD) ? $flower_data->LAST_YEAR_YTD : 0;

                // MEETING ROOM RENTAL
                $meeting_room_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129060000';
                })->first();
                // MTD
                $meeting_room['NAME'] = 'MEETING ROOM REVENUE';
                $meeting_room['ACTUAL_CURRENT'] = isset($meeting_room_data->ACTUAL_CURRENT_PERIOD) ? $meeting_room_data->ACTUAL_CURRENT_PERIOD : 0;
                $meeting_room['LAST_MONTH_CURRENT'] = isset($meeting_room_data->LAST_MONTH_CURRENT_PERIOD) ? $meeting_room_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $meeting_room['LAST_YEAR_CURRENT'] = isset($meeting_room_data->LAST_YEAR_CURRENT_PERIOD) ? $meeting_room_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $meeting_room['ACTUAL_YTD'] = isset($meeting_room_data->ACTUAL_YTD) ? $meeting_room_data->ACTUAL_YTD : 0;
                $meeting_room['LAST_MONTH_YTD'] = isset($meeting_room_data->LAST_MONTH_YTD) ? $meeting_room_data->LAST_MONTH_YTD : 0;
                $meeting_room['LAST_YEAR_YTD'] = isset($meeting_room_data->LAST_YEAR_YTD) ? $meeting_room_data->LAST_YEAR_YTD : 0;

                // TOBACO
                $tobaco_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129070000';
                })->first();
                // MTD
                $tobaco['NAME'] = 'TOBACCO FNB REVENUE';
                $tobaco['ACTUAL_CURRENT'] = isset($tobaco_data->ACTUAL_CURRENT_PERIOD) ? $tobaco_data->ACTUAL_CURRENT_PERIOD : 0;
                $tobaco['LAST_MONTH_CURRENT'] = isset($tobaco_data->LAST_MONTH_CURRENT_PERIOD) ? $tobaco_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $tobaco['LAST_YEAR_CURRENT'] = isset($tobaco_data->LAST_YEAR_CURRENT_PERIOD) ? $tobaco_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $tobaco['ACTUAL_YTD'] = isset($tobaco_data->ACTUAL_YTD) ? $tobaco_data->ACTUAL_YTD : 0;
                $tobaco['LAST_MONTH_YTD'] = isset($tobaco_data->LAST_MONTH_YTD) ? $tobaco_data->LAST_MONTH_YTD : 0;
                $tobaco['LAST_YEAR_YTD'] = isset($tobaco_data->LAST_YEAR_YTD) ? $tobaco_data->LAST_YEAR_YTD : 0;

                // MISCELLANEOUS
                $miscellaneous_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129080000';
                })->first();
                // MTD
                $miscellaneous['NAME'] = 'MISCELLANEOUS REVENUE';
                $miscellaneous['ACTUAL_CURRENT'] = isset($miscellaneous_data->ACTUAL_CURRENT_PERIOD) ? $miscellaneous_data->ACTUAL_CURRENT_PERIOD : 0;
                $miscellaneous['LAST_MONTH_CURRENT'] = isset($miscellaneous_data->LAST_MONTH_CURRENT_PERIOD) ? $miscellaneous_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $miscellaneous['LAST_YEAR_CURRENT'] = isset($miscellaneous_data->LAST_YEAR_CURRENT_PERIOD) ? $miscellaneous_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $miscellaneous['ACTUAL_YTD'] = isset($miscellaneous_data->ACTUAL_YTD) ? $miscellaneous_data->ACTUAL_YTD : 0;
                $miscellaneous['LAST_MONTH_YTD'] = isset($miscellaneous_data->LAST_MONTH_YTD) ? $miscellaneous_data->LAST_MONTH_YTD : 0;
                $miscellaneous['LAST_YEAR_YTD'] = isset($miscellaneous_data->LAST_YEAR_YTD) ? $miscellaneous_data->LAST_YEAR_YTD : 0;

                // LOCAL
                $local_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $local['NAME'] = 'LOCAL REVENUE';
                $local['ACTUAL_CURRENT'] = isset($local_data->ACTUAL_CURRENT_PERIOD) ? $local_data->ACTUAL_CURRENT_PERIOD : 0;
                $local['LAST_MONTH_CURRENT'] = isset($local_data->LAST_MONTH_CURRENT_PERIOD) ? $local_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $local['LAST_YEAR_CURRENT'] = isset($local_data->LAST_YEAR_CURRENT_PERIOD) ? $local_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $local['ACTUAL_YTD'] = isset($local_data->ACTUAL_YTD) ? $local_data->ACTUAL_YTD : 0;
                $local['LAST_MONTH_YTD'] = isset($local_data->LAST_MONTH_YTD) ? $local_data->LAST_MONTH_YTD : 0;
                $local['LAST_YEAR_YTD'] = isset($local_data->LAST_YEAR_YTD) ? $local_data->LAST_YEAR_YTD : 0;

                // LONG DISTANCE
                $long_distance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4192020000';
                })->first();
                // MTD
                $long_distance['NAME'] = 'LONG DISTANCE REVENUE';
                $long_distance['ACTUAL_CURRENT'] = isset($long_distance_data->ACTUAL_CURRENT_PERIOD) ? $long_distance_data->ACTUAL_CURRENT_PERIOD : 0;
                $long_distance['LAST_MONTH_CURRENT'] = isset($long_distance_data->LAST_MONTH_CURRENT_PERIOD) ? $long_distance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $long_distance['LAST_YEAR_CURRENT'] = isset($long_distance_data->LAST_YEAR_CURRENT_PERIOD) ? $long_distance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $long_distance['ACTUAL_YTD'] = isset($long_distance_data->ACTUAL_YTD) ? $long_distance_data->ACTUAL_YTD : 0;
                $long_distance['LAST_MONTH_YTD'] = isset($long_distance_data->LAST_MONTH_YTD) ? $long_distance_data->LAST_MONTH_YTD : 0;
                $long_distance['LAST_YEAR_YTD'] = isset($long_distance_data->LAST_YEAR_YTD) ? $long_distance_data->LAST_YEAR_YTD : 0;

                // internet
                $internet_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $internet['NAME'] = 'INTERNET REVENUE';
                $internet['ACTUAL_CURRENT'] = isset($internet_data->ACTUAL_CURRENT_PERIOD) ? $internet_data->ACTUAL_CURRENT_PERIOD : 0;
                $internet['LAST_MONTH_CURRENT'] = isset($internet_data->LAST_MONTH_CURRENT_PERIOD) ? $internet_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $internet['LAST_YEAR_CURRENT'] = isset($internet_data->LAST_YEAR_CURRENT_PERIOD) ? $internet_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $internet['ACTUAL_YTD'] = isset($internet_data->ACTUAL_YTD) ? $internet_data->ACTUAL_YTD : 0;
                $internet['LAST_MONTH_YTD'] = isset($internet_data->LAST_MONTH_YTD) ? $internet_data->LAST_MONTH_YTD : 0;
                $internet['LAST_YEAR_YTD'] = isset($internet_data->LAST_YEAR_YTD) ? $internet_data->LAST_YEAR_YTD : 0;

                // internet
                $allowance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199990000';
                })->first();
                // MTD
                $allowance['NAME'] = 'ALLOWANCE - COMM - REVENUE';
                $allowance['ACTUAL_CURRENT'] = isset($allowance_data->ACTUAL_CURRENT_PERIOD) ? $allowance_data->ACTUAL_CURRENT_PERIOD : 0;
                $allowance['LAST_MONTH_CURRENT'] = isset($allowance_data->LAST_MONTH_CURRENT_PERIOD) ? $allowance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $allowance['LAST_YEAR_CURRENT'] = isset($allowance_data->LAST_YEAR_CURRENT_PERIOD) ? $allowance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $allowance['ACTUAL_YTD'] = isset($allowance_data->ACTUAL_YTD) ? $allowance_data->ACTUAL_YTD : 0;
                $allowance['LAST_MONTH_YTD'] = isset($allowance_data->LAST_MONTH_YTD) ? $allowance_data->LAST_MONTH_YTD : 0;
                $allowance['LAST_YEAR_YTD'] = isset($allowance_data->LAST_YEAR_YTD) ? $allowance_data->LAST_YEAR_YTD : 0;

                $GL_pair_cost_sales_other_revenue = array(
                    '5111010100'=>$food_revenue_total,
                    '5111010300'=>$liquor,
                    '5111010400'=>$wine,
                    '5111010200'=>$beer,
                    '5111030100'=>$audio_visual,
                    '5111030200'=>$decor_ceremony,
                    '5111030300'=>$entertainment,
                    '5121110200'=>[],
                    '5111039900'=>$miscellaneous,
                    '5111030400'=>$meeting_room,
                    '5111030600'=>$tobaco,
                );

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['REV']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['REV']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($grouping_data['B']['DATA']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $grouping_data['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $grouping_data['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $grouping_data['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $grouping_data['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $grouping_data['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $grouping_data['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($grouping_data['B']['DATA']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $grouping_data['B']['DATA']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $grouping_data['B']['DATA']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($grouping_data['B']['DATA']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $grouping_data['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $grouping_data['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($grouping_data['B']['DATA']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $grouping_data['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $grouping_data['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;

        }
        
        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        $collection_data['GROUPING'][$array_name] = isset($grouping_data) ? $grouping_data : [];

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;
        // Kode A untuk total Payroll
        // Kode B untuk total Revenue
        // // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) && isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0;
        // }
        // MTD
        $departmental_actual_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0) ;
        $departmental_actual_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0) ;
        $departmental_last_month_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0) ;
        $departmental_last_year_current_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_CURRENT']) * 100 : 0;

        // YTD
        $departmental_actual_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0) ;
        $departmental_actual_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0) ;
        $departmental_last_month_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0) ;
        $departmental_last_year_ytd_pctg = isset($collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) && $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['GROUPING'][$array_name]['B']['DATA']['LAST_YEAR_YTD']) * 100 : 0; 
        

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        // dd($collection);
        return $collection;
    }


    public function fnb_rev_grouping_process($collection_data, $array_name, $month=null, $year=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            // dd($collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE'));
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG masing" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'FBR'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0)
                            // $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // MENCARI FOOD REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['FDR']['DATA_CATEGORY'])){
            $collection_data['FDR']['DATA_CATEGORY'] = collect($collection_data['FDR']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['FDR']['SUM_CATEGORY'])){
            // MTD
            $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI FOOD REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        
        // MENCARI BEVERAGE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['BVR']['DATA_CATEGORY'])){
            $collection_data['BVR']['DATA_CATEGORY'] = collect($collection_data['BVR']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BVR']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI BEVERAGE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI COST OF SALES PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){

                $food_revenue_total = array(
                    // MTD
                    "NAME"=>"FOOD_REVENUE_TOTAL",
                    "ACTUAL_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0,
                    "LAST_MONTH_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0,
                    "LAST_YEAR_CURRENT"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0,

                    // YTD
                    "ACTUAL_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['ACTUAL_YTD'] : 0,
                    "LAST_MONTH_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0,
                    "LAST_YEAR_YTD"=>isset($collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['FDR']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0
                );

                $beverage_revenue_total = array(
                    // MTD
                    "NAME"=>"BEVERAGE_REVENUE_TOTAL",
                    "ACTUAL_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0,
                    "LAST_MONTH_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0,
                    "LAST_YEAR_CURRENT"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0,

                    // YTD
                    "ACTUAL_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['ACTUAL_YTD'] : 0,
                    "LAST_MONTH_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0,
                    "LAST_YEAR_YTD"=>isset($collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['BVR']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0
                );

                // Liquor
                $liquor_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['BVR']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122020100';
                })->first();
                // MTD
                $liquor['NAME'] = 'LIQUOR REVENUE';
                $liquor['ACTUAL_CURRENT'] = isset($liquor_data->ACTUAL_CURRENT_PERIOD) ? $liquor_data->ACTUAL_CURRENT_PERIOD : 0;
                $liquor['LAST_MONTH_CURRENT'] = isset($liquor_data->LAST_MONTH_CURRENT_PERIOD) ? $liquor_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $liquor['LAST_YEAR_CURRENT'] = isset($liquor_data->LAST_YEAR_CURRENT_PERIOD) ? $liquor_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $liquor['ACTUAL_YTD'] = isset($liquor_data->ACTUAL_YTD) ? $liquor_data->ACTUAL_YTD : 0;
                $liquor['LAST_MONTH_YTD'] = isset($liquor_data->LAST_MONTH_YTD) ? $liquor_data->LAST_MONTH_YTD : 0;
                $liquor['LAST_YEAR_YTD'] = isset($liquor_data->LAST_YEAR_YTD) ? $liquor_data->LAST_YEAR_YTD : 0;

                // WINE
                $wine_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['BVR']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122030100';
                })->first();
                // MTD
                $wine['NAME'] = 'WINE REVENUE';
                $wine['ACTUAL_CURRENT'] = isset($wine_data->ACTUAL_CURRENT_PERIOD) ? $wine_data->ACTUAL_CURRENT_PERIOD : 0;
                $wine['LAST_MONTH_CURRENT'] = isset($wine_data->LAST_MONTH_CURRENT_PERIOD) ? $wine_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $wine['LAST_YEAR_CURRENT'] = isset($wine_data->LAST_YEAR_CURRENT_PERIOD) ? $wine_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $wine['ACTUAL_YTD'] = isset($wine_data->ACTUAL_YTD) ? $wine_data->ACTUAL_YTD : 0;
                $wine['LAST_MONTH_YTD'] = isset($wine_data->LAST_MONTH_YTD) ? $wine_data->LAST_MONTH_YTD : 0;
                $wine['LAST_YEAR_YTD'] = isset($wine_data->LAST_YEAR_YTD) ? $wine_data->LAST_YEAR_YTD : 0;

                // BEER
                $beer_data = collect(isset($collection_data['BVR']['DATA_CATEGORY']) ? $collection_data['BVR']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4122010100';
                })->first();
                // MTD
                $beer['NAME'] = 'BEER REVENUE';
                $beer['ACTUAL_CURRENT'] = isset($beer_data->ACTUAL_CURRENT_PERIOD) ? $beer_data->ACTUAL_CURRENT_PERIOD : 0;
                $beer['LAST_MONTH_CURRENT'] = isset($beer_data->LAST_MONTH_CURRENT_PERIOD) ? $beer_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $beer['LAST_YEAR_CURRENT'] = isset($beer_data->LAST_YEAR_CURRENT_PERIOD) ? $beer_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $beer['ACTUAL_YTD'] = isset($beer_data->ACTUAL_YTD) ? $beer_data->ACTUAL_YTD : 0;
                $beer['LAST_MONTH_YTD'] = isset($beer_data->LAST_MONTH_YTD) ? $beer_data->LAST_MONTH_YTD : 0;
                $beer['LAST_YEAR_YTD'] = isset($beer_data->LAST_YEAR_YTD) ? $beer_data->LAST_YEAR_YTD : 0;

                // AUDIO VISUAL
                $audio_visual_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129020000';
                })->first();
                // MTD
                $audio_visual['NAME'] = 'AUDIO VISUAL REVENUE';
                $audio_visual['ACTUAL_CURRENT'] = isset($audio_visual_data->ACTUAL_CURRENT_PERIOD) ? $audio_visual_data->ACTUAL_CURRENT_PERIOD : 0;
                $audio_visual['LAST_MONTH_CURRENT'] = isset($audio_visual_data->LAST_MONTH_CURRENT_PERIOD) ? $audio_visual_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $audio_visual['LAST_YEAR_CURRENT'] = isset($audio_visual_data->LAST_YEAR_CURRENT_PERIOD) ? $audio_visual_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $audio_visual['ACTUAL_YTD'] = isset($audio_visual_data->ACTUAL_YTD) ? $audio_visual_data->ACTUAL_YTD : 0;
                $audio_visual['LAST_MONTH_YTD'] = isset($audio_visual_data->LAST_MONTH_YTD) ? $audio_visual_data->LAST_MONTH_YTD : 0;
                $audio_visual['LAST_YEAR_YTD'] = isset($audio_visual_data->LAST_YEAR_YTD) ? $audio_visual_data->LAST_YEAR_YTD : 0;

                // DECOR CEREMONY
                $decor_ceremony_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129030000';
                })->first();
                // MTD
                $decor_ceremony['NAME'] = 'DECOR CEREMONY REVENUE';
                $decor_ceremony['ACTUAL_CURRENT'] = isset($decor_ceremony_data->ACTUAL_CURRENT_PERIOD) ? $decor_ceremony_data->ACTUAL_CURRENT_PERIOD : 0;
                $decor_ceremony['LAST_MONTH_CURRENT'] = isset($decor_ceremony_data->LAST_MONTH_CURRENT_PERIOD) ? $decor_ceremony_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $decor_ceremony['LAST_YEAR_CURRENT'] = isset($decor_ceremony_data->LAST_YEAR_CURRENT_PERIOD) ? $decor_ceremony_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $decor_ceremony['ACTUAL_YTD'] = isset($decor_ceremony_data->ACTUAL_YTD) ? $decor_ceremony_data->ACTUAL_YTD : 0;
                $decor_ceremony['LAST_MONTH_YTD'] = isset($decor_ceremony_data->LAST_MONTH_YTD) ? $decor_ceremony_data->LAST_MONTH_YTD : 0;
                $decor_ceremony['LAST_YEAR_YTD'] = isset($decor_ceremony_data->LAST_YEAR_YTD) ? $decor_ceremony_data->LAST_YEAR_YTD : 0;

                // ENTERTAINMENT
                $entertainment_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $entertainment['NAME'] = 'ENTERTAINMENT REVENUE';
                $entertainment['ACTUAL_CURRENT'] = isset($entertainment_data->ACTUAL_CURRENT_PERIOD) ? $entertainment_data->ACTUAL_CURRENT_PERIOD : 0;
                $entertainment['LAST_MONTH_CURRENT'] = isset($entertainment_data->LAST_MONTH_CURRENT_PERIOD) ? $entertainment_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $entertainment['LAST_YEAR_CURRENT'] = isset($entertainment_data->LAST_YEAR_CURRENT_PERIOD) ? $entertainment_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $entertainment['ACTUAL_YTD'] = isset($entertainment_data->ACTUAL_YTD) ? $entertainment_data->ACTUAL_YTD : 0;
                $entertainment['LAST_MONTH_YTD'] = isset($entertainment_data->LAST_MONTH_YTD) ? $entertainment_data->LAST_MONTH_YTD : 0;
                $entertainment['LAST_YEAR_YTD'] = isset($entertainment_data->LAST_YEAR_YTD) ? $entertainment_data->LAST_YEAR_YTD : 0;

                // FLOWER
                $flower_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129050000';
                })->first();
                // MTD
                $flower['NAME'] = 'FLOWER REVENUE';
                $flower['ACTUAL_CURRENT'] = isset($flower_data->ACTUAL_CURRENT_PERIOD) ? $flower_data->ACTUAL_CURRENT_PERIOD : 0;
                $flower['LAST_MONTH_CURRENT'] = isset($flower_data->LAST_MONTH_CURRENT_PERIOD) ? $flower_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $flower['LAST_YEAR_CURRENT'] = isset($flower_data->LAST_YEAR_CURRENT_PERIOD) ? $flower_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $flower['ACTUAL_YTD'] = isset($flower_data->ACTUAL_YTD) ? $flower_data->ACTUAL_YTD : 0;
                $flower['LAST_MONTH_YTD'] = isset($flower_data->LAST_MONTH_YTD) ? $flower_data->LAST_MONTH_YTD : 0;
                $flower['LAST_YEAR_YTD'] = isset($flower_data->LAST_YEAR_YTD) ? $flower_data->LAST_YEAR_YTD : 0;

                // MEETING ROOM RENTAL
                $meeting_room_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129060000';
                })->first();
                // MTD
                $meeting_room['NAME'] = 'MEETING ROOM REVENUE';
                $meeting_room['ACTUAL_CURRENT'] = isset($meeting_room_data->ACTUAL_CURRENT_PERIOD) ? $meeting_room_data->ACTUAL_CURRENT_PERIOD : 0;
                $meeting_room['LAST_MONTH_CURRENT'] = isset($meeting_room_data->LAST_MONTH_CURRENT_PERIOD) ? $meeting_room_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $meeting_room['LAST_YEAR_CURRENT'] = isset($meeting_room_data->LAST_YEAR_CURRENT_PERIOD) ? $meeting_room_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $meeting_room['ACTUAL_YTD'] = isset($meeting_room_data->ACTUAL_YTD) ? $meeting_room_data->ACTUAL_YTD : 0;
                $meeting_room['LAST_MONTH_YTD'] = isset($meeting_room_data->LAST_MONTH_YTD) ? $meeting_room_data->LAST_MONTH_YTD : 0;
                $meeting_room['LAST_YEAR_YTD'] = isset($meeting_room_data->LAST_YEAR_YTD) ? $meeting_room_data->LAST_YEAR_YTD : 0;

                // TOBACO
                $tobaco_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129070000';
                })->first();
                // MTD
                $tobaco['NAME'] = 'TOBACCO FNB REVENUE';
                $tobaco['ACTUAL_CURRENT'] = isset($tobaco_data->ACTUAL_CURRENT_PERIOD) ? $tobaco_data->ACTUAL_CURRENT_PERIOD : 0;
                $tobaco['LAST_MONTH_CURRENT'] = isset($tobaco_data->LAST_MONTH_CURRENT_PERIOD) ? $tobaco_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $tobaco['LAST_YEAR_CURRENT'] = isset($tobaco_data->LAST_YEAR_CURRENT_PERIOD) ? $tobaco_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $tobaco['ACTUAL_YTD'] = isset($tobaco_data->ACTUAL_YTD) ? $tobaco_data->ACTUAL_YTD : 0;
                $tobaco['LAST_MONTH_YTD'] = isset($tobaco_data->LAST_MONTH_YTD) ? $tobaco_data->LAST_MONTH_YTD : 0;
                $tobaco['LAST_YEAR_YTD'] = isset($tobaco_data->LAST_YEAR_YTD) ? $tobaco_data->LAST_YEAR_YTD : 0;

                // MISCELLANEOUS
                $miscellaneous_data = collect(isset($collection_data['OTH']['DATA_CATEGORY']) ? $collection_data['OTH']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $miscellaneous['NAME'] = 'MISCELLANEOUS REVENUE';
                $miscellaneous['ACTUAL_CURRENT'] = isset($miscellaneous_data->ACTUAL_CURRENT_PERIOD) ? $miscellaneous_data->ACTUAL_CURRENT_PERIOD : 0;
                $miscellaneous['LAST_MONTH_CURRENT'] = isset($miscellaneous_data->LAST_MONTH_CURRENT_PERIOD) ? $miscellaneous_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $miscellaneous['LAST_YEAR_CURRENT'] = isset($miscellaneous_data->LAST_YEAR_CURRENT_PERIOD) ? $miscellaneous_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $miscellaneous['ACTUAL_YTD'] = isset($miscellaneous_data->ACTUAL_YTD) ? $miscellaneous_data->ACTUAL_YTD : 0;
                $miscellaneous['LAST_MONTH_YTD'] = isset($miscellaneous_data->LAST_MONTH_YTD) ? $miscellaneous_data->LAST_MONTH_YTD : 0;
                $miscellaneous['LAST_YEAR_YTD'] = isset($miscellaneous_data->LAST_YEAR_YTD) ? $miscellaneous_data->LAST_YEAR_YTD : 0;

                // LOCAL
                $local_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $local['NAME'] = 'LOCAL REVENUE';
                $local['ACTUAL_CURRENT'] = isset($local_data->ACTUAL_CURRENT_PERIOD) ? $local_data->ACTUAL_CURRENT_PERIOD : 0;
                $local['LAST_MONTH_CURRENT'] = isset($local_data->LAST_MONTH_CURRENT_PERIOD) ? $local_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $local['LAST_YEAR_CURRENT'] = isset($local_data->LAST_YEAR_CURRENT_PERIOD) ? $local_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $local['ACTUAL_YTD'] = isset($local_data->ACTUAL_YTD) ? $local_data->ACTUAL_YTD : 0;
                $local['LAST_MONTH_YTD'] = isset($local_data->LAST_MONTH_YTD) ? $local_data->LAST_MONTH_YTD : 0;
                $local['LAST_YEAR_YTD'] = isset($local_data->LAST_YEAR_YTD) ? $local_data->LAST_YEAR_YTD : 0;

                // LONG DISTANCE
                $long_distance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4192020000';
                })->first();
                // MTD
                $long_distance['NAME'] = 'LONG DISTANCE REVENUE';
                $long_distance['ACTUAL_CURRENT'] = isset($long_distance_data->ACTUAL_CURRENT_PERIOD) ? $long_distance_data->ACTUAL_CURRENT_PERIOD : 0;
                $long_distance['LAST_MONTH_CURRENT'] = isset($long_distance_data->LAST_MONTH_CURRENT_PERIOD) ? $long_distance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $long_distance['LAST_YEAR_CURRENT'] = isset($long_distance_data->LAST_YEAR_CURRENT_PERIOD) ? $long_distance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $long_distance['ACTUAL_YTD'] = isset($long_distance_data->ACTUAL_YTD) ? $long_distance_data->ACTUAL_YTD : 0;
                $long_distance['LAST_MONTH_YTD'] = isset($long_distance_data->LAST_MONTH_YTD) ? $long_distance_data->LAST_MONTH_YTD : 0;
                $long_distance['LAST_YEAR_YTD'] = isset($long_distance_data->LAST_YEAR_YTD) ? $long_distance_data->LAST_YEAR_YTD : 0;

                // internet
                $internet_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4129040000';
                })->first();
                // MTD
                $internet['NAME'] = 'INTERNET REVENUE';
                $internet['ACTUAL_CURRENT'] = isset($internet_data->ACTUAL_CURRENT_PERIOD) ? $internet_data->ACTUAL_CURRENT_PERIOD : 0;
                $internet['LAST_MONTH_CURRENT'] = isset($internet_data->LAST_MONTH_CURRENT_PERIOD) ? $internet_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $internet['LAST_YEAR_CURRENT'] = isset($internet_data->LAST_YEAR_CURRENT_PERIOD) ? $internet_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $internet['ACTUAL_YTD'] = isset($internet_data->ACTUAL_YTD) ? $internet_data->ACTUAL_YTD : 0;
                $internet['LAST_MONTH_YTD'] = isset($internet_data->LAST_MONTH_YTD) ? $internet_data->LAST_MONTH_YTD : 0;
                $internet['LAST_YEAR_YTD'] = isset($internet_data->LAST_YEAR_YTD) ? $internet_data->LAST_YEAR_YTD : 0;

                // internet
                $allowance_data = collect(isset($collection_data['REV']['DATA_CATEGORY']) ? $collection_data['REV']['DATA_CATEGORY'] : [])->filter(function($item, $key){
                    return $item->SAP_COA == '4199990000';
                })->first();
                // MTD
                $allowance['NAME'] = 'ALLOWANCE - COMM - REVENUE';
                $allowance['ACTUAL_CURRENT'] = isset($allowance_data->ACTUAL_CURRENT_PERIOD) ? $allowance_data->ACTUAL_CURRENT_PERIOD : 0;
                $allowance['LAST_MONTH_CURRENT'] = isset($allowance_data->LAST_MONTH_CURRENT_PERIOD) ? $allowance_data->LAST_MONTH_CURRENT_PERIOD : 0;
                $allowance['LAST_YEAR_CURRENT'] = isset($allowance_data->LAST_YEAR_CURRENT_PERIOD) ? $allowance_data->LAST_YEAR_CURRENT_PERIOD : 0;
                // YTD
                $allowance['ACTUAL_YTD'] = isset($allowance_data->ACTUAL_YTD) ? $allowance_data->ACTUAL_YTD : 0;
                $allowance['LAST_MONTH_YTD'] = isset($allowance_data->LAST_MONTH_YTD) ? $allowance_data->LAST_MONTH_YTD : 0;
                $allowance['LAST_YEAR_YTD'] = isset($allowance_data->LAST_YEAR_YTD) ? $allowance_data->LAST_YEAR_YTD : 0;

                $GL_pair_cost_sales_other_revenue = array(
                    '5111010100'=>$food_revenue_total,
                    '5111010300'=>$liquor,
                    '5111010400'=>$wine,
                    '5111010200'=>$beer,
                    '5111030100'=>$audio_visual,
                    '5111030200'=>$decor_ceremony,
                    '5111030300'=>$entertainment,
                    '5121110200'=>[],
                    '5111039900'=>$miscellaneous,
                    '5111030400'=>$meeting_room,
                    '5111030600'=>$tobaco,
                );

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    // MTD
                    if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                        $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    }
                    if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                        $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    }
                    if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                        $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                    }

                    // YTD
                    if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                        $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    }
                    if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                        $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    }
                    if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                        $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                    }
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI COST OF SALES REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI SALARY REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI SALARY REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI BENEFIT REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI BENEFIT REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // MENCARI OTHER EXPENSE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }

                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END MENCARI OTHER EXPENSE REVENUE PCTG DIBANDINGKAN DENGAN F&B REVENUE OUTLET

        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;

        /* Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT) */
        // $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
        //     // SUM MTD
        //     $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
        //     $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
        //     $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
        //     $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
        //     // SUM YTD
        //     $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
        //     $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
        //     $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
        //     $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

        //     $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
        //     return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        // })->toArray();
        $obj = $this;
        $collect_data = $collection_data;
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key) use ($obj, $collect_data, $array_name){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $collection_data = $obj->grouping_pctg_process($collection_data, $collect_data, $array_name, $key);
            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // MTD
        if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
            // Department actual current
            $departmental_actual_current = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? 
            $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;

            // Department actual current pctg
            $departmental_actual_current_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        }

        if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
            $departmental_last_month_current = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? 
            $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;

            $departmental_last_month_current_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        }
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
            $departmental_last_year_current = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? 
            $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;

            $departmental_last_year_current_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        }

        // YTD
        if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
            $departmental_actual_ytd = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? 
            $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;

            $departmental_actual_ytd_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_current / $collection_data['FBR']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

        }
        if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
            $departmental_last_month_ytd = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? 
            $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;

            $departmental_last_month_ytd_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_current / $collection_data['FBR']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

        }
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
            $departmental_last_year_ytd = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? 
            $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;

            $departmental_last_year_ytd_pctg = isset($collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['FBR']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];
        // dd($collection);
        return $collection;
    }

    public function room_grouping_process($collection_data, $array_name, $month=null, $year=null, $company=null){
        $grouping_arj = [];
        $collection = [];
        if(count($collection_data)){
            $collection_data = collect($collection_data)->groupBy('CAT_REPORT_CODE')->filter()
            ->mapWithKeys(function($item, $key) use (&$grouping_arj){
                // SUM MTD
                $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                // SUM YTD
                $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                // Percentage each category againts total summary
                $category = collect($item)->mapWithKeys(function($item, $key) use ($collection_data, &$grouping_arj){
                    // INI loop untuk total PCTG masing" ITEM
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Jika revenue bukan sama dengan Expenses, maka dibagi dirinya sendiri, jika expense dibagi dengan SALES & INCOME
                    $type_revenue = isset($item->CAT_REPORT_CODE) ? strtoupper($item->CAT_REPORT_CODE) : '-';
                    if($type_revenue == 'SIN'){
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if($collection_data['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['ACTUAL_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_MONTH_CURRENT'] != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $collection_data['LAST_MONTH_CURRENT']) * 100 : 0;
                        if($collection_data['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if($collection_data['ACTUAL_YTD'] != 0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $collection_data['ACTUAL_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_MONTH_YTD'] != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $collection_data['LAST_MONTH_YTD']) * 100 : 0;
                        if($collection_data['LAST_YEAR_YTD'] != 0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $collection_data['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    if(isset($item->GROUPING_YN) && $item->GROUPING_YN)
                        array_push($grouping_arj, $item);

                    return [$key=>$item];
                });
                
                // INI loop untuk total ALL Item di kategori tertentu
                // SUM MTD PCTG
                $collection_data['ACTUAL_CURRENT_PCTG'] = $item->sum('ACTUAL_CURRENT_PCTG');
                $collection_data['LAST_MONTH_CURRENT_PCTG'] = $item->sum('LAST_MONTH_CURRENT_PCTG');
                $collection_data['VARIANCE_CURRENT_PCTG'] = 0;
                if($collection_data['LAST_MONTH_CURRENT'] != 0)
                    $collection_data['VARIANCE_CURRENT_PCTG'] = ($collection_data['VARIANCE_CURRENT'] / $collection_data['LAST_MONTH_CURRENT']) * 100;
                $collection_data['LAST_YEAR_CURRENT_PCTG'] = $item->sum('LAST_YEAR_CURRENT_PCTG');

                // SUM YTD PCTG
                $collection_data['ACTUAL_YTD_PCTG'] = $item->sum('ACTUAL_YTD_PCTG');
                $collection_data['LAST_MONTH_YTD_PCTG'] = $item->sum('LAST_MONTH_YTD_PCTG');
                $collection_data['VARIANCE_YTD_PCTG'] = 0;
                if($collection_data['LAST_MONTH_YTD'] != 0)
                    $collection_data['VARIANCE_YTD_PCTG'] = ($collection_data['VARIANCE_YTD'] / $collection_data['LAST_MONTH_YTD']) * 100;
                $collection_data['LAST_YEAR_YTD_PCTG'] = $item->sum('LAST_YEAR_YTD_PCTG');

                // return [$key=>array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$collection_data)];
                return [$key=>array('DATA_CATEGORY'=>$category->toArray(), 'SUM_CATEGORY'=>$collection_data)];
            })->toArray();
        }

        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['OEX']['DATA_CATEGORY'])){
            $collection_data['OEX']['DATA_CATEGORY'] = collect($collection_data['OEX']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['OEX']['SUM_CATEGORY'])){
            // MTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        
        // Pisahkan Expense persentase karena hanya expense yang dibagi sales income
        if(isset($collection_data['SLW']['DATA_CATEGORY'])){
            $collection_data['SLW']['DATA_CATEGORY'] = collect($collection_data['SLW']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['SLW']['SUM_CATEGORY'])){
            // MTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['SLW']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }
        // END Pisahkan Expense persentase karena hanya expense yang dibagi sales income

        if(isset($collection_data['BNF']['DATA_CATEGORY'])){
            $collection_data['BNF']['DATA_CATEGORY'] = collect($collection_data['BNF']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){
                // MTD
                if(isset($item->ACTUAL_CURRENT_PCTG) && $item->ACTUAL_CURRENT_PERIOD){
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_CURRENT_PCTG) && $item->LAST_MONTH_CURRENT_PERIOD){
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_CURRENT_PCTG) && $item->LAST_YEAR_CURRENT_PERIOD){
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 
                }

                // YTD
                if(isset($item->ACTUAL_YTD_PCTG) && $item->ACTUAL_YTD){
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_MONTH_YTD_PCTG) && $item->LAST_MONTH_YTD){
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                }
                if(isset($item->LAST_YEAR_YTD_PCTG) && $item->LAST_YEAR_YTD){
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['BNF']['SUM_CATEGORY'])){
            // MTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['BNF']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }


        if(isset($collection_data['COS']['DATA_CATEGORY'])){
            $collection_data['COS']['DATA_CATEGORY'] = collect($collection_data['COS']['DATA_CATEGORY'])->map(function($item, $key) use (&$collection_data){

                $GL_pair_cost_sales_other_revenue = array();

                // MTD
                if(isset($item->SAP_COA) && in_array($item->SAP_COA, array_keys($GL_pair_cost_sales_other_revenue))){
                    // dd($item,$GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']);
                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_CURRENT']) * 100 : 0;
                    $item->LAST_MONTH_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_CURRENT']) * 100 : 0;
                    
                    $item->LAST_YEAR_CURRENT_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_MONTH_YTD']) * 100 : 0;
                    $item->LAST_YEAR_YTD_PCTG = isset($GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) && $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $GL_pair_cost_sales_other_revenue[$item->SAP_COA]['LAST_YEAR_YTD']) * 100 : 0; 
                }
                else {
                    $item->ACTUAL_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($item->ACTUAL_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0; 
                    $item->LAST_MONTH_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($item->LAST_MONTH_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0; 
                    $item->LAST_YEAR_CURRENT_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($item->LAST_YEAR_CURRENT_PERIOD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0; 

                    // YTD
                    $item->ACTUAL_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($item->ACTUAL_YTD / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0; 
                    $item->LAST_MONTH_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($item->LAST_MONTH_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0; 
                    $item->LAST_YEAR_YTD_PCTG = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($item->LAST_YEAR_YTD / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0; 
                }

                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0){
                    $item->VARIANCE_CURRENT_PCTG = ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100;
                }
                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0){
                    $item->VARIANCE_YTD_PCTG = ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100;
                }

                return $item;
            })->toArray();
        }

        if(isset($collection_data['COS']['SUM_CATEGORY'])){
            // MTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;

            $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD_PCTG'] = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        }

        // Insert Room to collection baru
        $collection[$array_name] = $collection_data;
        /* Mulai Grouping total kategori (Saat ini hanya tersedia Payroll -> SALARY WAGES & BENEFIT) */
        // $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key){
        //     // SUM MTD
        //     $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
        //     $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
        //     $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
        //     $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
        //     // SUM YTD
        //     $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
        //     $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
        //     $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
        //     $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

        //     $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
        //     return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        // })->toArray();
        $obj = $this;
        $collect_data = $collection_data;
        $collection_data['GROUPING'][$array_name] = collect($grouping_arj)->groupBy('GROUPING_YN')->mapWithKeys(function($item, $key) use ($obj, $collect_data, $array_name){
            // SUM MTD
            $collection_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
            $collection_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
            $collection_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
            $collection_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
            // SUM YTD
            $collection_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
            $collection_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
            $collection_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
            $collection_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

            $collection_data = $obj->grouping_pctg_process($collection_data, $collect_data, $array_name, $key);
            $group_desc = isset($item[0]->GROUPING_DESC) ? $item[0]->GROUPING_DESC : '-';
            return [$key=>array("GROUPING_DESC"=>$group_desc,"DATA"=>$collection_data,"SHOW_AFTER"=>(count($item)))];
        })->toArray();

        $departmental_actual_current = 0;
        $departmental_actual_current_pctg = 0;
        $departmental_last_month_current = 0;
        $departmental_last_month_current_pctg = 0;
        $departmental_variance_current = 0;
        $departmental_variance_current_pctg = 0;
        $departmental_last_year_current = 0;
        $departmental_last_year_current_pctg = 0;

        $departmental_actual_ytd = 0;
        $departmental_actual_ytd_pctg = 0;
        $departmental_last_month_ytd = 0;
        $departmental_last_month_ytd_pctg = 0;
        $departmental_variance_ytd = 0;
        $departmental_variance_ytd_pctg = 0;
        $departmental_last_year_ytd = 0;
        $departmental_last_year_ytd_pctg = 0;

        // Kode A untuk total Payroll
        // // MTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'])){
        //     $departmental_actual_current = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] ? $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
        //     $departmental_actual_current_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        // }

        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'])){
        //     $departmental_last_month_current = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] ? $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
        //     $departmental_last_month_current_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        // }
        // $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        // $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'])){
        //     $departmental_last_year_current = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] ? $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;
        //     $departmental_last_year_current_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 ? ($departmental_last_year_current / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;
        // }

        // // YTD
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'])){
        //     $departmental_actual_ytd = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] ? $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
        //     $departmental_actual_ytd_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        // }
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'])){
        //     $departmental_last_month_ytd = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] ? $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
        //     $departmental_last_month_ytd_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        // }
        // $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        // $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        // if(isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'])){
        //     $departmental_last_year_ytd = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] ? $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] - $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] - $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
        //     $departmental_last_year_ytd_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        // }
         
        // MTD
        $departmental_actual_current = (isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_CURRENT'] : 0);
        $departmental_actual_current_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 ? ($departmental_actual_current / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $departmental_last_month_current = (isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_CURRENT'] : 0);
        $departmental_last_month_current_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 ? ($departmental_last_month_current / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $departmental_variance_current = $departmental_actual_current - $departmental_last_month_current;
        $departmental_variance_current_pctg = $departmental_last_month_current != 0 ? ($departmental_variance_current / $departmental_last_month_current) * 100 : 0;
        $departmental_last_year_current = (isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_CURRENT'] : 0);

        // YTD
        $departmental_actual_ytd = (isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['ACTUAL_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['ACTUAL_YTD'] : 0);
        $departmental_actual_ytd_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 ? ($departmental_actual_ytd / $collection_data['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $departmental_last_month_ytd = (isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_MONTH_YTD'] : 0);
        $departmental_last_month_ytd_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 ? ($departmental_last_month_ytd / $collection_data['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $departmental_variance_ytd = $departmental_actual_ytd - $departmental_last_month_ytd;
        $departmental_variance_ytd_pctg = $departmental_last_month_ytd != 0 ? ($departmental_variance_ytd / $departmental_last_month_ytd) * 100 : 0;
        $departmental_last_year_ytd = (isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['OEX']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data['COS']['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0) - (isset($collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD']) ? $collection_data['GROUPING'][$array_name]['A']['DATA']['LAST_YEAR_YTD'] : 0);
        $departmental_last_year_ytd_pctg = isset($collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 ? ($departmental_last_year_ytd / $collection_data['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;

        $collection_data["DEPARTMENTAL_PROFIT"] = array(
            // MTD
            'ACTUAL_CURRENT' => $departmental_actual_current,
            'ACTUAL_CURRENT_PCTG' => $departmental_actual_current_pctg,
            'LAST_MONTH_CURRENT' => $departmental_last_month_current,
            'LAST_MONTH_CURRENT_PCTG' => $departmental_last_month_current_pctg,
            'VARIANCE_CURRENT' => $departmental_variance_current,
            'VARIANCE_CURRENT_PCTG' => $departmental_variance_current_pctg,
            'LAST_YEAR_CURRENT' => $departmental_last_year_current,
            'LAST_YEAR_CURRENT_PCTG' => $departmental_last_year_current_pctg,

            // YTD
            'ACTUAL_YTD' => $departmental_actual_ytd,
            'ACTUAL_YTD_PCTG' => $departmental_actual_ytd_pctg,
            'LAST_MONTH_YTD' => $departmental_last_month_ytd,
            'LAST_MONTH_YTD_PCTG' => $departmental_last_month_ytd_pctg,
            'VARIANCE_YTD' => $departmental_variance_ytd,
            'VARIANCE_YTD_PCTG' => $departmental_variance_ytd_pctg,
            'LAST_YEAR_YTD' => $departmental_last_year_ytd,
            'LAST_YEAR_YTD_PCTG' => $departmental_last_year_ytd_pctg

        );
        $collection['GROUPING'][$array_name] = $collection_data['GROUPING'][$array_name];
        $collection['DEPARTMENTAL_PROFIT'] = $collection_data["DEPARTMENTAL_PROFIT"];

        // Untuk room STATISTIC
        if($month && $year && $company){
            // Start Statistic Room
            $collection['ROOM_STATISTIC']['CATEGORY'] = array(
                'Occupied Average Rate'=>array(
                    'ACTUAL_CURRENT' => 0,
                    'LAST_MONTH_CURRENT'=>0,
                    'VARIANCE_CURRENT'=>0,
                    'VARIANCE_CURRENT_PCTG'=>0,
                    'LAST_YEAR_CURRENT'=>0,
                    'ACTUAL_YTD' => 0,
                    'LAST_MONTH_YTD'=>0,
                    'VARIANCE_YTD'=>0,
                    'VARIANCE_YTD_PCTG'=>0,
                    'LAST_YEAR_YTD'=>0
                ),
                'RevPAR'=>array(
                    'ACTUAL_CURRENT' => 0,
                    'LAST_MONTH_CURRENT'=>0,
                    'VARIANCE_CURRENT'=>0,
                    'VARIANCE_CURRENT_PCTG'=>0,
                    'LAST_YEAR_CURRENT'=>0,
                    'ACTUAL_YTD' => 0,
                    'LAST_MONTH_YTD'=>0,
                    'VARIANCE_YTD'=>0,
                    'VARIANCE_YTD_PCTG'=>0,
                    'LAST_YEAR_YTD'=>0
                )
            );
            $collection['ROOM_STATISTIC']['DATA'] = [];
            try {
                if(strtoupper($array_name) == 'R-AY'){
                    $collection['ROOM_STATISTIC']['DATA'] = DB::connection('dbayana-dw')
                    ->select("EXEC usp_RptPNL_Getdata ?,?,?,?", array($month, $year, $company, 'AYBL'));
                } else if(strtoupper($array_name) == 'R-RB'){
                    $collection['ROOM_STATISTIC']['DATA'] = DB::connection('dbayana-dw')
                    ->select("EXEC usp_RptPNL_Getdata ?,?,?,?", array($month, $year, $company, 'RBBL'));
                } else if(strtoupper($array_name) == 'R-SG'){
                    $collection['ROOM_STATISTIC']['DATA'] = DB::connection('dbayana-dw')
                    ->select("EXEC usp_RptPNL_Getdata ?,?,?,?", array($month, $year, $company, 'AYSG'));
                } 
                else {
                    $collection['ROOM_STATISTIC']['DATA'] = DB::connection('dbayana-dw')
                    ->select("EXEC usp_RptPNL_Getdata ?,?,?,?", array($month, $year, $company, ''));
                }
                $collection['ROOM_STATISTIC']['DATA'] = collect($collection['ROOM_STATISTIC']['DATA'])->map(function($item, $key) use (&$collection, $array_name){
                    if(isset($item->KPI_CODE) && $item->KPI_CODE == 'RAS'){
                        // MTD
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['ACTUAL_CURRENT'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($item->ActualMTD) && $item->ActualMTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $item->ActualMTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($item->LastMonthMTD) && $item->LastMonthMTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $item->LastMonthMTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['VARIANCE_CURRENT'] = $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['ACTUAL_CURRENT'] - $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'];
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['VARIANCE_CURRENT_PCTG'] = $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'] != 0 ? ($collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['VARIANCE_CURRENT'] / $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT']) * 100 : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_YEAR_CURRENT'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($item->LastYearMTD) && $item->LastYearMTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $item->LastYearMTD) : 0;

                        // YTD
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['ACTUAL_YTD'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($item->ActualYTD) && $item->ActualYTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] / $item->ActualYTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($item->LastMonthYTD) && $item->LastMonthYTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $item->LastMonthYTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['VARIANCE_YTD'] = $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['ACTUAL_YTD'] - $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'];
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['VARIANCE_YTD_PCTG'] = $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'] != 0 ? ($collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['VARIANCE_YTD'] / $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_MONTH_YTD']) * 100 : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['RevPAR']['LAST_YEAR_YTD'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($item->LastYearYTD) && $item->LastYearYTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $item->LastYearYTD) : 0;
                    }

                    else if(isset($item->KPI_CODE) && $item->KPI_CODE == 'RSS'){
                        // MTD
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['ACTUAL_CURRENT'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($item->ActualMTD) && $item->ActualMTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] / $item->ActualMTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($item->LastMonthMTD) && $item->LastMonthMTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $item->LastMonthMTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT'] = $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['ACTUAL_CURRENT'] - $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'];
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT_PCTG'] = $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'] != 0 ? ($collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT'] / $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT']) * 100 : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_YEAR_CURRENT'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($item->LastYearMTD) && $item->LastYearMTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $item->LastYearMTD) : 0;

                        // YTD
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['ACTUAL_YTD'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && isset($item->ActualYTD) && $item->ActualYTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] / $item->ActualYTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($item->LastMonthYTD) && $item->LastMonthYTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] / $item->LastMonthYTD) : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD'] = $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['ACTUAL_YTD'] - $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'];
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD_PCTG'] = $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'] != 0 ? ($collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD'] / $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD']) * 100 : 0;
                        $collection['ROOM_STATISTIC']['CATEGORY']['Occupied Average Rate']['LAST_YEAR_YTD'] = isset($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($item->LastYearYTD) && $item->LastYearYTD != 0 ? ($collection[$array_name]['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] / $item->LastYearYTD) : 0;
                    }

                    return $item;
                })->toArray();
            } catch(\Exception $e){}
            // END Room
        }

        return $collection;
    }

    public function process_headcount_summary($plant, $month, $year){
        $data = array(
            'ACTUAL_CURRENT'=>0,
            'LAST_MONTH_CURRENT'=>0,
            'VARIANCE_CURRENT'=>0,
            'LAST_YEAR_CURRENT'=>0,

            'ACTUAL_YTD'=>0,
            'LAST_MONTH_YTD'=>0,
            'VARIANCE_YTD'=>0,
            'LAST_YEAR_YTD'=>0,
        );

        $data_headcount = DB::connection('dbayana-stg')
        ->select("EXEC dbo.sap_pnl_headcount_summary ?,?,?", array($plant, $month, $year));

        // MTD
        $data['ACTUAL_CURRENT'] = isset($data_headcount[0]->ACTUAL_CURRENT) ? $data_headcount[0]->ACTUAL_CURRENT : 0 ;
        $data['LAST_MONTH_CURRENT'] = isset($data_headcount[0]->LAST_MONTH_CURRENT) ? $data_headcount[0]->LAST_MONTH_CURRENT : 0 ;
        $data['VARIANCE_CURRENT'] = isset($data_headcount[0]->VARIANCE_CURRENT) ? $data_headcount[0]->VARIANCE_CURRENT : 0 ;
        $data['LAST_YEAR_CURRENT'] = isset($data_headcount[0]->LAST_YEAR_CURRENT) ? $data_headcount[0]->LAST_YEAR_CURRENT : 0 ;

        // YTD
        $data['ACTUAL_YTD'] = isset($data_headcount[0]->ACTUAL_YTD) ? $data_headcount[0]->ACTUAL_YTD : 0 ;
        $data['LAST_MONTH_YTD'] = isset($data_headcount[0]->LAST_MONTH_YTD) ? $data_headcount[0]->LAST_MONTH_YTD : 0 ;
        $data['VARIANCE_YTD'] = isset($data_headcount[0]->VARIANCE_YTD) ? $data_headcount[0]->VARIANCE_YTD : 0 ;
        $data['LAST_YEAR_YTD'] = isset($data_headcount[0]->LAST_YEAR_YTD) ? $data_headcount[0]->LAST_YEAR_YTD : 0 ;
        
        return $data;
    }

    public function process_headcount($value_pnl, $comparison_array=[]){
        $data = array(
            'ACTUAL_CURRENT'=>0,
            'LAST_MONTH_CURRENT'=>0,
            'VARIANCE_CURRENT'=>0,
            'LAST_YEAR_CURRENT'=>0,

            'ACTUAL_YTD'=>0,
            'LAST_MONTH_YTD'=>0,
            'VARIANCE_YTD'=>0,
            'LAST_YEAR_YTD'=>0,
        );
        foreach($value_pnl as $key => $headcount){
            if(in_array($key, $comparison_array)){
                // MTD
                $data['ACTUAL_CURRENT'] += isset($headcount['DATA']['HEADCOUNT']->ACTUAL_CURRENT) ? $headcount['DATA']['HEADCOUNT']->ACTUAL_CURRENT : 0 ;
                $data['LAST_MONTH_CURRENT'] += isset($headcount['DATA']['HEADCOUNT']->LAST_MONTH_CURRENT) ? $headcount['DATA']['HEADCOUNT']->LAST_MONTH_CURRENT : 0 ;
                $data['LAST_YEAR_CURRENT'] += isset($headcount['DATA']['HEADCOUNT']->LAST_YEAR_CURRENT) ? $headcount['DATA']['HEADCOUNT']->LAST_YEAR_CURRENT : 0 ;

                // YTD
                $data['ACTUAL_YTD'] += isset($headcount['DATA']['HEADCOUNT']->ACTUAL_YTD) ? $headcount['DATA']['HEADCOUNT']->ACTUAL_YTD : 0 ;
                $data['LAST_MONTH_YTD'] += isset($headcount['DATA']['HEADCOUNT']->LAST_MONTH_YTD) ? $headcount['DATA']['HEADCOUNT']->LAST_MONTH_YTD : 0 ;
                $data['LAST_YEAR_YTD'] += isset($headcount['DATA']['HEADCOUNT']->LAST_YEAR_YTD) ? $headcount['DATA']['HEADCOUNT']->LAST_YEAR_YTD : 0 ;
            } else 
                continue;
        }
        $data['VARIANCE_CURRENT'] = ($data['ACTUAL_CURRENT'] - $data['LAST_MONTH_CURRENT']);
        $data['VARIANCE_YTD'] = ($data['ACTUAL_YTD'] - $data['LAST_MONTH_YTD']);

        return $data;
    }

    public function process_payroll($value_pnl, $comparison_array=[]){
        $data = array(
            'ACTUAL_CURRENT'=>0,
            'LAST_MONTH_CURRENT'=>0,
            'VARIANCE_CURRENT'=>0,
            'LAST_YEAR_CURRENT'=>0,

            'ACTUAL_YTD'=>0,
            'LAST_MONTH_YTD'=>0,
            'VARIANCE_YTD'=>0,
            'LAST_YEAR_YTD'=>0,
        );
        foreach($value_pnl as $key => $payroll){
            if(in_array($key, $comparison_array)){
                // MTD
                $data['ACTUAL_CURRENT'] += isset($payroll['DATA']['GROUPING'][$key]['A']['DATA']['ACTUAL_CURRENT']) ? $payroll['DATA']['GROUPING'][$key]['A']['DATA']['ACTUAL_CURRENT'] : 0 ;
                $data['LAST_MONTH_CURRENT'] += isset($payroll['DATA']['GROUPING'][$key]['A']['DATA']['LAST_MONTH_CURRENT']) ? $payroll['DATA']['GROUPING'][$key]['A']['DATA']['LAST_MONTH_CURRENT'] : 0 ;
                $data['LAST_YEAR_CURRENT'] += isset($payroll['DATA']['GROUPING'][$key]['A']['DATA']['LAST_YEAR_CURRENT']) ? $payroll['DATA']['GROUPING'][$key]['A']['DATA']['LAST_YEAR_CURRENT'] : 0 ;

                // YTD
                $data['ACTUAL_YTD'] += isset($payroll['DATA']['GROUPING'][$key]['A']['DATA']['ACTUAL_YTD']) ? $payroll['DATA']['GROUPING'][$key]['A']['DATA']['ACTUAL_YTD'] : 0 ;
                $data['LAST_MONTH_YTD'] += isset($payroll['DATA']['GROUPING'][$key]['A']['DATA']->LAST_MONTH_YTD) ? $payroll['DATA']['GROUPING'][$key]['A']['DATA']['LAST_MONTH_YTD'] : 0 ;
                $data['LAST_YEAR_YTD'] += isset($payroll['DATA']['GROUPING'][$key]['A']['DATA']['LAST_YEAR_YTD']) ? $payroll['DATA']['GROUPING'][$key]['A']['DATA']['LAST_YEAR_YTD'] : 0 ;
            } else 
                continue;
        }
        $data['VARIANCE_CURRENT'] = ($data['ACTUAL_CURRENT'] - $data['LAST_MONTH_CURRENT']);
        $data['VARIANCE_YTD'] += ($data['ACTUAL_YTD'] - $data['LAST_MONTH_YTD']);

        return $data;
    }

    public function process_cost_per_revenue($summary){
        $data['PAYROLL_PER_REVENUE'] = array(
            'ACTUAL_CURRENT'=>0,
            'LAST_MONTH_CURRENT'=>0,
            'VARIANCE_CURRENT'=>0,
            'LAST_YEAR_CURRENT'=>0,

            'ACTUAL_YTD'=>0,
            'LAST_MONTH_YTD'=>0,
            'VARIANCE_YTD'=>0,
            'LAST_YEAR_YTD'=>0,
        );
        $data['PAYROLL_PER_HEADCOUNT'] = array(
            'ACTUAL_CURRENT'=>0,
            'LAST_MONTH_CURRENT'=>0,
            'VARIANCE_CURRENT'=>0,
            'LAST_YEAR_CURRENT'=>0,

            'ACTUAL_YTD'=>0,
            'LAST_MONTH_YTD'=>0,
            'VARIANCE_YTD'=>0,
            'LAST_YEAR_YTD'=>0,
        );

        // Payroll Againts Revenue
        // MTD
        $data['PAYROLL_PER_REVENUE']['ACTUAL_CURRENT'] = isset($summary['SUMMARY']['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) && $summary['SUMMARY']['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT'] != 0 && isset($summary['TOTAL_PAYROLL']['ACTUAL_CURRENT']) ? ($summary['TOTAL_PAYROLL']['ACTUAL_CURRENT'] / $summary['SUMMARY']['SIN']['SUM_CATEGORY']['ACTUAL_CURRENT']) * 100 : 0;
        $data['PAYROLL_PER_REVENUE']['LAST_MONTH_CURRENT'] = isset($summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT'] != 0 && isset($summary['TOTAL_PAYROLL']['LAST_MONTH_CURRENT']) ? ($summary['TOTAL_PAYROLL']['LAST_MONTH_CURRENT'] / $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_MONTH_CURRENT']) * 100 : 0;
        $data['PAYROLL_PER_REVENUE']['VARIANCE_CURRENT'] = $data['PAYROLL_PER_REVENUE']['ACTUAL_CURRENT'] - $data['PAYROLL_PER_REVENUE']['LAST_MONTH_CURRENT'];
        $data['PAYROLL_PER_REVENUE']['LAST_YEAR_CURRENT'] = isset($summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT'] != 0 && isset($summary['TOTAL_PAYROLL']['LAST_YEAR_CURRENT']) ? ($summary['TOTAL_PAYROLL']['LAST_YEAR_CURRENT'] / $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_YEAR_CURRENT']) * 100 : 0;

        // YTD
        $data['PAYROLL_PER_REVENUE']['ACTUAL_YTD'] = isset($summary['SUMMARY']['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) && $summary['SUMMARY']['SIN']['SUM_CATEGORY']['ACTUAL_YTD'] != 0 && isset($summary['TOTAL_PAYROLL']['ACTUAL_YTD']) ? ($summary['TOTAL_PAYROLL']['ACTUAL_YTD'] / $summary['SUMMARY']['SIN']['SUM_CATEGORY']['ACTUAL_YTD']) * 100 : 0;
        $data['PAYROLL_PER_REVENUE']['LAST_MONTH_YTD'] = isset($summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) && $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD'] != 0 && isset($summary['TOTAL_PAYROLL']['LAST_MONTH_YTD']) ? ($summary['TOTAL_PAYROLL']['LAST_MONTH_YTD'] / $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_MONTH_YTD']) * 100 : 0;
        $data['PAYROLL_PER_REVENUE']['VARIANCE_YTD'] = $data['PAYROLL_PER_REVENUE']['ACTUAL_YTD'] - $data['PAYROLL_PER_REVENUE']['LAST_MONTH_YTD'];
        $data['PAYROLL_PER_REVENUE']['LAST_YEAR_YTD'] = isset($summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) && $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD'] != 0 && isset($summary['TOTAL_PAYROLL']['LAST_YEAR_YTD']) ? ($summary['TOTAL_PAYROLL']['LAST_YEAR_YTD'] / $summary['SUMMARY']['SIN']['SUM_CATEGORY']['LAST_YEAR_YTD']) * 100 : 0;
        
        // Payroll Againts Headcount
        // MTD
        $data['PAYROLL_PER_HEADCOUNT']['ACTUAL_CURRENT'] = isset($summary['TOTAL_PAYROLL']['ACTUAL_CURRENT']) && isset($summary['TOTAL_HEADCOUNT']['ACTUAL_CURRENT']) && isset($summary['TOTAL_HEADCOUNT']['ACTUAL_CURRENT']) && $summary['TOTAL_HEADCOUNT']['ACTUAL_CURRENT'] != 0 ? ($summary['TOTAL_PAYROLL']['ACTUAL_CURRENT'] / $summary['TOTAL_HEADCOUNT']['ACTUAL_CURRENT']) : 0;
        $data['PAYROLL_PER_HEADCOUNT']['LAST_MONTH_CURRENT'] = isset($summary['TOTAL_PAYROLL']['LAST_MONTH_CURRENT']) && isset($summary['TOTAL_HEADCOUNT']['LAST_MONTH_CURRENT']) && isset($summary['TOTAL_HEADCOUNT']['LAST_MONTH_CURRENT']) && $summary['TOTAL_HEADCOUNT']['LAST_MONTH_CURRENT'] != 0 ? ($summary['TOTAL_PAYROLL']['LAST_MONTH_CURRENT'] / $summary['TOTAL_HEADCOUNT']['LAST_MONTH_CURRENT']) : 0;
        $data['PAYROLL_PER_HEADCOUNT']['VARIANCE_CURRENT'] = $data['PAYROLL_PER_HEADCOUNT']['ACTUAL_CURRENT'] - $data['PAYROLL_PER_HEADCOUNT']['LAST_MONTH_CURRENT'];
        $data['PAYROLL_PER_HEADCOUNT']['LAST_YEAR_CURRENT'] = isset($summary['TOTAL_PAYROLL']['LAST_YEAR_CURRENT']) && isset($summary['TOTAL_HEADCOUNT']['LAST_YEAR_CURRENT']) && isset($summary['TOTAL_HEADCOUNT']['LAST_YEAR_CURRENT']) && $summary['TOTAL_HEADCOUNT']['LAST_YEAR_CURRENT'] != 0 ? ($summary['TOTAL_PAYROLL']['LAST_YEAR_CURRENT'] / $summary['TOTAL_HEADCOUNT']['LAST_YEAR_CURRENT']) : 0;

        // YTD
        $data['PAYROLL_PER_HEADCOUNT']['ACTUAL_YTD'] = isset($summary['TOTAL_PAYROLL']['ACTUAL_YTD']) && isset($summary['TOTAL_HEADCOUNT']['ACTUAL_YTD']) && isset($summary['TOTAL_HEADCOUNT']['ACTUAL_YTD']) && $summary['TOTAL_HEADCOUNT']['ACTUAL_YTD'] != 0 ? ($summary['TOTAL_PAYROLL']['ACTUAL_YTD'] / $summary['TOTAL_HEADCOUNT']['ACTUAL_YTD']) : 0;
        $data['PAYROLL_PER_HEADCOUNT']['LAST_MONTH_YTD'] = isset($summary['TOTAL_PAYROLL']['LAST_MONTH_YTD']) && isset($summary['TOTAL_HEADCOUNT']['LAST_MONTH_YTD']) && isset($summary['TOTAL_HEADCOUNT']['LAST_MONTH_YTD']) && $summary['TOTAL_HEADCOUNT']['LAST_MONTH_YTD'] != 0 ? ($summary['TOTAL_PAYROLL']['LAST_MONTH_YTD'] / $summary['TOTAL_HEADCOUNT']['LAST_MONTH_YTD']) : 0;
        $data['PAYROLL_PER_HEADCOUNT']['VARIANCE_YTD'] = $data['PAYROLL_PER_HEADCOUNT']['ACTUAL_YTD'] - $data['PAYROLL_PER_HEADCOUNT']['LAST_MONTH_YTD'];
        $data['PAYROLL_PER_HEADCOUNT']['LAST_YEAR_YTD'] = isset($summary['TOTAL_PAYROLL']['LAST_YEAR_YTD']) && isset($summary['TOTAL_HEADCOUNT']['LAST_YEAR_YTD']) && isset($summary['TOTAL_HEADCOUNT']['LAST_YEAR_YTD']) && $summary['TOTAL_HEADCOUNT']['LAST_YEAR_YTD'] != 0 ? ($summary['TOTAL_PAYROLL']['LAST_YEAR_YTD'] / $summary['TOTAL_HEADCOUNT']['LAST_YEAR_YTD']) : 0;

        return $data;
    }

    public function grouping_pctg_process($data_grouping=array(), $collection_data=array(), $report_code, $grouping_code){
        $check_pctg_grouping = DB::connection('dbayana-stg')
        ->table('dbo.MasterGrpPnlTotalPctg')
        ->where(['GROUP_CODE'=>$grouping_code,'REPORT_CODE'=>$report_code])
        ->get()->first();
        // MTD
        $data_grouping['ACTUAL_CURRENT_PCTG'] = 0;
        $data_grouping['LAST_MONTH_CURRENT_PCTG'] = 0;
        $data_grouping['VARIANCE_CURRENT_PCTG'] = 0;
        $data_grouping['LAST_YEAR_CURRENT_PCTG'] = 0;
        // YTD
        $data_grouping['ACTUAL_YTD_PCTG'] = 0;
        $data_grouping['LAST_MONTH_YTD_PCTG'] = 0;
        $data_grouping['VARIANCE_YTD_PCTG'] = 0;
        $data_grouping['LAST_YEAR_YTD_PCTG'] = 0;
        if($check_pctg_grouping){
            $divide_by = [
                'ACTUAL_CURRENT'=>0,
                'LAST_MONTH_CURRENT'=>0,
                'LAST_YEAR_CURRENT'=>0,
                'ACTUAL_YTD'=>0,
                'LAST_MONTH_YTD'=>0,
                'LAST_YEAR_YTD'=>0
            ];

            if(isset($check_pctg_grouping->DIVIDED_BY_CAT_REPORT_CODE)) {
                $divide_code = explode('#', $check_pctg_grouping->DIVIDED_BY_CAT_REPORT_CODE);
                for($item=0;$item<count($divide_code);$item++){
                    $divide_by['ACTUAL_CURRENT'] += isset($collection_data[$divide_code[$item]]['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $collection_data[$divide_code[$item]]['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
                    $divide_by['LAST_MONTH_CURRENT'] += isset($collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
                    $divide_by['LAST_YEAR_CURRENT'] += isset($collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;

                    $divide_by['ACTUAL_YTD'] += isset($collection_data[$divide_code[$item]]['SUM_CATEGORY']['ACTUAL_YTD']) ? $collection_data[$divide_code[$item]]['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
                    $divide_by['LAST_MONTH_YTD'] += isset($collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
                    $divide_by['LAST_YEAR_YTD'] += isset($collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $collection_data[$divide_code[$item]]['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
                }
            }
            try {
                // MTD
                $data_grouping['ACTUAL_CURRENT_PCTG'] = isset($divide_by['ACTUAL_CURRENT']) && isset($data_grouping['ACTUAL_CURRENT']) && $divide_by['ACTUAL_CURRENT'] != 0 ? ($data_grouping['ACTUAL_CURRENT'] / $divide_by['ACTUAL_CURRENT']) * 100 : 0;
                $data_grouping['LAST_MONTH_CURRENT_PCTG'] = isset($divide_by['LAST_MONTH_CURRENT']) && isset($data_grouping['LAST_MONTH_CURRENT']) && $divide_by['LAST_MONTH_CURRENT'] != 0 ? ($data_grouping['LAST_MONTH_CURRENT'] / $divide_by['LAST_MONTH_CURRENT']) * 100 : 0;
                $data_grouping['VARIANCE_CURRENT_PCTG'] = isset($divide_by['LAST_MONTH_CURRENT']) && isset($data_grouping['VARIANCE_CURRENT']) && $divide_by['LAST_MONTH_CURRENT'] != 0 ? ($data_grouping['VARIANCE_CURRENT'] / $divide_by['LAST_MONTH_CURRENT']) * 100 : 0;
                $data_grouping['LAST_YEAR_CURRENT_PCTG'] = isset($divide_by['LAST_YEAR_CURRENT']) && isset($data_grouping['LAST_YEAR_CURRENT']) && $divide_by['LAST_YEAR_CURRENT'] != 0 ? ($data_grouping['LAST_YEAR_CURRENT'] / $divide_by['LAST_YEAR_CURRENT']) * 100 : 0;

                // YTD
                $data_grouping['ACTUAL_YTD_PCTG'] = isset($divide_by['ACTUAL_YTD']) && isset($data_grouping['ACTUAL_YTD']) && $divide_by['ACTUAL_YTD'] != 0 ? ($data_grouping['ACTUAL_YTD'] / $divide_by['ACTUAL_YTD']) * 100 : 0;
                $data_grouping['LAST_MONTH_YTD_PCTG'] = isset($divide_by['LAST_MONTH_YTD']) && isset($data_grouping['LAST_MONTH_YTD']) && $divide_by['LAST_MONTH_YTD'] != 0 ? ($data_grouping['LAST_MONTH_YTD'] / $divide_by['LAST_MONTH_YTD']) * 100 : 0;
                $data_grouping['VARIANCE_YTD_PCTG'] = isset($divide_by['LAST_MONTH_YTD']) && isset($data_grouping['VARIANCE_YTD']) && $divide_by['LAST_MONTH_YTD'] != 0 ? ($data_grouping['VARIANCE_YTD'] / $divide_by['LAST_MONTH_YTD']) * 100 : 0;
                $data_grouping['LAST_YEAR_YTD_PCTG'] = isset($divide_by['LAST_YEAR_YTD']) && isset($data_grouping['LAST_YEAR_YTD']) && $divide_by['LAST_YEAR_YTD'] != 0 ? ($data_grouping['LAST_YEAR_YTD'] / $divide_by['LAST_YEAR_YTD']) * 100 : 0;
            } catch(\Exception $e){
                Log::error('ERROR DI FUNGSI GROUPING PCTG PROCESS PNL | '.$e->getMessage());
            }
        }
        return $data_grouping;
    }

    // Untuk memunculkan TOTAL hasil grouping dengan
    // beberapa kategori report (SIN, BVR, FDR, dsb)
    public function show_grouping_total_count($grouping_data, $report_code){
        $cek_grouping = DB::connection('dbayana-stg')
        ->table('dbo.MasterGrpPnlTotal')
        ->where('REPORT_CODE', $report_code)
        ->select('GROUP_CODE', 'CATEGORY_REPORT_CODE')
        ->get()->groupBy('GROUP_CODE')->mapWithKeys(function($item, $key){
            $item_new = $item->pluck('CATEGORY_REPORT_CODE', 'CATEGORY_REPORT_CODE')->values()->all();
            return [$key=>$item_new];
        })->toArray();
        $grouping_data['GROUP_DETAIL'] = $cek_grouping;
        // if($report_code == 'DAMAR')
        //     dd($grouping_data);
        return $grouping_data;
    }

    public function index(Request $request){
        ini_set('max_execution_time', 2000);
        date_default_timezone_set('Asia/Makassar');
        // $date_default = date('Y-m-01');
        // $date_default = date('Y-m-d', strtotime("-1 months", $date_default));
        $date_default = date("Y-m-d", mktime(0,0,0,date('n')-1,1,date('Y')));
        $data['MONTH_NAME'] = date('M', strtotime($date_default));
        $data['MONTH'] = date('n', strtotime($date_default));
        $data['YEAR'] = date('Y', strtotime($date_default));
        // Default tampil KMS1
        
        $data['COMPANY'] = null;

        $data['HOTEL_LIST'] = DB::connection('dbintranet')
        ->table('dbo.INT_BUSINESS_PLANT')
        ->where('PLANT_TYPE', 'HOTEL')
        ->orWhere('IS_ADDITIONAL_HOTEL', 'Y')
        ->orderBy('SAP_PLANT_ID');
        // Company List untuk report
        

        // Check Custom access
        $check_custom_plant = self::customPlantAccess();
        if(count($check_custom_plant)){
            $data['COMPANY_SAP'] = DB::connection('dbintranet')
            ->table('dbo.INT_BUSINESS_PLANT')
            ->whereIn('SAP_PLANT_ID', $check_custom_plant)->get()->pluck('COMPANY_CODE', 'COMPANY_CODE')
            ->toArray();
            // Company untuk mengganti report
            $data['COMPANY_LIST'] = DB::connection('dbintranet')
            ->table('dbo.INT_BUSINESS_PLANT')
            ->whereIn('SAP_PLANT_ID', $check_custom_plant)->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')
            ->toArray();
            if($data['COMPANY_LIST'] && count($data['COMPANY_LIST'])){
                $data['COMPANY'] = isset(array_keys($data['COMPANY_LIST'])[0]) ? array_keys($data['COMPANY_LIST'])[0] : null;
            }
        } else {

            // Filter untuk sync data ke SAP (Jika superuser tampilkan semua company hotel, jika tidak maka tampilkan penempatannya saja)
            $cek_permission_view_all_pnl = 'view_'. (String)route('sap.report.pnl',[],false);
            if(isset($request->session()->get('user_data')->IS_SUPERUSER) && $request->session()->get('user_data')->IS_SUPERUSER || session()->get('permission_menu')->has($cek_permission_view_all_pnl)){
                // Company untuk Sync
                $data['COMPANY_SAP'] = $data['HOTEL_LIST']->get()->pluck('COMPANY_CODE', 'COMPANY_CODE')
                ->toArray();
                // Company untuk mengganti report
                $data['COMPANY_LIST'] = $data['HOTEL_LIST']->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')
                ->toArray();
                if($data['COMPANY_LIST'] && count($data['COMPANY_LIST'])){
                    $data['COMPANY'] = isset(array_keys($data['COMPANY_LIST'])[0]) ? array_keys($data['COMPANY_LIST'])[0] : null;
                }
            }
            else {
                $user_id = isset(session()->get('user_data')->EMPLOYEE_ID) ? session()->get('user_data')->EMPLOYEE_ID : '';
                $cek_plant_user = DB::connection('dbintranet')
                ->table('dbo.VIEW_EMPLOYEE_ACCESS')
                ->where('EMPLOYEE_ID', $user_id)
                ->select('SAP_PLANT_ID', 'COMPANY_CODE')
                ->get()->pluck('SAP_PLANT_ID', 'SAP_PLANT_ID')->filter()->toArray();
                // $plant_user = isset($request->session()->get('assignment')->toArray()[0]->SAP_PLANT_ID) ? $request->session()->get('assignment')->toArray()[0]->SAP_PLANT_ID : '';
                
                // Company untuk Sync
                $data['COMPANY_SAP'] = DB::connection('dbintranet')
                ->table('dbo.INT_BUSINESS_PLANT')
                ->whereIn('SAP_PLANT_ID', $cek_plant_user)->get()->pluck('COMPANY_CODE', 'COMPANY_CODE')
                ->toArray();
                // Company untuk mengganti report
                $data['COMPANY_LIST'] = DB::connection('dbintranet')
                ->table('dbo.INT_BUSINESS_PLANT')
                ->whereIn('SAP_PLANT_ID', $cek_plant_user)->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')
                ->toArray();
                if($data['COMPANY_LIST'] && count($data['COMPANY_LIST'])){
                    $data['COMPANY'] = isset(array_keys($data['COMPANY_LIST'])[0]) ? array_keys($data['COMPANY_LIST'])[0] : null;
                }
            }
        }
        // dd($data);

        if($request->post('month')){
            try {
                if(in_array($request->post('month'), array_keys($this->pnl_period_exclude_month))){
                    $data['MONTH_NAME'] = $this->pnl_period_exclude_month[$request->post('month')];
                    $data['MONTH'] = $request->post('month');
                } else {
                    $data['MONTH_NAME'] = date('M', strtotime('2021-'.$request->post('month').'-01' ));
                    $data['MONTH'] = date('n', strtotime('2021-'.$request->post('month').'-01' ));
                }
            } catch(\Exception $e){}
        }
        if($request->post('year')){
            try {
                if(in_array($request->post('month'), array_keys($this->pnl_period_exclude_month))){
                    $data['YEAR'] = $request->post('year');
                } else {
                    $data['YEAR'] = date('Y', strtotime($request->post('year').'-'.$data['MONTH'].'-01' ));
                }
            } catch(\Exception $e){}
        }
        if($request->post('company')){
            try {
                $data['COMPANY'] = $request->post('company', 'ALL');
            } catch(\Exception $e){}
        }

        $data['LAST_UPDATE'] = DB::connection('dbayana-stg')
        ->table('dbo.SAP_PNL')
        ->where('PRCTR', $data['COMPANY'])
        ->select('LAST_UPDATE')
        ->orderBy('LAST_UPDATE', 'DESC')
        ->get()->pluck('LAST_UPDATE')->first();

        $check_report = DB::connection('dbayana-stg')
        ->table('dbo.MasterGrpPnlReport')
        ->where('COST_ONLY_YN', 'N')
        ->where('PLANT', $data['COMPANY'])
        // ->where('GROUP_REPORT', 'DAMAR')
        ->select('GROUP_REPORT', 'GROUP_DESC', 'PROCESSING_TYPE_FUNC', 'REPORT_SORT')
        ->get()->sortBy('REPORT_SORT')->values()->all();

        $data['VALUE_PNL'] = [];
        if(count($check_report)){
            foreach ($check_report as $key => $value) {
                if(isset($value->PROCESSING_TYPE_FUNC) && $value->PROCESSING_TYPE_FUNC && $value->PROCESSING_TYPE_FUNC != 'NOR'){
                    $data[$value->GROUP_REPORT] = DB::connection('dbayana-stg')
                    ->select("EXEC dbo.sap_pnl_report ?,?,?,?", array($value->GROUP_REPORT, $data['COMPANY'], $data['YEAR'], $data['MONTH']));

                    switch ($value->PROCESSING_TYPE_FUNC) {
                      case 'DEX':
                        $data[$value->GROUP_REPORT] = $this->departmental_expense_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      case 'RMR':
                        $data[$value->GROUP_REPORT] = $this->room_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR'], $data['COMPANY']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      case 'FBV' :
                        $data[$value->GROUP_REPORT] = $this->fnb_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      case 'FNB' :
                        $data[$value->GROUP_REPORT] = $this->fnb_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      case 'OER' :
                        $data[$value->GROUP_REPORT] = $this->other_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      default:
                        break;
                    }

                    $data['VALUE_PNL'][$value->GROUP_REPORT] = array('DATA'=>$data[$value->GROUP_REPORT], 'DESC'=>$value->GROUP_DESC);
                }
            }
        }

        // SUMMARY ALL
        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT'] = array(
            'ACTUAL_CURRENT'=>0,
            'LAST_MONTH_CURRENT'=>0,
            'VARIANCE_CURRENT'=>0,
            'LAST_YEAR_CURRENT'=>0,

            'ACTUAL_YTD'=>0,
            'LAST_MONTH_YTD'=>0,
            'VARIANCE_YTD'=>0,
            'LAST_YEAR_YTD'=>0,
        );
        $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME'] = array(
            'ACTUAL_CURRENT'=>0,
            'LAST_MONTH_CURRENT'=>0,
            'VARIANCE_CURRENT'=>0,
            'LAST_YEAR_CURRENT'=>0,

            'ACTUAL_YTD'=>0,
            'LAST_MONTH_YTD'=>0,
            'VARIANCE_YTD'=>0,
            'LAST_YEAR_YTD'=>0,
        );

        $data['SUMMARY-ALL']['SUMMARY'] = DB::connection('dbayana-stg')
        ->table('dbo.MasterPnlSummary')
        ->where('PLANT', $data['COMPANY'])
        ->get()->sortBy([
            ['CATEGORY_ID', 'asc'],
            ['SEQ_ID', 'asc'],
        ])->groupBy('GROUP_CODE')->mapWithKeys(function($item, $key) use (&$data) {
            // Cek Data mapping per item
            $new_item = $item->map(function($item, $key) use (&$data){
                // dd($item, $data);
                if(isset($item->MAPPING_CODE) && strtolower($item->MAPPING_CODE) != 'departmental_profit'){
                    $check_grouping = explode('#', $item->MAPPING_CODE);
                    // dd($check_grouping);
                    $item->ACTUAL_CURRENT = 0;
                    $item->LAST_MONTH_CURRENT = 0; 
                    $item->VARIANCE_CURRENT = 0;
                    $item->LAST_YEAR_CURRENT = 0;

                    $item->ACTUAL_YTD = 0;
                    $item->LAST_MONTH_YTD = 0; 
                    $item->VARIANCE_YTD = 0;
                    $item->LAST_YEAR_YTD = 0;

                    foreach ($check_grouping as $grouping_code) {
                            # code...
                        $item->ACTUAL_CURRENT +=    
                            isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_CURRENT']) ?
                            $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
                        $item->LAST_MONTH_CURRENT +=
                            isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ?
                            $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
                        $item->LAST_YEAR_CURRENT +=
                            isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ?
                            $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;

                        // YTD
                        $item->ACTUAL_YTD += 
                            isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_YTD']) ?
                            $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
                        $item->LAST_MONTH_YTD += 
                            isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_YTD']) ?
                            $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
                        $item->LAST_YEAR_YTD += 
                            isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_YTD']) ?
                            $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
                    }
                    $item->VARIANCE_CURRENT += $item->ACTUAL_CURRENT - $item->LAST_MONTH_CURRENT;
                    $item->VARIANCE_YTD += $item->ACTUAL_YTD - $item->LAST_MONTH_YTD;



                }
                else {
                    // MTD
                    $item->ACTUAL_CURRENT = 
                        isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_CURRENT']) ?
                        $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_CURRENT'] : 0;
                    $item->LAST_MONTH_CURRENT = 
                        isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_CURRENT']) ?
                        $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_CURRENT'] : 0;
                    $item->VARIANCE_CURRENT = $item->ACTUAL_CURRENT - $item->LAST_MONTH_CURRENT;
                    $item->LAST_YEAR_CURRENT = 
                        isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_CURRENT']) ?
                        $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_CURRENT'] : 0;

                    // YTD
                    $item->ACTUAL_YTD = 
                        isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_YTD']) ?
                        $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_YTD'] : 0;
                    $item->LAST_MONTH_YTD = 
                        isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_YTD']) ?
                        $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_YTD'] : 0;
                    $item->VARIANCE_YTD = $item->ACTUAL_YTD - $item->LAST_MONTH_YTD;
                    $item->LAST_YEAR_YTD = 
                        isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_YTD']) ?
                        $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_YTD'] : 0;
                }

                // jumlahkan unallocated expenses untuk gross
                // TAMBAHKAN JIKA DEPARTMENTAL PROFIT
                if(strtoupper($item->GROUP_CODE) == 'DPT'){
                    try {
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] += $item->ACTUAL_CURRENT;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] += $item->LAST_MONTH_CURRENT;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_CURRENT'] += $item->VARIANCE_CURRENT;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] += $item->LAST_YEAR_CURRENT;

                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] += $item->ACTUAL_YTD;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] += $item->LAST_MONTH_YTD;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_YTD'] += $item->VARIANCE_YTD;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] += $item->LAST_YEAR_YTD;
                    } catch(\Exception $e){}
                }
                // KURANGKAN JIKA UNALLOCATED EXPENSE
                else if(strtoupper($item->GROUP_CODE) == 'UEX'){
                    try {
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] -= $item->ACTUAL_CURRENT;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] -= $item->LAST_MONTH_CURRENT;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_CURRENT'] -= $item->VARIANCE_CURRENT;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] -= $item->LAST_YEAR_CURRENT;

                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] -= $item->ACTUAL_YTD;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] -= $item->LAST_MONTH_YTD;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_YTD'] -= $item->VARIANCE_YTD;
                        $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] -= $item->LAST_YEAR_YTD;
                    } catch(\Exception $e){}
                }
                return $item;
            });
            // dd($new_item);
            // SUM MTD
            $sum_data['ACTUAL_CURRENT'] = $new_item->sum('ACTUAL_CURRENT');
            $sum_data['LAST_MONTH_CURRENT'] = $new_item->sum('LAST_MONTH_CURRENT');
            $sum_data['VARIANCE_CURRENT'] = $new_item->sum('VARIANCE_CURRENT');
            $sum_data['LAST_YEAR_CURRENT'] = $new_item->sum('LAST_YEAR_CURRENT');
            // SUM YTD
            $sum_data['ACTUAL_YTD'] = $new_item->sum('ACTUAL_YTD');
            $sum_data['LAST_MONTH_YTD'] = $new_item->sum('LAST_MONTH_YTD');
            $sum_data['VARIANCE_YTD'] = $new_item->sum('VARIANCE_YTD');
            $sum_data['LAST_YEAR_YTD'] = $new_item->sum('LAST_YEAR_YTD');


            return [$key=>array('DATA_CATEGORY'=>$new_item->toArray(), 'SUM_CATEGORY'=>$sum_data)];
        })->toArray();
        
        // Memasukkan Other deduction ke group summary
        if(count($data['SUMMARY-ALL']['SUMMARY'])){
            // GET OTHER DEDUCTION COMPANY
            $get_oth_ded_company = DB::connection('dbayana-stg')
            ->table('dbo.MasterGrpPnlReport')
            ->where('PLANT', $data['COMPANY'])
            ->where('GROUP_REPORT', 'like', 'OTHDED%')
            ->select('GROUP_REPORT')
            ->get()->pluck('GROUP_REPORT')->first();

            $oth_deduc_summary_all = DB::connection('dbayana-stg')
            ->select("EXEC dbo.sap_pnl_report ?,?,?,?", array($get_oth_ded_company, $data['COMPANY'], $data['YEAR'], $data['MONTH']));
            if($oth_deduc_summary_all){
                $oth_deduc_summary_all = collect($oth_deduc_summary_all)->groupBy('GROUP_REPORT')->filter()->mapWithKeys(function($item, $key) use (&$data){
                    // SUM MTD
                    $sum_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                    $sum_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                    $sum_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                    $sum_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                    // SUM YTD
                    $sum_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                    $sum_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                    $sum_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                    $sum_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                    $item = collect($item)->map(function($item, $key){
                        $item->ACTUAL_CURRENT = isset($item->ACTUAL_CURRENT_PERIOD) ? $item->ACTUAL_CURRENT_PERIOD : 0;
                        $item->LAST_MONTH_CURRENT = isset($item->LAST_MONTH_CURRENT_PERIOD) ? $item->LAST_MONTH_CURRENT_PERIOD : 0;
                        $item->VARIANCE_CURRENT = isset($item->VARIANCE_CURRENT_PERIOD) ? $item->VARIANCE_CURRENT_PERIOD : 0;
                        $item->LAST_YEAR_CURRENT = isset($item->LAST_YEAR_CURRENT_PERIOD) ? $item->LAST_YEAR_CURRENT_PERIOD : 0;
                        $item->CATEGORY = isset($item->DESC_COA_COST_CENTER) ? $item->DESC_COA_COST_CENTER : 0;
                        $item->GROUP_DESC = isset($item->CATEGORY_REPORT) ? $item->CATEGORY_REPORT : 0;
                        return $item;  
                    });

                    // MTD
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] - $sum_data['ACTUAL_CURRENT']);
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] - $sum_data['LAST_MONTH_CURRENT']);
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_CURRENT'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT']);
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_CURRENT'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] - $sum_data['LAST_YEAR_CURRENT']);

                    // YTD
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] - $sum_data['ACTUAL_YTD']);
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] - $sum_data['LAST_MONTH_YTD']);
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_YTD'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD']);
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_YTD'] = 
                        ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] - $sum_data['LAST_YEAR_YTD']);

                    $data['SUMMARY-ALL']['SUMMARY'][$key] = array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$sum_data);
                    return [];
                });
            } else {
                // MTD
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] - 0);
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] - 0);
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_CURRENT'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT']);
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_CURRENT'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] - 0);

                // YTD
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] - 0);
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] - 0);
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_YTD'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD']);
                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_YTD'] = 
                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] - 0);
            }
        }

        // Grouping untuk summary ALL 
        $data['SUMMARY-ALL']['SUMMARY'] = collect($data['SUMMARY-ALL']['SUMMARY'])->mapWithKeys(function($item, $key) use ($data){
            if($key == 'SIN'){
                $each_item = isset($item['DATA_CATEGORY']) ? $item['DATA_CATEGORY'] : [];
                $each_item_summary = isset($item['SUM_CATEGORY']) ? $item['SUM_CATEGORY'] : [];

                $each_data = collect($each_item)->map(function($item, $key) use ($each_item_summary){
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    // Cek untuk tidak dibagi dengan 0
                    // MTD
                    if(isset($each_item_summary['ACTUAL_CURRENT']) && $each_item_summary['ACTUAL_CURRENT'] != 0)
                        $actual_current_period_pctg = isset($item->ACTUAL_CURRENT) ? ($item->ACTUAL_CURRENT / $each_item_summary['ACTUAL_CURRENT']) * 100 : 0;
                    if(isset($each_item_summary['LAST_MONTH_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                        $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT) ? ($item->LAST_MONTH_CURRENT / $each_item_summary['LAST_MONTH_CURRENT']) * 100 : 0;
                    if(isset($item->LAST_MONTH_CURRENT) && $item->LAST_MONTH_CURRENT != 0)
                        $variance_current_period_pctg = isset($item->VARIANCE_CURRENT) ? ($item->VARIANCE_CURRENT / $item->LAST_MONTH_CURRENT) * 100 : 0;
                    if(isset($each_item_summary['LAST_YEAR_CURRENT']) && $each_item_summary['LAST_YEAR_CURRENT'] != 0)
                        $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT) ? ($item->LAST_YEAR_CURRENT / $each_item_summary['LAST_YEAR_CURRENT']) * 100 : 0;

                    // YTD
                    if(isset($each_item_summary['ACTUAL_YTD']) && $each_item_summary['ACTUAL_YTD'] !=  0)
                        $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $each_item_summary['ACTUAL_YTD']) * 100 : 0;
                    if(isset($each_item_summary['LAST_MONTH_YTD']) && $each_item_summary['LAST_MONTH_YTD'] !=  0)
                        $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $each_item_summary['LAST_MONTH_YTD']) * 100 : 0;
                    if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                        $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                    if(isset($each_item_summary['LAST_YEAR_YTD']) && $each_item_summary['LAST_YEAR_YTD'] !=  0)
                        $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $each_item_summary['LAST_YEAR_YTD']) * 100 : 0;

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    return $item;
                });

                $each_item_summary['ACTUAL_CURRENT_PCTG'] = $each_data->sum('ACTUAL_CURRENT_PCTG');
                $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = $each_data->sum('LAST_MONTH_CURRENT_PCTG');
                if(isset($each_item_summary['LAST_MONTH_CURRENT']) && isset($each_item_summary['VARIANCE_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                    $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = $each_data->sum('LAST_YEAR_CURRENT_PCTG');

                $each_item_summary['ACTUAL_YTD_PCTG'] = $each_data->sum('ACTUAL_YTD_PCTG');
                $each_item_summary['LAST_MONTH_YTD_PCTG'] = $each_data->sum('LAST_MONTH_YTD_PCTG');
                if(isset($each_item_summary['LAST_MONTH_YTD']) && isset($each_item_summary['VARIANCE_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                    $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                $each_item_summary['LAST_YEAR_YTD_PCTG'] = $each_data->sum('LAST_YEAR_YTD_PCTG');

            } else {
                $each_item = isset($item['DATA_CATEGORY']) ? $item['DATA_CATEGORY'] : [];
                $each_item_summary = isset($item['SUM_CATEGORY']) ? $item['SUM_CATEGORY'] : [];
                $item_divided_by = isset($data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY']) ? $data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY'] : [];
                $each_data = collect($each_item)->map(function($item, $key) use ($item_divided_by, $data){
                    $actual_current_period_pctg = 0;
                    $last_month_current_period_pctg = 0;
                    $variance_current_period_pctg = 0;
                    $last_year_current_period_pctg = 0;

                    $actual_ytd_pctg = 0;
                    $last_month_ytd_pctg = 0;
                    $variance_ytd_pctg = 0;
                    $last_year_ytd_pctg = 0;

                    $type_revenue = isset($item->GROUP_CODE) ? strtoupper($item->GROUP_CODE) : '-';
                    if(strtoupper($type_revenue) == 'DPT'){
                        $separate_rev_code = explode('#', $item->DIVIDED_BY_CAT_REPORT);
                        $total_rev = [
                            'ACTUAL_CURRENT'=>0,
                            'LAST_MONTH_CURRENT'=>0,
                            'LAST_YEAR_CURRENT'=>0,
                            'ACTUAL_YTD'=>0,
                            'LAST_MONTH_YTD'=>0,
                            'LAST_YEAR_YTD'=>0
                        ];
                        for($i=0;$i<count($separate_rev_code);$i++){
                            // MTD
                            $total_rev['ACTUAL_CURRENT'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
                            $total_rev['LAST_MONTH_CURRENT'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
                            $total_rev['LAST_YEAR_CURRENT'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;

                            // YTD
                            $total_rev['ACTUAL_YTD'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_YTD']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
                            $total_rev['LAST_MONTH_YTD'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
                            $total_rev['LAST_YEAR_YTD'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
                        }

                        // MTD
                        if(isset($total_rev['ACTUAL_CURRENT'])){
                            $actual_current_period_pctg = isset($total_rev['ACTUAL_CURRENT']) && $total_rev['ACTUAL_CURRENT'] != 0 ? 
                            ($item->ACTUAL_CURRENT / $total_rev['ACTUAL_CURRENT']) * 100 : 0;
                        } else {
                            $actual_current_period_pctg = isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? 
                            ($item->ACTUAL_CURRENT / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                        }

                        if(isset($total_rev['LAST_MONTH_CURRENT'])){
                            $last_month_current_period_pctg = isset($total_rev['LAST_MONTH_CURRENT']) && $total_rev['LAST_MONTH_CURRENT'] != 0 ? 
                                ($item->LAST_MONTH_CURRENT / $total_rev['LAST_MONTH_CURRENT']) * 100 : 0;
                        } else {
                            $last_month_current_period_pctg = isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? 
                                ($item->LAST_MONTH_CURRENT / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                        }

                        $variance_current_period_pctg = isset($item->VARIANCE_CURRENT) && $item->LAST_MONTH_CURRENT != 0 ? ($item->VARIANCE_CURRENT / $item->LAST_MONTH_CURRENT) * 100 : 0;

                        if(isset($total_rev['LAST_YEAR_CURRENT'])){
                            $last_year_current_period_pctg = isset($total_rev['LAST_YEAR_CURRENT']) && $total_rev['LAST_YEAR_CURRENT'] != 0 ? 
                                ($item->LAST_YEAR_CURRENT / $total_rev['LAST_YEAR_CURRENT']) * 100 : 0;
                        } else {
                            $last_year_current_period_pctg = isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? 
                                ($item->LAST_YEAR_CURRENT / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                        }

                        // YTD
                        if(isset($total_rev['ACTUAL_YTD'])){
                            $actual_ytd_pctg = isset($total_rev['ACTUAL_YTD']) && $total_rev['ACTUAL_YTD'] != 0 ? 
                            ($item->ACTUAL_YTD / $total_rev['ACTUAL_YTD']) * 100 : 0;
                        } else {
                            $actual_ytd_pctg = isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? 
                            ($item->ACTUAL_YTD / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                        }

                        if(isset($total_rev['LAST_MONTH_YTD'])){
                            $last_month_ytd_pctg = isset($total_rev['LAST_MONTH_YTD']) && $total_rev['LAST_MONTH_YTD'] != 0 ? 
                                ($item->LAST_MONTH_YTD / $total_rev['LAST_MONTH_YTD']) * 100 : 0;
                        } else {
                            $last_month_ytd_pctg = isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? 
                                ($item->LAST_MONTH_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                        }

                        $variance_ytd_pctg = isset($item->VARIANCE_YTD) && $item->LAST_MONTH_YTD != 0 ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;

                        if(isset($total_rev['LAST_YEAR_YTD'])){
                            $last_year_ytd_pctg = isset($total_rev['LAST_YEAR_YTD']) && $total_rev['LAST_YEAR_YTD'] != 0 ? 
                                ($item->LAST_YEAR_YTD / $total_rev['LAST_YEAR_YTD']) * 100 : 0;
                        } else {
                            $last_year_ytd_pctg = isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? 
                                ($item->LAST_YEAR_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                        }

                    } else {
                        // Cek untuk tidak dibagi dengan 0
                        // MTD
                        if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                            $actual_current_period_pctg = isset($item->ACTUAL_CURRENT) ? ($item->ACTUAL_CURRENT / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                        if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                            $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT) ? ($item->LAST_MONTH_CURRENT / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                        if(isset($item->LAST_MONTH_CURRENT) && $item->LAST_MONTH_CURRENT != 0)
                            $variance_current_period_pctg = isset($item->VARIANCE_CURRENT) ? ($item->VARIANCE_CURRENT / $item->LAST_MONTH_CURRENT) * 100 : 0;
                        if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                            $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT) ? ($item->LAST_YEAR_CURRENT / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] !=  0)
                            $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                        if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] !=  0)
                            $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                        if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                            $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                        if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] !=  0)
                            $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;
                    }

                    // MTD
                    $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                    $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                    $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                    $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                    // YTD
                    $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                    $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                    $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                    $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                    return $item;
                });
                
                // MTD
                if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                    $each_item_summary['ACTUAL_CURRENT_PCTG'] = ($each_item_summary['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100;
                else 
                    $each_item_summary['ACTUAL_CURRENT_PCTG'] = 0;
                if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                    $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = ($each_item_summary['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100;
                else
                    $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = 0;
                if(isset($each_item_summary['LAST_MONTH_CURRENT']) && isset($each_item_summary['VARIANCE_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                    $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                else 
                    $each_item_summary['VARIANCE_CURRENT_PCTG'] = 0;
                if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                    $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = ($each_item_summary['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100;
                else
                    $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = 0;

                // YTD
                if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0)
                    $each_item_summary['ACTUAL_YTD_PCTG'] = ($each_item_summary['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100;
                else 
                    $each_item_summary['ACTUAL_YTD_PCTG'] = 0;
                if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0)
                    $each_item_summary['LAST_MONTH_YTD_PCTG'] = ($each_item_summary['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100;
                else
                    $each_item_summary['LAST_MONTH_YTD_PCTG'] = 0;
                if(isset($each_item_summary['LAST_MONTH_YTD']) && isset($each_item_summary['VARIANCE_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                    $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                else 
                    $each_item_summary['VARIANCE_YTD_PCTG'] = 0;
                if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0)
                    $each_item_summary['LAST_YEAR_YTD_PCTG'] = ($each_item_summary['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100;
                else
                    $each_item_summary['LAST_YEAR_YTD_PCTG'] = 0;
            }
            // Map new data if exists to the key
            if(isset($each_data))
                return [$key=>array('DATA_CATEGORY'=>$each_data->toArray(), 'SUM_CATEGORY'=>$each_item_summary)];
            // Return unprocessed data to the key
            else 
                return [$key=>$item];
        })->toArray();

        $data['SUMMARY-ALL']['GROUPING'] = collect($data['SUMMARY-ALL']['GROUPING'])->map(function($item, $key) use ($data){
            $item_divided_by = isset($data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY']) ? $data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY'] : [];
            // MTD
            $item['ACTUAL_CURRENT_PCTG'] = isset($item_divided_by['ACTUAL_CURRENT']) && isset($item['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? ($item['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
            $item['LAST_MONTH_CURRENT_PCTG'] = isset($item_divided_by['LAST_MONTH_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? ($item['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
            $item['VARIANCE_CURRENT_PCTG'] = isset($item['VARIANCE_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item['LAST_MONTH_CURRENT'] != 0 ? ($item['VARIANCE_CURRENT'] / $item['LAST_MONTH_CURRENT']) * 100 : 0;
            $item['LAST_YEAR_CURRENT_PCTG'] = isset($item_divided_by['LAST_YEAR_CURRENT']) && isset($item['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0 ? ($item['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

            // YTD
            $item['ACTUAL_YTD_PCTG'] = isset($item_divided_by['ACTUAL_YTD']) && isset($item['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? ($item['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
            $item['LAST_MONTH_YTD_PCTG'] = isset($item_divided_by['LAST_MONTH_YTD']) && isset($item['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? ($item['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
            $item['VARIANCE_YTD_PCTG'] = isset($item['VARIANCE_YTD']) && isset($item['LAST_MONTH_YTD']) && $item['LAST_MONTH_YTD'] != 0 ? ($item['VARIANCE_YTD'] / $item['LAST_MONTH_YTD']) * 100 : 0;
            $item['LAST_YEAR_YTD_PCTG'] = isset($item_divided_by['LAST_YEAR_YTD']) && isset($item['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0 ? ($item['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;
            return $item;
        })->toArray();

        // START PNL DATA DIVIDED BY SUMMARY DATA
        $data_divided_by_summary = DB::connection('dbayana-stg')
        ->table('dbo.MasterPnlDividedBySummary')
        ->where(['PLANT_ID'=>$data['COMPANY'], 'DIVIDED_BY_SUMMARY_NOT_GROUP'=>'Y'])
        ->select('REPORT_CAT', 'CATEGORY_CODE', 'DIVIDED_BY_SUMMARY_OR_GROUP_CODE AS SUMMARY_CODE')
        ->get()->groupBy('REPORT_CAT')->toArray();
        // dd($data['SUMMARY-ALL'], $data['VALUE_PNL']['AG']['DATA'], $data_divided_by_summary);

        if(count($data_divided_by_summary)){
            foreach($data_divided_by_summary as $key => $val){
                for($dtsm=0;$dtsm<count($val);$dtsm++){
                    $item_divided_by = isset($data['SUMMARY-ALL']['SUMMARY'][$val[$dtsm]->SUMMARY_CODE]['SUM_CATEGORY']) ? $data['SUMMARY-ALL']['SUMMARY'][$val[$dtsm]->SUMMARY_CODE]['SUM_CATEGORY'] : [];

                    // Jika kode berada dalam category
                    if(isset($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE])) {
                        $each_item_summary = isset($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['SUM_CATEGORY']) ? $data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['SUM_CATEGORY'] : [];

                        if(isset($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA_CATEGORY'])){
                            $data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA_CATEGORY'] = collect($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA_CATEGORY'])->map(function($item, $key) use ($item_divided_by, $data){
                                $actual_current_period_pctg = 0;
                                $last_month_current_period_pctg = 0;
                                $variance_current_period_pctg = 0;
                                $last_year_current_period_pctg = 0;

                                $actual_ytd_pctg = 0;
                                $last_month_ytd_pctg = 0;
                                $variance_ytd_pctg = 0;
                                $last_year_ytd_pctg = 0;

                                
                                // MTD
                                if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                                    $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                                if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                                    $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                                if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0)
                                    $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0;
                                if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                                    $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                                // YTD
                                if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] !=  0)
                                    $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                                if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] !=  0)
                                    $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                                    $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                                if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] !=  0)
                                    $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;

                                // MTD
                                $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                                $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                                $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                                $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                                // YTD
                                $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                                $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                                $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                                $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                                return $item;
                            });
                        }

                        // MTD
                        if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                            $each_item_summary['ACTUAL_CURRENT_PCTG'] = ($each_item_summary['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100;
                        else 
                            $each_item_summary['ACTUAL_CURRENT_PCTG'] = 0;
                        if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                            $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = ($each_item_summary['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100;
                        else
                            $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = 0;
                        if(isset($each_item_summary['LAST_MONTH_CURRENT']) && isset($each_item_summary['VARIANCE_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                            $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                        else 
                            $each_item_summary['VARIANCE_CURRENT_PCTG'] = 0;
                        if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                            $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = ($each_item_summary['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100;
                        else
                            $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = 0;

                        // YTD
                        if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0)
                            $each_item_summary['ACTUAL_YTD_PCTG'] = ($each_item_summary['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100;
                        else 
                            $each_item_summary['ACTUAL_YTD_PCTG'] = 0;
                        if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0)
                            $each_item_summary['LAST_MONTH_YTD_PCTG'] = ($each_item_summary['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100;
                        else
                            $each_item_summary['LAST_MONTH_YTD_PCTG'] = 0;
                        if(isset($each_item_summary['LAST_MONTH_YTD']) && isset($each_item_summary['VARIANCE_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                            $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                        else 
                            $each_item_summary['VARIANCE_YTD_PCTG'] = 0;
                        if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0)
                            $each_item_summary['LAST_YEAR_YTD_PCTG'] = ($each_item_summary['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100;
                        else
                            $each_item_summary['LAST_YEAR_YTD_PCTG'] = 0;

                        $data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['SUM_CATEGORY'] = $each_item_summary;

                    // Jika kode berada dalam DEPARTMENTAL_PROFIT
                    } else if(isset($data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE])){
                        $item = isset($data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE]) ? $data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE] : [];
        
                        // MTD
                        $item['ACTUAL_CURRENT_PCTG'] = isset($item_divided_by['ACTUAL_CURRENT']) && isset($item['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? ($item['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                        $item['LAST_MONTH_CURRENT_PCTG'] = isset($item_divided_by['LAST_MONTH_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? ($item['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                        $item['VARIANCE_CURRENT_PCTG'] = isset($item['VARIANCE_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item['LAST_MONTH_CURRENT'] != 0 ? ($item['VARIANCE_CURRENT'] / $item['LAST_MONTH_CURRENT']) * 100 : 0;
                        $item['LAST_YEAR_CURRENT_PCTG'] = isset($item_divided_by['LAST_YEAR_CURRENT']) && isset($item['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0 ? ($item['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        $item['ACTUAL_YTD_PCTG'] = isset($item_divided_by['ACTUAL_YTD']) && isset($item['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? ($item['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                        $item['LAST_MONTH_YTD_PCTG'] = isset($item_divided_by['LAST_MONTH_YTD']) && isset($item['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? ($item['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                        $item['VARIANCE_YTD_PCTG'] = isset($item['VARIANCE_YTD']) && isset($item['LAST_MONTH_YTD']) && $item['LAST_MONTH_YTD'] != 0 ? ($item['VARIANCE_YTD'] / $item['LAST_MONTH_YTD']) * 100 : 0;
                        $item['LAST_YEAR_YTD_PCTG'] = isset($item_divided_by['LAST_YEAR_YTD']) && isset($item['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0 ? ($item['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;

                        $data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE] = $item;

                    // Jika kode berada dalam GROUPING
                    } else if(isset($data['VALUE_PNL'][$key]['DATA']['GROUPING'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA'])){
                        $item = $data['VALUE_PNL'][$key]['DATA']['GROUPING'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA'];
        
                        // MTD
                        $item['ACTUAL_CURRENT_PCTG'] = isset($item_divided_by['ACTUAL_CURRENT']) && isset($item['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? ($item['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                        $item['LAST_MONTH_CURRENT_PCTG'] = isset($item_divided_by['LAST_MONTH_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? ($item['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                        $item['VARIANCE_CURRENT_PCTG'] = isset($item['VARIANCE_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item['LAST_MONTH_CURRENT'] != 0 ? ($item['VARIANCE_CURRENT'] / $item['LAST_MONTH_CURRENT']) * 100 : 0;
                        $item['LAST_YEAR_CURRENT_PCTG'] = isset($item_divided_by['LAST_YEAR_CURRENT']) && isset($item['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0 ? ($item['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        $item['ACTUAL_YTD_PCTG'] = isset($item_divided_by['ACTUAL_YTD']) && isset($item['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? ($item['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                        $item['LAST_MONTH_YTD_PCTG'] = isset($item_divided_by['LAST_MONTH_YTD']) && isset($item['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? ($item['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                        $item['VARIANCE_YTD_PCTG'] = isset($item['VARIANCE_YTD']) && isset($item['LAST_MONTH_YTD']) && $item['LAST_MONTH_YTD'] != 0 ? ($item['VARIANCE_YTD'] / $item['LAST_MONTH_YTD']) * 100 : 0;
                        $item['LAST_YEAR_YTD_PCTG'] = isset($item_divided_by['LAST_YEAR_YTD']) && isset($item['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0 ? ($item['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;

                        $data['VALUE_PNL'][$key]['DATA']['GROUPING'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA'] = $item;
                    }
                }
            }
        }

        // Ini untuk ROOM Summary ALL
        $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY'] = array(
            'Occupied Average Rate'=>array(
                'ACTUAL_CURRENT' => 0,
                'LAST_MONTH_CURRENT'=>0,
                'VARIANCE_CURRENT'=>0,
                'VARIANCE_CURRENT_PCTG'=>0,
                'LAST_YEAR_CURRENT'=>0,
                'ACTUAL_YTD' => 0,
                'LAST_MONTH_YTD'=>0,
                'VARIANCE_YTD'=>0,
                'VARIANCE_YTD_PCTG'=>0,
                'LAST_YEAR_YTD'=>0
            ),
            'RevPAR'=>array(
                'ACTUAL_CURRENT' => 0,
                'LAST_MONTH_CURRENT'=>0,
                'VARIANCE_CURRENT'=>0,
                'VARIANCE_CURRENT_PCTG'=>0,
                'LAST_YEAR_CURRENT'=>0,
                'ACTUAL_YTD' => 0,
                'LAST_MONTH_YTD'=>0,
                'VARIANCE_YTD'=>0,
                'VARIANCE_YTD_PCTG'=>0,
                'LAST_YEAR_YTD'=>0
            )
        );
        
        try {
            $data['ROOM_STATISTIC_SUMMARY_ALL']['DATA'] = DB::connection('dbayana-dw')
            ->select("EXEC usp_RptPNL_Getdata ?,?,?,?", array($data['MONTH'], $data['YEAR'], $data['COMPANY'], ''));
            $data['ROOM_STATISTIC_SUMMARY_ALL']['DATA'] = collect($data['ROOM_STATISTIC_SUMMARY_ALL']['DATA'])->reject(function($name){
                $type_statistic = isset($name->KPI_CODE) ? $name->KPI_CODE : '-'; 
                // Reject RDT (Room density) karena di summary all tidak perlu ini
                return $type_statistic == 'RDT';
            })->map(function($item, $key) use (&$data){
                // Mencari Occupancy Average Rate berdasarkan Room revenue dan Room Sold
                if(isset($item->KPI_CODE) && $item->KPI_CODE == 'RAS'){
                    $room_stat = [];
                    try {
                        $plant = isset($item->CompanyCode) ? $item->CompanyCode : '';
                        $room_stat_mapping = DB::connection('dbayana-stg')
                        ->table('dbo.PnlRoomStatisticMapping')
                        ->where('PLANT', $plant)
                        ->select('GROUP_REPORT', 'CAT_REPORT_CODE')
                        ->get()->first();
                        if($room_stat_mapping)
                            $room_stat = $room_stat_mapping;
                    } catch(\Exception $e){}

                    // MTD
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($item->ActualMTD) && $item->ActualMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT'] / $item->ActualMTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($item->LastMonthMTD) && $item->LastMonthMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $item->LastMonthMTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_CURRENT'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_CURRENT'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'];
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_CURRENT_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_CURRENT'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT']) * 100 : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_YEAR_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($item->LastYearMTD) && $item->LastYearMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $item->LastYearMTD) : 0;

                    // YTD
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD']) && isset($item->ActualYTD) && $item->ActualYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD'] / $item->ActualYTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($item->LastMonthYTD) && $item->LastMonthYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD'] / $item->LastMonthYTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_YTD'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_YTD'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'];
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_YTD_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_YTD'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD']) * 100 : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_YEAR_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($item->LastYearYTD) && $item->LastYearYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD'] / $item->LastYearYTD) : 0;
                }

                else if(isset($item->KPI_CODE) && $item->KPI_CODE == 'RSS'){
                    $room_stat = [];
                    try {
                        $plant = isset($item->CompanyCode) ? $item->CompanyCode : '';
                        $room_stat_mapping = DB::connection('dbayana-stg')
                        ->table('dbo.PnlRoomStatisticMapping')
                        ->where('PLANT', $plant)
                        ->select('GROUP_REPORT', 'CAT_REPORT_CODE')
                        ->get()->first();
                        if($room_stat_mapping)
                            $room_stat = $room_stat_mapping;
                    } catch(\Exception $e){}
                    
                    // MTD
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($item->ActualMTD) && $item->ActualMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT'] / $item->ActualMTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($item->LastMonthMTD) && $item->LastMonthMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $item->LastMonthMTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_CURRENT'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'];
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT']) * 100 : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_YEAR_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($item->LastYearMTD) && $item->LastYearMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $item->LastYearMTD) : 0;

                    // YTD
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD']) && isset($item->ActualYTD) && $item->ActualYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD'] / $item->ActualYTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($item->LastMonthYTD) && $item->LastMonthYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD'] / $item->LastMonthYTD) : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_YTD'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'];
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD']) * 100 : 0;
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_YEAR_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($item->LastYearYTD) && $item->LastYearYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD'] / $item->LastYearYTD) : 0;
                }

                return $item;
            })->toArray();
        } catch(\Exception $e){}

        // Payroll Trend
        $months = array();
        for ($i = 0; $i < 12; $i++) {
            $timestamp = mktime(0, 0, 0, date('n') - $i, 1);
            $months[date('n', $timestamp)] = array('month_name'=>date('M', $timestamp), 'period'=>sprintf('%02d', date('n', $timestamp)).'/'.date('Y'));
        }
        ksort($months);
        $data['months'] = $months;
        $data['COMPANY_NAME'] = $data['COMPANY'];
        $headcount_payroll_summary = DB::connection('dbayana-stg')
        ->table('dbo.MasterPnlSummary')
        ->where('PLANT', $data['COMPANY'])
        ->whereIn('GROUP_CODE', ['DPT', 'UEX'])
        ->select('GROUP_REPORT')
        ->get()->pluck('GROUP_REPORT')->toArray();

        $data['SUMMARY-ALL']['TOTAL_HEADCOUNT'] = $this->process_headcount_summary($data['COMPANY'], $data['MONTH'], $data['YEAR']);
        $data['SUMMARY-ALL']['TOTAL_PAYROLL'] = $this->process_payroll($data['VALUE_PNL'], $headcount_payroll_summary);
        $data['SUMMARY-ALL']['TOTAL_COST_AGAINTS_REVENUE'] = $this->process_cost_per_revenue($data['SUMMARY-ALL']);
        // dd($data['SUMMARY-ALL']);

        // dd($data['VALUE_PNL']['DAVA']);
        return view('pages.report.finance.pnl_summary', ['data'=>$data]);
    }

    public function pnl_export(Request $request) 
    {
        ini_set('max_execution_time', 1000);
        try {
            date_default_timezone_set('Asia/Makassar');
            $data = [];
            $date_default = date("Y-m-d", mktime(0,0,0,date('n'),1,date('Y')));
            $data['MONTH'] = date('n', strtotime($date_default));
            $data['YEAR'] = date('Y', strtotime($date_default));
            // Default tampil KMS1
            
            // $data['COMPANY'] = null;
            $data['HOTEL_LIST'] = DB::connection('dbintranet')
            ->table('dbo.INT_BUSINESS_PLANT')
            ->where('PLANT_TYPE', 'HOTEL')
            ->orWhere('IS_ADDITIONAL_HOTEL', 'Y')
            ->orderBy('SAP_PLANT_ID')
            ->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')->toArray();
            // Company List untuk report

            // Company untuk mengganti report
            $data['COMPANY_LIST'] = [];        
            if($request->get('month')){
                try {
                    if(in_array($request->get('month'), array_keys($this->pnl_period_exclude_month))){
                        $data['MONTH'] = $request->get('month');
                    } else {
                        $data['MONTH'] = date('n', strtotime('2021-'.$request->get('month').'-01' ));
                    }
                } catch(\Exception $e){}
            }
            if($request->get('year')){
                try {
                    if(in_array($request->get('month'), array_keys($this->pnl_period_exclude_month))){
                        $data['YEAR'] = $request->get('year');
                    } else {
                        $data['YEAR'] = date('Y', strtotime($request->get('year').'-'.$data['MONTH'].'-01' ));
                    }
                    
                } catch(\Exception $e){}
            }
            if($request->get('company')){
                try {
                    if(!in_array($request->get('company'), array_keys($data['HOTEL_LIST']))) {
                        return response()->json(['status'=>'failed', 'message'=>'Company is not available for daily cost report, please check your data'], 400);
                    }
                    $data['COMPANY_LIST'] = array(strtoupper($request->get('company'))=>isset($data['HOTEL_LIST'][$request->get('company')]) ? $data['HOTEL_LIST'][$request->get('company')] : '');
                } catch(\Exception $e){
                    $data['COMPANY_LIST'] = [];
                }
            } else {
                return response()->json(['status'=>'warning', 'message'=>'Please provide a company to lookup'], 200);
            }

            $data_cost = [];
            // dd($data['COMPANY_LIST']);
            foreach($data['COMPANY_LIST'] as $key_plant => $value_plant){
                $check_report = DB::connection('dbayana-stg')
                ->table('dbo.MasterGrpPnlReport')
                ->where('COST_ONLY_YN', 'N')
                ->where('PLANT', $key_plant)
                ->select('GROUP_REPORT', 'GROUP_DESC', 'PROCESSING_TYPE_FUNC', 'REPORT_SORT')
                ->get()->sortBy('REPORT_SORT')->values()->all();

                if(count($check_report)){
                    $data['VALUE_PNL']['summary_all_new'] = [];
                    foreach ($check_report as $key => $value) {
                        if(isset($value->PROCESSING_TYPE_FUNC) && $value->PROCESSING_TYPE_FUNC && $value->PROCESSING_TYPE_FUNC != 'NOR'){
                            $data[$value->GROUP_REPORT] = DB::connection('dbayana-stg')
                            ->select("EXEC dbo.sap_pnl_report ?,?,?,?", array($value->GROUP_REPORT, $key_plant, $data['YEAR'], $data['MONTH']));

                            switch ($value->PROCESSING_TYPE_FUNC) {
                              case 'DEX':
                                $data[$value->GROUP_REPORT] = $this->departmental_expense_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'RMR':
                                $data[$value->GROUP_REPORT] = $this->room_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR'], $key_plant);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'FBV' :
                                $data[$value->GROUP_REPORT] = $this->fnb_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'FNB' :
                                $data[$value->GROUP_REPORT] = $this->fnb_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'OER' :
                                $data[$value->GROUP_REPORT] = $this->other_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              default:
                                break;
                            }

                            $data['VALUE_PNL'][$value->GROUP_REPORT] = array('DATA'=>$data[$value->GROUP_REPORT], 'DESC'=>$value->GROUP_DESC);
                        }
                    }

                    // SUMMARY ALL
                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT'] = array(
                        'ACTUAL_CURRENT'=>0,
                        'LAST_MONTH_CURRENT'=>0,
                        'VARIANCE_CURRENT'=>0,
                        'LAST_YEAR_CURRENT'=>0,

                        'ACTUAL_YTD'=>0,
                        'LAST_MONTH_YTD'=>0,
                        'VARIANCE_YTD'=>0,
                        'LAST_YEAR_YTD'=>0,
                    );
                    $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME'] = array(
                        'ACTUAL_CURRENT'=>0,
                        'LAST_MONTH_CURRENT'=>0,
                        'VARIANCE_CURRENT'=>0,
                        'LAST_YEAR_CURRENT'=>0,

                        'ACTUAL_YTD'=>0,
                        'LAST_MONTH_YTD'=>0,
                        'VARIANCE_YTD'=>0,
                        'LAST_YEAR_YTD'=>0,
                    );

                    $data['SUMMARY-ALL']['SUMMARY'] = DB::connection('dbayana-stg')
                    ->table('dbo.MasterPnlSummary')
                    ->where('PLANT', $key_plant)
                    ->get()->sortBy([
                        ['CATEGORY_ID', 'asc'],
                        ['SEQ_ID', 'asc'],
                    ])->groupBy('GROUP_CODE')->mapWithKeys(function($item, $key) use (&$data) {
                        // Cek Data mapping per item
                        $new_item = $item->map(function($item, $key) use (&$data){
                            // dd($item, $data);
                            if(isset($item->MAPPING_CODE) && strtolower($item->MAPPING_CODE) != 'departmental_profit'){
                                $check_grouping = explode('#', $item->MAPPING_CODE);
                                // dd($check_grouping);
                                $item->ACTUAL_CURRENT = 0;
                                $item->LAST_MONTH_CURRENT = 0; 
                                $item->VARIANCE_CURRENT = 0;
                                $item->LAST_YEAR_CURRENT = 0;

                                $item->ACTUAL_YTD = 0;
                                $item->LAST_MONTH_YTD = 0; 
                                $item->VARIANCE_YTD = 0;
                                $item->LAST_YEAR_YTD = 0;

                                foreach ($check_grouping as $grouping_code) {
                                        # code...
                                    $item->ACTUAL_CURRENT +=    
                                        isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_CURRENT']) ?
                                        $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
                                    $item->LAST_MONTH_CURRENT +=
                                        isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ?
                                        $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
                                    $item->LAST_YEAR_CURRENT +=
                                        isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ?
                                        $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;

                                    // YTD
                                    $item->ACTUAL_YTD += 
                                        isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_YTD']) ?
                                        $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
                                    $item->LAST_MONTH_YTD += 
                                        isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_YTD']) ?
                                        $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
                                    $item->LAST_YEAR_YTD += 
                                        isset($data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_YTD']) ?
                                        $data[$item->GROUP_REPORT][$item->GROUP_REPORT][$grouping_code]['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
                                }
                                $item->VARIANCE_CURRENT += $item->ACTUAL_CURRENT - $item->LAST_MONTH_CURRENT;
                                $item->VARIANCE_YTD += $item->ACTUAL_YTD - $item->LAST_MONTH_YTD;



                            }
                            else {
                                // MTD
                                $item->ACTUAL_CURRENT = 
                                    isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_CURRENT']) ?
                                    $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_CURRENT'] : 0;
                                $item->LAST_MONTH_CURRENT = 
                                    isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_CURRENT']) ?
                                    $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_CURRENT'] : 0;
                                $item->VARIANCE_CURRENT = $item->ACTUAL_CURRENT - $item->LAST_MONTH_CURRENT;
                                $item->LAST_YEAR_CURRENT = 
                                    isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_CURRENT']) ?
                                    $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_CURRENT'] : 0;

                                // YTD
                                $item->ACTUAL_YTD = 
                                    isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_YTD']) ?
                                    $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['ACTUAL_YTD'] : 0;
                                $item->LAST_MONTH_YTD = 
                                    isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_YTD']) ?
                                    $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_MONTH_YTD'] : 0;
                                $item->VARIANCE_YTD = $item->ACTUAL_YTD - $item->LAST_MONTH_YTD;
                                $item->LAST_YEAR_YTD = 
                                    isset($data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_YTD']) ?
                                    $data[$item->GROUP_REPORT]['DEPARTMENTAL_PROFIT']['LAST_YEAR_YTD'] : 0;
                            }

                            // jumlahkan unallocated expenses untuk gross
                            // TAMBAHKAN JIKA DEPARTMENTAL PROFIT
                            if(strtoupper($item->GROUP_CODE) == 'DPT'){
                                try {
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] += $item->ACTUAL_CURRENT;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] += $item->LAST_MONTH_CURRENT;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_CURRENT'] += $item->VARIANCE_CURRENT;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] += $item->LAST_YEAR_CURRENT;

                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] += $item->ACTUAL_YTD;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] += $item->LAST_MONTH_YTD;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_YTD'] += $item->VARIANCE_YTD;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] += $item->LAST_YEAR_YTD;
                                } catch(\Exception $e){}
                            }
                            // KURANGKAN JIKA UNALLOCATED EXPENSE
                            else if(strtoupper($item->GROUP_CODE) == 'UEX'){
                                try {
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] -= $item->ACTUAL_CURRENT;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] -= $item->LAST_MONTH_CURRENT;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_CURRENT'] -= $item->VARIANCE_CURRENT;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] -= $item->LAST_YEAR_CURRENT;

                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] -= $item->ACTUAL_YTD;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] -= $item->LAST_MONTH_YTD;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['VARIANCE_YTD'] -= $item->VARIANCE_YTD;
                                    $data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] -= $item->LAST_YEAR_YTD;
                                } catch(\Exception $e){}
                            }
                            return $item;
                        });
                        // dd($new_item);
                        // SUM MTD
                        $sum_data['ACTUAL_CURRENT'] = $new_item->sum('ACTUAL_CURRENT');
                        $sum_data['LAST_MONTH_CURRENT'] = $new_item->sum('LAST_MONTH_CURRENT');
                        $sum_data['VARIANCE_CURRENT'] = $new_item->sum('VARIANCE_CURRENT');
                        $sum_data['LAST_YEAR_CURRENT'] = $new_item->sum('LAST_YEAR_CURRENT');
                        // SUM YTD
                        $sum_data['ACTUAL_YTD'] = $new_item->sum('ACTUAL_YTD');
                        $sum_data['LAST_MONTH_YTD'] = $new_item->sum('LAST_MONTH_YTD');
                        $sum_data['VARIANCE_YTD'] = $new_item->sum('VARIANCE_YTD');
                        $sum_data['LAST_YEAR_YTD'] = $new_item->sum('LAST_YEAR_YTD');


                        return [$key=>array('DATA_CATEGORY'=>$new_item->toArray(), 'SUM_CATEGORY'=>$sum_data)];
                    })->toArray();
                    
                    // Memasukkan Other deduction ke group summary
                    if(count($data['SUMMARY-ALL']['SUMMARY'])){
                        // GET OTHER DEDUCTION COMPANY
                        $get_oth_ded_company = DB::connection('dbayana-stg')
                        ->table('dbo.MasterGrpPnlReport')
                        ->where('PLANT', $key_plant)
                        ->where('GROUP_REPORT', 'like', 'OTHDED%')
                        ->select('GROUP_REPORT')
                        ->get()->pluck('GROUP_REPORT')->first();

                        $oth_deduc_summary_all = DB::connection('dbayana-stg')
                        ->select("EXEC dbo.sap_pnl_report ?,?,?,?", array($get_oth_ded_company, $key_plant, $data['YEAR'], $data['MONTH']));
                        if($oth_deduc_summary_all){
                            $oth_deduc_summary_all = collect($oth_deduc_summary_all)->groupBy('GROUP_REPORT')->filter()->mapWithKeys(function($item, $key) use (&$data){
                                // SUM MTD
                                $sum_data['ACTUAL_CURRENT'] = $item->sum('ACTUAL_CURRENT_PERIOD');
                                $sum_data['LAST_MONTH_CURRENT'] = $item->sum('LAST_MONTH_CURRENT_PERIOD');
                                $sum_data['VARIANCE_CURRENT'] = $item->sum('VARIANCE_CURRENT_PERIOD');
                                $sum_data['LAST_YEAR_CURRENT'] = $item->sum('LAST_YEAR_CURRENT_PERIOD');
                                // SUM YTD
                                $sum_data['ACTUAL_YTD'] = $item->sum('ACTUAL_YTD');
                                $sum_data['LAST_MONTH_YTD'] = $item->sum('LAST_MONTH_YTD');
                                $sum_data['VARIANCE_YTD'] = $item->sum('VARIANCE_YTD');
                                $sum_data['LAST_YEAR_YTD'] = $item->sum('LAST_YEAR_YTD');

                                $item = collect($item)->map(function($item, $key){
                                    $item->ACTUAL_CURRENT = isset($item->ACTUAL_CURRENT_PERIOD) ? $item->ACTUAL_CURRENT_PERIOD : 0;
                                    $item->LAST_MONTH_CURRENT = isset($item->LAST_MONTH_CURRENT_PERIOD) ? $item->LAST_MONTH_CURRENT_PERIOD : 0;
                                    $item->VARIANCE_CURRENT = isset($item->VARIANCE_CURRENT_PERIOD) ? $item->VARIANCE_CURRENT_PERIOD : 0;
                                    $item->LAST_YEAR_CURRENT = isset($item->LAST_YEAR_CURRENT_PERIOD) ? $item->LAST_YEAR_CURRENT_PERIOD : 0;
                                    $item->CATEGORY = isset($item->DESC_COA_COST_CENTER) ? $item->DESC_COA_COST_CENTER : 0;
                                    $item->GROUP_DESC = isset($item->CATEGORY_REPORT) ? $item->CATEGORY_REPORT : 0;
                                    return $item;  
                                });

                                // MTD
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] - $sum_data['ACTUAL_CURRENT']);
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] - $sum_data['LAST_MONTH_CURRENT']);
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_CURRENT'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT']);
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_CURRENT'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] - $sum_data['LAST_YEAR_CURRENT']);

                                // YTD
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] - $sum_data['ACTUAL_YTD']);
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] - $sum_data['LAST_MONTH_YTD']);
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_YTD'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD']);
                                $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_YTD'] = 
                                    ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] - $sum_data['LAST_YEAR_YTD']);

                                $data['SUMMARY-ALL']['SUMMARY'][$key] = array('DATA_CATEGORY'=>$item->toArray(), 'SUM_CATEGORY'=>$sum_data);
                                return [];
                            });
                        } else {
                            // MTD
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_CURRENT'] - 0);
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_CURRENT'] - 0);
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_CURRENT'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_CURRENT'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_CURRENT']);
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_CURRENT'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_CURRENT'] - 0);

                            // YTD
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['ACTUAL_YTD'] - 0);
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_MONTH_YTD'] - 0);
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['VARIANCE_YTD'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['ACTUAL_YTD'] - $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_MONTH_YTD']);
                            $data['SUMMARY-ALL']['GROUPING']['NETT_OPERATING_INCOME']['LAST_YEAR_YTD'] = 
                                ($data['SUMMARY-ALL']['GROUPING']['GROSS_OPERATING_PROFIT']['LAST_YEAR_YTD'] - 0);
                        }
                    }

                    // Grouping untuk summary ALL 
                    $data['SUMMARY-ALL']['SUMMARY'] = collect($data['SUMMARY-ALL']['SUMMARY'])->mapWithKeys(function($item, $key) use ($data){
                        if($key == 'SIN'){
                            $each_item = isset($item['DATA_CATEGORY']) ? $item['DATA_CATEGORY'] : [];
                            $each_item_summary = isset($item['SUM_CATEGORY']) ? $item['SUM_CATEGORY'] : [];

                            $each_data = collect($each_item)->map(function($item, $key) use ($each_item_summary){
                                $actual_current_period_pctg = 0;
                                $last_month_current_period_pctg = 0;
                                $variance_current_period_pctg = 0;
                                $last_year_current_period_pctg = 0;

                                $actual_ytd_pctg = 0;
                                $last_month_ytd_pctg = 0;
                                $variance_ytd_pctg = 0;
                                $last_year_ytd_pctg = 0;

                                // Cek untuk tidak dibagi dengan 0
                                // MTD
                                if(isset($each_item_summary['ACTUAL_CURRENT']) && $each_item_summary['ACTUAL_CURRENT'] != 0)
                                    $actual_current_period_pctg = isset($item->ACTUAL_CURRENT) ? ($item->ACTUAL_CURRENT / $each_item_summary['ACTUAL_CURRENT']) * 100 : 0;
                                if(isset($each_item_summary['LAST_MONTH_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                                    $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT) ? ($item->LAST_MONTH_CURRENT / $each_item_summary['LAST_MONTH_CURRENT']) * 100 : 0;
                                if(isset($item->LAST_MONTH_CURRENT) && $item->LAST_MONTH_CURRENT != 0)
                                    $variance_current_period_pctg = isset($item->VARIANCE_CURRENT) ? ($item->VARIANCE_CURRENT / $item->LAST_MONTH_CURRENT) * 100 : 0;
                                if(isset($each_item_summary['LAST_YEAR_CURRENT']) && $each_item_summary['LAST_YEAR_CURRENT'] != 0)
                                    $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT) ? ($item->LAST_YEAR_CURRENT / $each_item_summary['LAST_YEAR_CURRENT']) * 100 : 0;

                                // YTD
                                if(isset($each_item_summary['ACTUAL_YTD']) && $each_item_summary['ACTUAL_YTD'] !=  0)
                                    $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $each_item_summary['ACTUAL_YTD']) * 100 : 0;
                                if(isset($each_item_summary['LAST_MONTH_YTD']) && $each_item_summary['LAST_MONTH_YTD'] !=  0)
                                    $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $each_item_summary['LAST_MONTH_YTD']) * 100 : 0;
                                if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                                    $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                                if(isset($each_item_summary['LAST_YEAR_YTD']) && $each_item_summary['LAST_YEAR_YTD'] !=  0)
                                    $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $each_item_summary['LAST_YEAR_YTD']) * 100 : 0;

                                // MTD
                                $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                                $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                                $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                                $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                                // YTD
                                $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                                $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                                $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                                $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                                return $item;
                            });

                            $each_item_summary['ACTUAL_CURRENT_PCTG'] = $each_data->sum('ACTUAL_CURRENT_PCTG');
                            $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = $each_data->sum('LAST_MONTH_CURRENT_PCTG');
                            if(isset($each_item_summary['LAST_MONTH_CURRENT']) && isset($each_item_summary['VARIANCE_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                                $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                            $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = $each_data->sum('LAST_YEAR_CURRENT_PCTG');

                            $each_item_summary['ACTUAL_YTD_PCTG'] = $each_data->sum('ACTUAL_YTD_PCTG');
                            $each_item_summary['LAST_MONTH_YTD_PCTG'] = $each_data->sum('LAST_MONTH_YTD_PCTG');
                            if(isset($each_item_summary['LAST_MONTH_YTD']) && isset($each_item_summary['VARIANCE_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                                $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                            $each_item_summary['LAST_YEAR_YTD_PCTG'] = $each_data->sum('LAST_YEAR_YTD_PCTG');

                        } else {
                            $each_item = isset($item['DATA_CATEGORY']) ? $item['DATA_CATEGORY'] : [];
                            $each_item_summary = isset($item['SUM_CATEGORY']) ? $item['SUM_CATEGORY'] : [];
                            $item_divided_by = isset($data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY']) ? $data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY'] : [];
                            $each_data = collect($each_item)->map(function($item, $key) use ($item_divided_by, $data){
                                $actual_current_period_pctg = 0;
                                $last_month_current_period_pctg = 0;
                                $variance_current_period_pctg = 0;
                                $last_year_current_period_pctg = 0;

                                $actual_ytd_pctg = 0;
                                $last_month_ytd_pctg = 0;
                                $variance_ytd_pctg = 0;
                                $last_year_ytd_pctg = 0;

                                $type_revenue = isset($item->GROUP_CODE) ? strtoupper($item->GROUP_CODE) : '-';
                                if(strtoupper($type_revenue) == 'DPT'){
                                    $separate_rev_code = explode('#', $item->DIVIDED_BY_CAT_REPORT);
                                    $total_rev = [
                                        'ACTUAL_CURRENT'=>0,
                                        'LAST_MONTH_CURRENT'=>0,
                                        'LAST_YEAR_CURRENT'=>0,
                                        'ACTUAL_YTD'=>0,
                                        'LAST_MONTH_YTD'=>0,
                                        'LAST_YEAR_YTD'=>0
                                    ];
                                    for($i=0;$i<count($separate_rev_code);$i++){
                                        // MTD
                                        $total_rev['ACTUAL_CURRENT'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_CURRENT']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_CURRENT'] : 0;
                                        $total_rev['LAST_MONTH_CURRENT'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] : 0;
                                        $total_rev['LAST_YEAR_CURRENT'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] : 0;

                                        // YTD
                                        $total_rev['ACTUAL_YTD'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_YTD']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['ACTUAL_YTD'] : 0;
                                        $total_rev['LAST_MONTH_YTD'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_YTD']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_MONTH_YTD'] : 0;
                                        $total_rev['LAST_YEAR_YTD'] += isset($data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_YTD']) ? $data[$item->DIVIDED_BY_GROUP_REPORT][$item->DIVIDED_BY_GROUP_REPORT][$separate_rev_code[$i]]['SUM_CATEGORY']['LAST_YEAR_YTD'] : 0;
                                    }

                                    // MTD
                                    if(isset($total_rev['ACTUAL_CURRENT'])){
                                        $actual_current_period_pctg = isset($total_rev['ACTUAL_CURRENT']) && $total_rev['ACTUAL_CURRENT'] != 0 ? 
                                        ($item->ACTUAL_CURRENT / $total_rev['ACTUAL_CURRENT']) * 100 : 0;
                                    } else {
                                        $actual_current_period_pctg = isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? 
                                        ($item->ACTUAL_CURRENT / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                                    }

                                    if(isset($total_rev['LAST_MONTH_CURRENT'])){
                                        $last_month_current_period_pctg = isset($total_rev['LAST_MONTH_CURRENT']) && $total_rev['LAST_MONTH_CURRENT'] != 0 ? 
                                            ($item->LAST_MONTH_CURRENT / $total_rev['LAST_MONTH_CURRENT']) * 100 : 0;
                                    } else {
                                        $last_month_current_period_pctg = isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? 
                                            ($item->LAST_MONTH_CURRENT / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                                    }

                                    $variance_current_period_pctg = isset($item->VARIANCE_CURRENT) && $item->LAST_MONTH_CURRENT != 0 ? ($item->VARIANCE_CURRENT / $item->LAST_MONTH_CURRENT) * 100 : 0;

                                    if(isset($total_rev['LAST_YEAR_CURRENT'])){
                                        $last_year_current_period_pctg = isset($total_rev['LAST_YEAR_CURRENT']) && $total_rev['LAST_YEAR_CURRENT'] != 0 ? 
                                            ($item->LAST_YEAR_CURRENT / $total_rev['LAST_YEAR_CURRENT']) * 100 : 0;
                                    } else {
                                        $last_year_current_period_pctg = isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? 
                                            ($item->LAST_YEAR_CURRENT / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                                    }

                                    // YTD
                                    if(isset($total_rev['ACTUAL_YTD'])){
                                        $actual_ytd_pctg = isset($total_rev['ACTUAL_YTD']) && $total_rev['ACTUAL_YTD'] != 0 ? 
                                        ($item->ACTUAL_YTD / $total_rev['ACTUAL_YTD']) * 100 : 0;
                                    } else {
                                        $actual_ytd_pctg = isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? 
                                        ($item->ACTUAL_YTD / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                                    }

                                    if(isset($total_rev['LAST_MONTH_YTD'])){
                                        $last_month_ytd_pctg = isset($total_rev['LAST_MONTH_YTD']) && $total_rev['LAST_MONTH_YTD'] != 0 ? 
                                            ($item->LAST_MONTH_YTD / $total_rev['LAST_MONTH_YTD']) * 100 : 0;
                                    } else {
                                        $last_month_ytd_pctg = isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? 
                                            ($item->LAST_MONTH_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                                    }

                                    $variance_ytd_pctg = isset($item->VARIANCE_YTD) && $item->LAST_MONTH_YTD != 0 ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;

                                    if(isset($total_rev['LAST_YEAR_YTD'])){
                                        $last_year_ytd_pctg = isset($total_rev['LAST_YEAR_YTD']) && $total_rev['LAST_YEAR_YTD'] != 0 ? 
                                            ($item->LAST_YEAR_YTD / $total_rev['LAST_YEAR_YTD']) * 100 : 0;
                                    } else {
                                        $last_year_ytd_pctg = isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? 
                                            ($item->LAST_YEAR_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                                    }

                                } else {
                                    // Cek untuk tidak dibagi dengan 0
                                    // MTD
                                    if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                                        $actual_current_period_pctg = isset($item->ACTUAL_CURRENT) ? ($item->ACTUAL_CURRENT / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                                    if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                                        $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT) ? ($item->LAST_MONTH_CURRENT / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                                    if(isset($item->LAST_MONTH_CURRENT) && $item->LAST_MONTH_CURRENT != 0)
                                        $variance_current_period_pctg = isset($item->VARIANCE_CURRENT) ? ($item->VARIANCE_CURRENT / $item->LAST_MONTH_CURRENT) * 100 : 0;
                                    if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                                        $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT) ? ($item->LAST_YEAR_CURRENT / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                                    // YTD
                                    if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] !=  0)
                                        $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                                    if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] !=  0)
                                        $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                                    if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                                        $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                                    if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] !=  0)
                                        $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;
                                }

                                // MTD
                                $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                                $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                                $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                                $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                                // YTD
                                $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                                $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                                $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                                $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                                return $item;
                            });
                            
                            // MTD
                            if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                                $each_item_summary['ACTUAL_CURRENT_PCTG'] = ($each_item_summary['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100;
                            else 
                                $each_item_summary['ACTUAL_CURRENT_PCTG'] = 0;
                            if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                                $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = ($each_item_summary['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100;
                            else
                                $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = 0;
                            if(isset($each_item_summary['LAST_MONTH_CURRENT']) && isset($each_item_summary['VARIANCE_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                                $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                            else 
                                $each_item_summary['VARIANCE_CURRENT_PCTG'] = 0;
                            if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                                $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = ($each_item_summary['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100;
                            else
                                $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = 0;

                            // YTD
                            if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0)
                                $each_item_summary['ACTUAL_YTD_PCTG'] = ($each_item_summary['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100;
                            else 
                                $each_item_summary['ACTUAL_YTD_PCTG'] = 0;
                            if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0)
                                $each_item_summary['LAST_MONTH_YTD_PCTG'] = ($each_item_summary['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100;
                            else
                                $each_item_summary['LAST_MONTH_YTD_PCTG'] = 0;
                            if(isset($each_item_summary['LAST_MONTH_YTD']) && isset($each_item_summary['VARIANCE_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                                $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                            else 
                                $each_item_summary['VARIANCE_YTD_PCTG'] = 0;
                            if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0)
                                $each_item_summary['LAST_YEAR_YTD_PCTG'] = ($each_item_summary['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100;
                            else
                                $each_item_summary['LAST_YEAR_YTD_PCTG'] = 0;
                        }
                        // Map new data if exists to the key
                        if(isset($each_data))
                            return [$key=>array('DATA_CATEGORY'=>$each_data->toArray(), 'SUM_CATEGORY'=>$each_item_summary)];
                        // Return unprocessed data to the key
                        else 
                            return [$key=>$item];
                    })->toArray();

                    $data['SUMMARY-ALL']['GROUPING'] = collect($data['SUMMARY-ALL']['GROUPING'])->map(function($item, $key) use ($data){
                        $item_divided_by = isset($data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY']) ? $data['SUMMARY-ALL']['SUMMARY']['SIN']['SUM_CATEGORY'] : [];
                        // MTD
                        $item['ACTUAL_CURRENT_PCTG'] = isset($item_divided_by['ACTUAL_CURRENT']) && isset($item['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? ($item['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                        $item['LAST_MONTH_CURRENT_PCTG'] = isset($item_divided_by['LAST_MONTH_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? ($item['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                        $item['VARIANCE_CURRENT_PCTG'] = isset($item['VARIANCE_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item['LAST_MONTH_CURRENT'] != 0 ? ($item['VARIANCE_CURRENT'] / $item['LAST_MONTH_CURRENT']) * 100 : 0;
                        $item['LAST_YEAR_CURRENT_PCTG'] = isset($item_divided_by['LAST_YEAR_CURRENT']) && isset($item['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0 ? ($item['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                        // YTD
                        $item['ACTUAL_YTD_PCTG'] = isset($item_divided_by['ACTUAL_YTD']) && isset($item['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? ($item['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                        $item['LAST_MONTH_YTD_PCTG'] = isset($item_divided_by['LAST_MONTH_YTD']) && isset($item['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? ($item['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                        $item['VARIANCE_YTD_PCTG'] = isset($item['VARIANCE_YTD']) && isset($item['LAST_MONTH_YTD']) && $item['LAST_MONTH_YTD'] != 0 ? ($item['VARIANCE_YTD'] / $item['LAST_MONTH_YTD']) * 100 : 0;
                        $item['LAST_YEAR_YTD_PCTG'] = isset($item_divided_by['LAST_YEAR_YTD']) && isset($item['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0 ? ($item['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;
                        return $item;
                    })->toArray();

                    // START PNL DATA DIVIDED BY SUMMARY DATA
                    $data_divided_by_summary = DB::connection('dbayana-stg')
                    ->table('dbo.MasterPnlDividedBySummary')
                    ->where(['PLANT_ID'=>$key_plant, 'DIVIDED_BY_SUMMARY_NOT_GROUP'=>'Y'])
                    ->select('REPORT_CAT', 'CATEGORY_CODE', 'DIVIDED_BY_SUMMARY_OR_GROUP_CODE AS SUMMARY_CODE')
                    ->get()->groupBy('REPORT_CAT')->toArray();
                    // dd($data['SUMMARY-ALL'], $data['VALUE_PNL']['AG']['DATA'], $data_divided_by_summary);

                    if(count($data_divided_by_summary)){
                        foreach($data_divided_by_summary as $key => $val){
                            for($dtsm=0;$dtsm<count($val);$dtsm++){
                                $item_divided_by = isset($data['SUMMARY-ALL']['SUMMARY'][$val[$dtsm]->SUMMARY_CODE]['SUM_CATEGORY']) ? $data['SUMMARY-ALL']['SUMMARY'][$val[$dtsm]->SUMMARY_CODE]['SUM_CATEGORY'] : [];

                                // Jika kode berada dalam category
                                if(isset($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE])) {
                                    $each_item_summary = isset($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['SUM_CATEGORY']) ? $data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['SUM_CATEGORY'] : [];

                                    if(isset($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA_CATEGORY'])){
                                        $data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA_CATEGORY'] = collect($data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA_CATEGORY'])->map(function($item, $key) use ($item_divided_by, $data){
                                            $actual_current_period_pctg = 0;
                                            $last_month_current_period_pctg = 0;
                                            $variance_current_period_pctg = 0;
                                            $last_year_current_period_pctg = 0;

                                            $actual_ytd_pctg = 0;
                                            $last_month_ytd_pctg = 0;
                                            $variance_ytd_pctg = 0;
                                            $last_year_ytd_pctg = 0;

                                            
                                            // MTD
                                            if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                                                $actual_current_period_pctg = isset($item->ACTUAL_CURRENT_PERIOD) ? ($item->ACTUAL_CURRENT_PERIOD / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                                            if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                                                $last_month_current_period_pctg = isset($item->LAST_MONTH_CURRENT_PERIOD) ? ($item->LAST_MONTH_CURRENT_PERIOD / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                                            if(isset($item->LAST_MONTH_CURRENT_PERIOD) && $item->LAST_MONTH_CURRENT_PERIOD != 0)
                                                $variance_current_period_pctg = isset($item->VARIANCE_CURRENT_PERIOD) ? ($item->VARIANCE_CURRENT_PERIOD / $item->LAST_MONTH_CURRENT_PERIOD) * 100 : 0;
                                            if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                                                $last_year_current_period_pctg = isset($item->LAST_YEAR_CURRENT_PERIOD) ? ($item->LAST_YEAR_CURRENT_PERIOD / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                                            // YTD
                                            if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] !=  0)
                                                $actual_ytd_pctg = isset($item->ACTUAL_YTD) ? ($item->ACTUAL_YTD / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                                            if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] !=  0)
                                                $last_month_ytd_pctg = isset($item->LAST_MONTH_YTD) ? ($item->LAST_MONTH_YTD / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                                            if(isset($item->LAST_MONTH_YTD) && $item->LAST_MONTH_YTD != 0)
                                                $variance_ytd_pctg = isset($item->VARIANCE_YTD) ? ($item->VARIANCE_YTD / $item->LAST_MONTH_YTD) * 100 : 0;
                                            if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] !=  0)
                                                $last_year_ytd_pctg = isset($item->LAST_YEAR_YTD) ? ($item->LAST_YEAR_YTD / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;

                                            // MTD
                                            $item->ACTUAL_CURRENT_PCTG = $actual_current_period_pctg;
                                            $item->LAST_MONTH_CURRENT_PCTG = $last_month_current_period_pctg;
                                            $item->VARIANCE_CURRENT_PCTG = $variance_current_period_pctg;
                                            $item->LAST_YEAR_CURRENT_PCTG = $last_year_current_period_pctg;

                                            // YTD
                                            $item->ACTUAL_YTD_PCTG = $actual_ytd_pctg;
                                            $item->LAST_MONTH_YTD_PCTG = $last_month_ytd_pctg;
                                            $item->VARIANCE_YTD_PCTG = $variance_ytd_pctg;
                                            $item->LAST_YEAR_YTD_PCTG = $last_year_ytd_pctg;

                                            return $item;
                                        });
                                    }

                                    // MTD
                                    if(isset($item_divided_by['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0)
                                        $each_item_summary['ACTUAL_CURRENT_PCTG'] = ($each_item_summary['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100;
                                    else 
                                        $each_item_summary['ACTUAL_CURRENT_PCTG'] = 0;
                                    if(isset($item_divided_by['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0)
                                        $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = ($each_item_summary['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100;
                                    else
                                        $each_item_summary['LAST_MONTH_CURRENT_PCTG'] = 0;
                                    if(isset($each_item_summary['LAST_MONTH_CURRENT']) && isset($each_item_summary['VARIANCE_CURRENT']) && $each_item_summary['LAST_MONTH_CURRENT'] != 0)
                                        $each_item_summary['VARIANCE_CURRENT_PCTG'] = ($each_item_summary['VARIANCE_CURRENT'] / $each_item_summary['LAST_MONTH_CURRENT']) * 100;
                                    else 
                                        $each_item_summary['VARIANCE_CURRENT_PCTG'] = 0;
                                    if(isset($item_divided_by['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0)
                                        $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = ($each_item_summary['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100;
                                    else
                                        $each_item_summary['LAST_YEAR_CURRENT_PCTG'] = 0;

                                    // YTD
                                    if(isset($item_divided_by['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0)
                                        $each_item_summary['ACTUAL_YTD_PCTG'] = ($each_item_summary['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100;
                                    else 
                                        $each_item_summary['ACTUAL_YTD_PCTG'] = 0;
                                    if(isset($item_divided_by['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0)
                                        $each_item_summary['LAST_MONTH_YTD_PCTG'] = ($each_item_summary['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100;
                                    else
                                        $each_item_summary['LAST_MONTH_YTD_PCTG'] = 0;
                                    if(isset($each_item_summary['LAST_MONTH_YTD']) && isset($each_item_summary['VARIANCE_YTD']) && $each_item_summary['LAST_MONTH_YTD'] != 0)
                                        $each_item_summary['VARIANCE_YTD_PCTG'] = ($each_item_summary['VARIANCE_YTD'] / $each_item_summary['LAST_MONTH_YTD']) * 100;
                                    else 
                                        $each_item_summary['VARIANCE_YTD_PCTG'] = 0;
                                    if(isset($item_divided_by['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0)
                                        $each_item_summary['LAST_YEAR_YTD_PCTG'] = ($each_item_summary['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100;
                                    else
                                        $each_item_summary['LAST_YEAR_YTD_PCTG'] = 0;

                                    $data['VALUE_PNL'][$key]['DATA'][$key][$val[$dtsm]->CATEGORY_CODE]['SUM_CATEGORY'] = $each_item_summary;

                                // Jika kode berada dalam DEPARTMENTAL_PROFIT
                                } else if(isset($data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE])){
                                    $item = isset($data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE]) ? $data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE] : [];
                    
                                    // MTD
                                    $item['ACTUAL_CURRENT_PCTG'] = isset($item_divided_by['ACTUAL_CURRENT']) && isset($item['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? ($item['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                                    $item['LAST_MONTH_CURRENT_PCTG'] = isset($item_divided_by['LAST_MONTH_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? ($item['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $item['VARIANCE_CURRENT_PCTG'] = isset($item['VARIANCE_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item['LAST_MONTH_CURRENT'] != 0 ? ($item['VARIANCE_CURRENT'] / $item['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $item['LAST_YEAR_CURRENT_PCTG'] = isset($item_divided_by['LAST_YEAR_CURRENT']) && isset($item['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0 ? ($item['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                                    // YTD
                                    $item['ACTUAL_YTD_PCTG'] = isset($item_divided_by['ACTUAL_YTD']) && isset($item['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? ($item['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                                    $item['LAST_MONTH_YTD_PCTG'] = isset($item_divided_by['LAST_MONTH_YTD']) && isset($item['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? ($item['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                                    $item['VARIANCE_YTD_PCTG'] = isset($item['VARIANCE_YTD']) && isset($item['LAST_MONTH_YTD']) && $item['LAST_MONTH_YTD'] != 0 ? ($item['VARIANCE_YTD'] / $item['LAST_MONTH_YTD']) * 100 : 0;
                                    $item['LAST_YEAR_YTD_PCTG'] = isset($item_divided_by['LAST_YEAR_YTD']) && isset($item['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0 ? ($item['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;

                                    $data['VALUE_PNL'][$key]['DATA'][$val[$dtsm]->CATEGORY_CODE] = $item;

                                // Jika kode berada dalam GROUPING
                                } else if(isset($data['VALUE_PNL'][$key]['DATA']['GROUPING'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA'])){
                                    $item = $data['VALUE_PNL'][$key]['DATA']['GROUPING'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA'];
                    
                                    // MTD
                                    $item['ACTUAL_CURRENT_PCTG'] = isset($item_divided_by['ACTUAL_CURRENT']) && isset($item['ACTUAL_CURRENT']) && $item_divided_by['ACTUAL_CURRENT'] != 0 ? ($item['ACTUAL_CURRENT'] / $item_divided_by['ACTUAL_CURRENT']) * 100 : 0;
                                    $item['LAST_MONTH_CURRENT_PCTG'] = isset($item_divided_by['LAST_MONTH_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item_divided_by['LAST_MONTH_CURRENT'] != 0 ? ($item['LAST_MONTH_CURRENT'] / $item_divided_by['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $item['VARIANCE_CURRENT_PCTG'] = isset($item['VARIANCE_CURRENT']) && isset($item['LAST_MONTH_CURRENT']) && $item['LAST_MONTH_CURRENT'] != 0 ? ($item['VARIANCE_CURRENT'] / $item['LAST_MONTH_CURRENT']) * 100 : 0;
                                    $item['LAST_YEAR_CURRENT_PCTG'] = isset($item_divided_by['LAST_YEAR_CURRENT']) && isset($item['LAST_YEAR_CURRENT']) && $item_divided_by['LAST_YEAR_CURRENT'] != 0 ? ($item['LAST_YEAR_CURRENT'] / $item_divided_by['LAST_YEAR_CURRENT']) * 100 : 0;

                                    // YTD
                                    $item['ACTUAL_YTD_PCTG'] = isset($item_divided_by['ACTUAL_YTD']) && isset($item['ACTUAL_YTD']) && $item_divided_by['ACTUAL_YTD'] != 0 ? ($item['ACTUAL_YTD'] / $item_divided_by['ACTUAL_YTD']) * 100 : 0;
                                    $item['LAST_MONTH_YTD_PCTG'] = isset($item_divided_by['LAST_MONTH_YTD']) && isset($item['LAST_MONTH_YTD']) && $item_divided_by['LAST_MONTH_YTD'] != 0 ? ($item['LAST_MONTH_YTD'] / $item_divided_by['LAST_MONTH_YTD']) * 100 : 0;
                                    $item['VARIANCE_YTD_PCTG'] = isset($item['VARIANCE_YTD']) && isset($item['LAST_MONTH_YTD']) && $item['LAST_MONTH_YTD'] != 0 ? ($item['VARIANCE_YTD'] / $item['LAST_MONTH_YTD']) * 100 : 0;
                                    $item['LAST_YEAR_YTD_PCTG'] = isset($item_divided_by['LAST_YEAR_YTD']) && isset($item['LAST_YEAR_YTD']) && $item_divided_by['LAST_YEAR_YTD'] != 0 ? ($item['LAST_YEAR_YTD'] / $item_divided_by['LAST_YEAR_YTD']) * 100 : 0;

                                    $data['VALUE_PNL'][$key]['DATA']['GROUPING'][$key][$val[$dtsm]->CATEGORY_CODE]['DATA'] = $item;
                                }
                            }
                        }
                    }

                    // Ini untuk ROOM Summary ALL
                    $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY'] = array(
                        'Occupied Average Rate'=>array(
                            'ACTUAL_CURRENT' => 0,
                            'LAST_MONTH_CURRENT'=>0,
                            'VARIANCE_CURRENT'=>0,
                            'VARIANCE_CURRENT_PCTG'=>0,
                            'LAST_YEAR_CURRENT'=>0,
                            'ACTUAL_YTD' => 0,
                            'LAST_MONTH_YTD'=>0,
                            'VARIANCE_YTD'=>0,
                            'VARIANCE_YTD_PCTG'=>0,
                            'LAST_YEAR_YTD'=>0
                        ),
                        'RevPAR'=>array(
                            'ACTUAL_CURRENT' => 0,
                            'LAST_MONTH_CURRENT'=>0,
                            'VARIANCE_CURRENT'=>0,
                            'VARIANCE_CURRENT_PCTG'=>0,
                            'LAST_YEAR_CURRENT'=>0,
                            'ACTUAL_YTD' => 0,
                            'LAST_MONTH_YTD'=>0,
                            'VARIANCE_YTD'=>0,
                            'VARIANCE_YTD_PCTG'=>0,
                            'LAST_YEAR_YTD'=>0
                        )
                    );
                    
                    try {
                        $data['ROOM_STATISTIC_SUMMARY_ALL']['DATA'] = DB::connection('dbayana-dw')
                        ->select("EXEC usp_RptPNL_Getdata ?,?,?,?", array($data['MONTH'], $data['YEAR'], $key_plant, ''));
                        $data['ROOM_STATISTIC_SUMMARY_ALL']['DATA'] = collect($data['ROOM_STATISTIC_SUMMARY_ALL']['DATA'])->reject(function($name){
                            $type_statistic = isset($name->KPI_CODE) ? $name->KPI_CODE : '-'; 
                            // Reject RDT (Room density) karena di summary all tidak perlu ini
                            return $type_statistic == 'RDT';
                        })->map(function($item, $key) use (&$data){
                            // Mencari Occupancy Average Rate berdasarkan Room revenue dan Room Sold
                            if(isset($item->KPI_CODE) && $item->KPI_CODE == 'RAS'){
                                $room_stat = [];
                                try {
                                    $plant = isset($item->CompanyCode) ? $item->CompanyCode : '';
                                    $room_stat_mapping = DB::connection('dbayana-stg')
                                    ->table('dbo.PnlRoomStatisticMapping')
                                    ->where('PLANT', $plant)
                                    ->select('GROUP_REPORT', 'CAT_REPORT_CODE')
                                    ->get()->first();
                                    if($room_stat_mapping)
                                        $room_stat = $room_stat_mapping;
                                } catch(\Exception $e){}

                                // MTD
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($item->ActualMTD) && $item->ActualMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT'] / $item->ActualMTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($item->LastMonthMTD) && $item->LastMonthMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $item->LastMonthMTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_CURRENT'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_CURRENT'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'];
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_CURRENT_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_CURRENT'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_CURRENT']) * 100 : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_YEAR_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($item->LastYearMTD) && $item->LastYearMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $item->LastYearMTD) : 0;

                                // YTD
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD']) && isset($item->ActualYTD) && $item->ActualYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD'] / $item->ActualYTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($item->LastMonthYTD) && $item->LastMonthYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD'] / $item->LastMonthYTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_YTD'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['ACTUAL_YTD'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'];
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_YTD_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['VARIANCE_YTD'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_MONTH_YTD']) * 100 : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['RevPAR']['LAST_YEAR_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($item->LastYearYTD) && $item->LastYearYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD'] / $item->LastYearYTD) : 0;
                            }

                            else if(isset($item->KPI_CODE) && $item->KPI_CODE == 'RSS'){
                                $room_stat = [];
                                try {
                                    $plant = isset($item->CompanyCode) ? $item->CompanyCode : '';
                                    $room_stat_mapping = DB::connection('dbayana-stg')
                                    ->table('dbo.PnlRoomStatisticMapping')
                                    ->where('PLANT', $plant)
                                    ->select('GROUP_REPORT', 'CAT_REPORT_CODE')
                                    ->get()->first();
                                    if($room_stat_mapping)
                                        $room_stat = $room_stat_mapping;
                                } catch(\Exception $e){}
                                
                                // MTD
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT']) && isset($item->ActualMTD) && $item->ActualMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_CURRENT'] / $item->ActualMTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT']) && isset($item->LastMonthMTD) && $item->LastMonthMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_CURRENT'] / $item->LastMonthMTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_CURRENT'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'];
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_CURRENT'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_CURRENT']) * 100 : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_YEAR_CURRENT'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT']) && isset($item->LastYearMTD) && $item->LastYearMTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_CURRENT'] / $item->LastYearMTD) : 0;

                                // YTD
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD']) && isset($item->ActualYTD) && $item->ActualYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['ACTUAL_YTD'] / $item->ActualYTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD']) && isset($item->LastMonthYTD) && $item->LastMonthYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_MONTH_YTD'] / $item->LastMonthYTD) : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['ACTUAL_YTD'] - $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'];
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD_PCTG'] = $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD'] != 0 ? ($data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['VARIANCE_YTD'] / $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_MONTH_YTD']) * 100 : 0;
                                $data['ROOM_STATISTIC_SUMMARY_ALL']['CATEGORY']['Occupied Average Rate']['LAST_YEAR_YTD'] = isset($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD']) && isset($item->LastYearYTD) && $item->LastYearYTD != 0 ? ($data[$room_stat->GROUP_REPORT][$room_stat->GROUP_REPORT][$room_stat->CAT_REPORT_CODE]['SUM_CATEGORY']['LAST_YEAR_YTD'] / $item->LastYearYTD) : 0;
                            }

                            return $item;
                        })->toArray();
                    } catch(\Exception $e){}

                    $headcount_payroll_summary = DB::connection('dbayana-stg')
                    ->table('dbo.MasterPnlSummary')
                    ->where('PLANT', $key_plant)
                    ->whereIn('GROUP_CODE', ['DPT', 'UEX'])
                    ->select('GROUP_REPORT')
                    ->get()->pluck('GROUP_REPORT')->toArray();

                    $data['SUMMARY-ALL']['TOTAL_HEADCOUNT'] = $this->process_headcount_summary($key_plant, $data['MONTH'], $data['YEAR']);
                    $data['SUMMARY-ALL']['TOTAL_PAYROLL'] = $this->process_payroll($data['VALUE_PNL'], $headcount_payroll_summary);
                    $data['SUMMARY-ALL']['TOTAL_COST_AGAINTS_REVENUE'] = $this->process_cost_per_revenue($data['SUMMARY-ALL']);

                    // buat array key sesuai dengan nama template summary
                    $data['VALUE_PNL']['summary_all_new'] = array('DATA'=>
                        [
                            'SUMMARY-ALL'=>$data['SUMMARY-ALL'],
                            'ROOM_STATISTIC_SUMMARY_ALL'=>$data['ROOM_STATISTIC_SUMMARY_ALL']
                        ],
                        'DESC'=>'Summary P&L'
                    );

                }
                $data_cost['DATA'] = $data['VALUE_PNL'];
                if(in_array($request->post('month'), array_keys($this->pnl_period_exclude_month))){
                    $data_cost['MONTH'] = $this->pnl_period_exclude_month[$request->post('month')];
                } else {
                    $data_cost['MONTH'] = date('M', strtotime( $data['YEAR'].'-'.$data['MONTH'].'-01' ));
                }
                $data_cost['YEAR'] = $data['YEAR'];
                $data_cost['COMPANY']=array_values($data['COMPANY_LIST'])[0];
            }
            if(count($data_cost)){
                // Start Download Data
                $download = Excel::download(new PNLExport($data_cost), sprintf('%s - PNL Report.xlsx', isset(array_values($data['COMPANY_LIST'])[0]) ? array_values($data['COMPANY_LIST'])[0] : 'Unknown Company' ), null, [\Maatwebsite\Excel\Excel::XLSX]);
                if($download->isSuccessful()){
                    return $download;
                }
                else 
                    throw new \Exception("Something went wrong while exporting data");
            }
            else{
                return response()->json(['status'=>'not_found', 'message'=>'No data found for company '.$request->get('company')], 400);
            }
        } catch(\Exception $e){
            return response()->json(['status'=>'error', 'message'=>"There's an exception | ". $e->getMessage()], 401);
        }
    }

    public function pnl_cost(Request $request){
        date_default_timezone_set('Asia/Makassar');
        // $date_default = date('Y-m-01');
        // $date_default = date('Y-m-d', strtotime("-1 months", $date_default));
        $date_default = date("Y-m-d", mktime(0,0,0,date('n'),1,date('Y')));
        $data['MONTH_NAME'] = date('M', strtotime($date_default));
        $data['MONTH'] = date('n', strtotime($date_default));
        $data['YEAR'] = date('Y', strtotime($date_default));
        // Default tampil KMS1
        
        $data['COMPANY'] = null;
        $data['HOTEL_LIST'] = DB::connection('dbintranet')
        ->table('dbo.INT_BUSINESS_PLANT')
        ->where('PLANT_TYPE', 'HOTEL')
        ->orWhere('IS_ADDITIONAL_HOTEL', 'Y')
        ->orderBy('SAP_PLANT_ID');
        // Company List untuk report

        // Filter untuk sync data ke SAP (Jika superuser tampilkan semua company hotel, jika tidak maka tampilkan penempatannya saja)
        $cek_permission_view_all_pnl = 'view_'. (String)route('sap.report.pnl',[],false);
        if(isset($request->session()->get('user_data')->IS_SUPERUSER) && $request->session()->get('user_data')->IS_SUPERUSER || session()->get('permission_menu')->has($cek_permission_view_all_pnl)){
            // Company untuk Sync
            $data['COMPANY_SAP'] = $data['HOTEL_LIST']->get()->pluck('COMPANY_CODE', 'COMPANY_CODE')
            ->toArray();
            // Company untuk mengganti report
            $data['COMPANY_LIST'] = $data['HOTEL_LIST']->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')
            ->toArray();
            if($data['COMPANY_LIST'] && count($data['COMPANY_LIST'])){
                $data['COMPANY'] = isset(array_keys($data['COMPANY_LIST'])[0]) ? array_keys($data['COMPANY_LIST'])[0] : null;
            }
        }
        else {
            $user_id = isset(session()->get('user_data')->EMPLOYEE_ID) ? session()->get('user_data')->EMPLOYEE_ID : '';
            $cek_plant_user = DB::connection('dbintranet')
            ->table('dbo.VIEW_EMPLOYEE_ACCESS')
            ->where('EMPLOYEE_ID', $user_id)
            ->select('SAP_PLANT_ID', 'COMPANY_CODE')
            ->get()->pluck('SAP_PLANT_ID', 'SAP_PLANT_ID')->filter()->toArray();
            // $plant_user = isset($request->session()->get('assignment')->toArray()[0]->SAP_PLANT_ID) ? $request->session()->get('assignment')->toArray()[0]->SAP_PLANT_ID : '';
            
            // Company untuk Sync
            $data['COMPANY_SAP'] = DB::connection('dbintranet')
            ->table('dbo.INT_BUSINESS_PLANT')
            ->whereIn('SAP_PLANT_ID', $cek_plant_user)->get()->pluck('COMPANY_CODE', 'COMPANY_CODE')
            ->toArray();
            // Company untuk mengganti report
            $data['COMPANY_LIST'] = DB::connection('dbintranet')
            ->table('dbo.INT_BUSINESS_PLANT')
            ->whereIn('SAP_PLANT_ID', $cek_plant_user)->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')
            ->toArray();
            if($data['COMPANY_LIST'] && count($data['COMPANY_LIST'])){
                $data['COMPANY'] = isset(array_keys($data['COMPANY_LIST'])[0]) ? array_keys($data['COMPANY_LIST'])[0] : null;
            }
        }

        if($request->post('month')){
            try {
                $data['MONTH_NAME'] = date('M', strtotime('2021-'.$request->post('month').'-01' ));
                $data['MONTH'] = date('n', strtotime('2021-'.$request->post('month').'-01' ));
            } catch(\Exception $e){}
        }
        if($request->post('year')){
            try {
                $data['YEAR'] = date('Y', strtotime($request->post('year').'-'.$data['MONTH'].'-01' ));
            } catch(\Exception $e){}
        }
        if($request->post('company')){
            try {
                $data['COMPANY'] = $request->post('company', 'ALL');
            } catch(\Exception $e){}
        }
        
        $data['LAST_UPDATE'] = DB::connection('dbayana-stg')
        ->table('dbo.SAP_PNL')
        ->where('PRCTR', $data['COMPANY'])
        ->select('LAST_UPDATE')
        ->orderBy('LAST_UPDATE', 'DESC')
        ->get()->pluck('LAST_UPDATE')->first();

        $check_report = DB::connection('dbayana-stg')
        ->table('dbo.MasterGrpPnlReport')
        ->where('COST_ONLY_YN', 'Y')
        ->where('PLANT', $data['COMPANY'])
        ->select('GROUP_REPORT', 'GROUP_DESC', 'PROCESSING_TYPE_FUNC', 'REPORT_SORT')
        ->get()->sortBy('REPORT_SORT')->values()->all();

        $data['VALUE_PNL'] = [];
        if(count($check_report)){
            foreach ($check_report as $key => $value) {
                if(isset($value->PROCESSING_TYPE_FUNC) && $value->PROCESSING_TYPE_FUNC && $value->PROCESSING_TYPE_FUNC != 'NOR'){
                    $data[$value->GROUP_REPORT] = DB::connection('dbayana-stg')
                    ->select("EXEC dbo.sap_pnl_report ?,?,?,?", array($value->GROUP_REPORT, $data['COMPANY'], $data['YEAR'], $data['MONTH']));

                    switch ($value->PROCESSING_TYPE_FUNC) {
                      case 'DEX':
                        $data[$value->GROUP_REPORT] = $this->departmental_expense_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      case 'RMR':
                        $data[$value->GROUP_REPORT] = $this->room_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR'], $data['COMPANY']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      case 'FBV' :
                        $data[$value->GROUP_REPORT] = $this->fnb_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      case 'FNB' :
                        $data[$value->GROUP_REPORT] = $this->fnb_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);

                        break;
                      case 'OER' :
                        $data[$value->GROUP_REPORT] = $this->other_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                        $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                        break;
                      default:
                        break;
                    }

                    $data['VALUE_PNL'][$value->GROUP_REPORT] = array('DATA'=>$data[$value->GROUP_REPORT], 'DESC'=>$value->GROUP_DESC);
                }
            }
        }

        // Payroll Trend
        $months = array();
        for ($i = 0; $i < 12; $i++) {
            $timestamp = mktime(0, 0, 0, date('n') - $i, 1);
            $months[date('n', $timestamp)] = array('month_name'=>date('M', $timestamp), 'period'=>sprintf('%02d', date('n', $timestamp)).'/'.date('Y'));
        }
        ksort($months);
        $data['months'] = $months;
        $data['COMPANY_NAME'] = $data['COMPANY'];

        return view('pages.report.finance.pnl_summary_cost', ['data'=>$data]);
    }

    public function headcount_input(Request $request){
        if($request->method() == 'GET')
            return view('pages.report.finance.headcount.headcount-input');
        else if($request->method() == 'POST'){
            $file = $request->file('headcount-file');
            if ($file) {
                try {
                    $filename = preg_replace('/\s+/', '_', $file->getClientOriginalName())."_".rand(10,20).time();
                    $extension = $file->getClientOriginalExtension(); //Get extension of uploaded file
                    $tempPath = $file->getRealPath();
                    $fileSize = $file->getSize(); //Get size of uploaded file in bytes
                    //Check for file extension and size
                    $this->checkUploadedFileProperties($extension, $fileSize);
                    //Where uploaded file will be stored on the server 
                    $location = 'upload/pnl/headcount'; //Created an "uploads" folder for that
                    // Upload file
                    $file->move($location, $filename);
                    // In case the uploaded file path is to be stored in the database 
                    $filepath = public_path($location . "/" . $filename);
                    Excel::import(new HeadcountImport, $filepath);

                    $status = array('msg'=>"Headcount file has been successfully uploaded and inserted", 'type'=>'success');
                }
                catch(\Exception $e){
                    // throw new \Exception(sprintf('Something went wrong, %s', $e->getMessage()), Response::HTTP_BAD_REQUEST);
                    $status = array('msg'=>sprintf('Something went wrong, %s', $e->getMessage()), 'type'=>'danger');
                }
            } else {
                //no file was uploaded
                // throw new \Exception('No file was uploaded', Response::HTTP_BAD_REQUEST);
                $status = array('msg'=>"No file was uploaded", 'type'=>'info');
            }
            return redirect()->route('sap.report.pnl.headcount_input')->with('message', $status);
        }
    }

    public function checkUploadedFileProperties($extension, $fileSize)
    {
        $valid_extension = array("csv", "xlsx"); //Only want csv and excel files
        $maxFileSize = 5097152; // Uploaded file size limit is 5mb
        if (in_array(strtolower($extension), $valid_extension)) {
            if ($fileSize <= $maxFileSize) {
            } else {
            throw new \Exception('No file was uploaded', Response::HTTP_REQUEST_ENTITY_TOO_LARGE); //413 error
            }
        } else {
            throw new \Exception('Invalid file extension', Response::HTTP_UNSUPPORTED_MEDIA_TYPE); //415 error
        }
    }

    public function pnl_cost_export(Request $request) 
    {
        try {
            date_default_timezone_set('Asia/Makassar');
            $date_default = date("Y-m-d", mktime(0,0,0,date('n'),1,date('Y')));
            $data['MONTH'] = date('n', strtotime($date_default));
            $data['YEAR'] = date('Y', strtotime($date_default));
            // Default tampil KMS1
            
            // $data['COMPANY'] = null;
            $data['HOTEL_LIST'] = DB::connection('dbintranet')
            ->table('dbo.INT_BUSINESS_PLANT')
            ->where('PLANT_TYPE', 'HOTEL')
            ->orWhere('IS_ADDITIONAL_HOTEL', 'Y')
            ->orderBy('SAP_PLANT_ID')
            ->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')->toArray();
            // Company List untuk report

            // Company untuk mengganti report
            $data['COMPANY_LIST'] = [];        
            if($request->get('month')){
                try {
                    $data['MONTH'] = date('n', strtotime('2021-'.$request->get('month').'-01' ));
                } catch(\Exception $e){}
            }
            if($request->get('year')){
                try {
                    $data['YEAR'] = date('Y', strtotime($request->get('year').'-'.$data['MONTH'].'-01' ));
                } catch(\Exception $e){}
            }
            if($request->get('company')){
                try {
                    if(!in_array($request->get('company'), array_keys($data['HOTEL_LIST']))) {
                        return response()->json(['status'=>'failed', 'message'=>'Company is not available for daily cost report, please check your data'], 400);
                    }
                    $data['COMPANY_LIST'] = array(strtoupper($request->get('company'))=>isset($data['HOTEL_LIST'][$request->get('company')]) ? $data['HOTEL_LIST'][$request->get('company')] : '');
                } catch(\Exception $e){
                    $data['COMPANY_LIST'] = [];
                }
            } else {
                return response()->json(['status'=>'warning', 'message'=>'Please provide a company to lookup'], 200);
            }

            $data_cost = [];
            foreach($data['COMPANY_LIST'] as $key_plant => $value_plant){
                $check_report = DB::connection('dbayana-stg')
                ->table('dbo.MasterGrpPnlReport')
                ->where('COST_ONLY_YN', 'Y')
                ->where('PLANT', $key_plant)
                ->select('GROUP_REPORT', 'GROUP_DESC', 'PROCESSING_TYPE_FUNC', 'REPORT_SORT')
                ->get()->sortBy('REPORT_SORT')->values()->all();

                $data['VALUE_PNL'] = [];
                if(count($check_report)){
                    foreach ($check_report as $key => $value) {
                        if(isset($value->PROCESSING_TYPE_FUNC) && $value->PROCESSING_TYPE_FUNC && $value->PROCESSING_TYPE_FUNC != 'NOR'){
                            $data[$value->GROUP_REPORT] = DB::connection('dbayana-stg')
                            ->select("EXEC dbo.sap_pnl_report ?,?,?,?", array($value->GROUP_REPORT, $key_plant, $data['YEAR'], $data['MONTH']));

                            switch ($value->PROCESSING_TYPE_FUNC) {
                              case 'DEX':
                                $data[$value->GROUP_REPORT] = $this->departmental_expense_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'RMR':
                                $data[$value->GROUP_REPORT] = $this->room_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR'], $data['COMPANY']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'FBV' :
                                $data[$value->GROUP_REPORT] = $this->fnb_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'FNB' :
                                $data[$value->GROUP_REPORT] = $this->fnb_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'OER' :
                                $data[$value->GROUP_REPORT] = $this->other_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              default:
                                break;
                            }

                            $data['VALUE_PNL'][$value->GROUP_REPORT] = array('DATA'=>$data[$value->GROUP_REPORT], 'DESC'=>$value->GROUP_DESC);
                        }
                    }
                }
                $data_cost['DATA'] = $data['VALUE_PNL'];
                $data_cost['MONTH'] = date('M', strtotime( $data['YEAR'].'-'.$data['MONTH'].'-01' ));
                $data_cost['YEAR'] = $data['YEAR'];
            }
            if(count($data_cost)){
                // Start Download Data
                $download = Excel::download(new DailyFlashCost($data_cost), sprintf('%s - Daily Cost Report.xlsx', isset(array_values($data['COMPANY_LIST'])[0]) ? array_values($data['COMPANY_LIST'])[0] : 'Unknown Company' ));
                if($download->isSuccessful())
                    return $download;
                else 
                    throw new \Exception("Something went wrong while exporting data");
            }
            else{
                return response()->json(['status'=>'not_found', 'message'=>'No data found for company '.$request->get('company')], 400);
            }
        } catch(\Exception $e){
            return response()->json(['status'=>'error', 'message'=>"There's an exception | ". $e->getMessage()], 401);
        }
    }

    public function pnl_cost_send(Request $request) 
    {
        try {
            date_default_timezone_set('Asia/Makassar');
            $date_default = date("Y-m-d", mktime(0,0,0,date('n'),1,date('Y')) );
            $data['MONTH'] = date('n', strtotime($date_default));
            $data['YEAR'] = date('Y', strtotime($date_default));
            // Default tampil KMS1
            
            // $data['COMPANY'] = null;
            $data['HOTEL_LIST'] = DB::connection('dbintranet')
            ->table('dbo.INT_BUSINESS_PLANT')
            ->where('PLANT_TYPE', 'HOTEL')
            ->orWhere('IS_ADDITIONAL_HOTEL', 'Y')
            ->orderBy('SAP_PLANT_ID')
            ->get()->pluck('SAP_PLANT_NAME','SAP_PLANT_ID')->toArray();
            // Company List untuk report

            // Company untuk mengganti report
            $data['COMPANY_LIST'] = [];        
            if($request->get('month')){
                try {
                    $data['MONTH'] = date('n', strtotime('2021-'.$request->get('month').'-01' ));
                } catch(\Exception $e){}
            }
            if($request->get('year')){
                try {
                    $data['YEAR'] = date('Y', strtotime($request->get('year').'-'.$data['MONTH'].'-01' ));
                } catch(\Exception $e){}
            }
            if($request->get('company')){
                try {
                    if(!in_array($request->get('company'), array_keys($data['HOTEL_LIST']))) {
                        return response()->json(['status'=>'failed', 'message'=>'Company is not available for daily cost report, please check your data'], 400);
                    }
                    $data['COMPANY_LIST'] = array(strtoupper($request->get('company'))=>isset($data['HOTEL_LIST'][$request->get('company')]) ? $data['HOTEL_LIST'][$request->get('company')] : '');
                } catch(\Exception $e){
                    $data['COMPANY_LIST'] = [];
                }
            } else {
                return response()->json(['status'=>'warning', 'message'=>'Please provide a company to lookup'], 200);
            }

            $data_cost = [];
            // dd(array_values($data['COMPANY_LIST']));
            foreach($data['COMPANY_LIST'] as $key_plant => $value_plant){
                $check_report = DB::connection('dbayana-stg')
                ->table('dbo.MasterGrpPnlReport')
                ->where('COST_ONLY_YN', 'Y')
                ->where('PLANT', $key_plant)
                ->select('GROUP_REPORT', 'GROUP_DESC', 'PROCESSING_TYPE_FUNC', 'REPORT_SORT')
                ->get()->sortBy('REPORT_SORT')->values()->all();

                $data['VALUE_PNL'] = [];
                if(count($check_report)){
                    foreach ($check_report as $key => $value) {
                        if(isset($value->PROCESSING_TYPE_FUNC) && $value->PROCESSING_TYPE_FUNC && $value->PROCESSING_TYPE_FUNC != 'NOR'){
                            $data[$value->GROUP_REPORT] = DB::connection('dbayana-stg')
                            ->select("EXEC dbo.sap_pnl_report ?,?,?,?", array($value->GROUP_REPORT, $key_plant, $data['YEAR'], $data['MONTH']));

                            switch ($value->PROCESSING_TYPE_FUNC) {
                              case 'DEX':
                                $data[$value->GROUP_REPORT] = $this->departmental_expense_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'RMR':
                                $data[$value->GROUP_REPORT] = $this->room_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR'], $data['COMPANY']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'FBV' :
                                $data[$value->GROUP_REPORT] = $this->fnb_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'FNB' :
                                $data[$value->GROUP_REPORT] = $this->fnb_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              case 'OER' :
                                $data[$value->GROUP_REPORT] = $this->other_rev_grouping_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                $data[$value->GROUP_REPORT] = $this->grouping_GL_FNB_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT);
                                $data[$value->GROUP_REPORT] = $this->headcount_process($data[$value->GROUP_REPORT], $value->GROUP_REPORT, $data['MONTH'], $data['YEAR']);
                                break;
                              default:
                                break;
                            }

                            $data['VALUE_PNL'][$value->GROUP_REPORT] = array('DATA'=>$data[$value->GROUP_REPORT], 'DESC'=>$value->GROUP_DESC);
                        }
                    }
                }
                $data_cost['DATA'] = $data['VALUE_PNL'];
                $data_cost['MONTH'] = date('M', strtotime( $data['YEAR'].'-'.$data['MONTH'].'-01' ));
                $data_cost['YEAR'] = $data['YEAR'];
                $data_cost['COMPANY'] = array_values($data['COMPANY_LIST'])[0];
            }
            if(count($data_cost)){
                // dd($data_cost);
                /** 
                 * Start Send Email
                 */
                $attachment = Excel::raw(new DailyFlashCost($data_cost), \Maatwebsite\Excel\Excel::XLSX);
                $filename = sprintf('%s - Daily Cost Report.xlsx', isset(array_values($data['COMPANY_LIST'])[0]) ? array_values($data['COMPANY_LIST'])[0] : 'Unknown Company');
                Mail::send([], [], function ($message) use ($attachment, $filename, $data, $request) {
                    // Check send to email
                    $company = isset(array_values($data['COMPANY_LIST'])[0]) ? ucwords(strtolower(array_values($data['COMPANY_LIST'])[0])) : strtoupper($request->get('company', ''));
                    $sendto = DB::connection('dbintranet')
                    ->table('dbo.INT_MAP_EMAIL_DAILY_COST')
                    ->where('GROUP_TYPE', $request->get('company'))
                    ->get()->pluck('EMAIL', 'EMAIL')->filter()->toArray();

                    // Subject and body format
                    $subject = (String)strtoupper($request->get('company', ''))." - ".$company." - Flash Cost Report - ".date('d M Y', strtotime( '-1 day', strtotime(date('Y-m-d')) ));
                    $body = (String)strtoupper($request->get('company', ''))." - ".$company." - Flash Cost Report <br>".date('d M Y', strtotime( '-1 day', strtotime(date('Y-m-d')) ));

                    // Ready to send and rock
                    $message->subject($subject);
                    $message->setBody("<span style='font-size:20px'>$body</span>", 'text/html');
                    $message->from('ayanareport@ayana.com', config('intranet.MAIL_FROM'));
                    $message->attachData($attachment, $filename);
                    $message->to($sendto);
                    //   $message->to([]);
                    $message->bcc([
                        'mahendra_permana@biznetnetworks.com',
                        'andy.susanto@midplaza.com',
                        'yudhi.arimbawan@midplaza.com',
                        'roy_putra@biznetnetworks.com'
                    ]);
                });
                return response()->json(['status'=>'success', 'message'=>'Report successfully sent'], 200);
                /** 
                 * End Send Email
                 */
            }
            else{
                return response()->json(['status'=>'not_found', 'message'=>'No data found for company '.$request->get('company')], 400);
            }
        } catch(\Exception $e){
            return response()->json(['status'=>'error', 'message'=>"There's an exception | ". $e->getMessage()], 401);
        }
    }

}